
123 


Les objets 

GÉNÉRALITÉS 
• 
Un objet : 
– 
Représente/porte une valeur (adresse IP, URL, événement 
temporel,…) 
– 
Possède un nom et une description 
• 
Les objets sont utilisés pour configurer les paramètres 
des fonctionnalités : 
– 
Manipulerdes noms d’objets, plus parlant que des valeurs 
– 
Simplifier la modification des valeurs 
• 
3 familles 
d’objets 
: 
– 
Réseaux 
– 
URL (ou Objets Webjusqu’à la version 4.3.10) 
– 
Certificats et PKI 
3 

Les menus de configuration des firewalls Stormshield Network utilisent la notion 
d’objets 
qui représentent des valeurs (adresse IP, adresse réseau, URL, événement 
temporel, etc.). L’utilisation 
d’objets 
au lieu de valeurs présente deux avantages 
majeurs : 

1. Cela permet à l’ad􀅵inistrateur 
de manipuler des noms, plus parlants que 
des valeurs. 
2. Dans le cas où une valeur change, il suffira de modifier la valeur de l’objet 
sans se rendre dans tous les menus où l’objet 
est utilisé. 
Les objets sont classés en 3 familles : 

1. Objets Réseaux : Regroupe tous les objets en relation avec les valeurs 
réseaux (adresse IP, numéro de port, numéro de protocole, etc.) et les 
objets temps. 
2. URL (ou Objets Web jus􀆋u’à 
la version 4.3.10) : Groupes d’URL 
(ou 
groupes de catégories) et groupes de noms de certificats. 
3. Certificats et PKI : Permet la création et la gestion des autorités de 
certification et de toutes les identités (de type serveur, utilisateur, ou 
smartcard) qui en découlent. 
Dans ce module, nous nous intéresserons principalement aux objets réseaux. Les 
objets Web seront abordés dans le module « protection applicative ». La partie 
Certificats et PKI est, quant à elle, abordée dans la formation CSNE. 

124 



Les objets 

4 
GÉNÉRALITÉS 
Préfixes interdits Caractères interdis 
dans le nom 
Noms d'objets 
interdits 
Caractères interdits 
dans la description 
firewall_ <tabulation> Any <tabulation> 
Network_ <espace> None # 
Ephemeral_ ! Anonymous @ 
Global_ " Broadcast " 
Vlan_ # Internet 
Bridge_ , 
= 
@ 
[ 
] 
\ 
La syntaxe des noms des objets créés par l’ad􀅵inistrateur 
doit respecter quelques 
restrictions définies dans le tableau ci-dessus. De plus, elle est insensible à la case. 

La création et la configuration des objets s'effectuent : 

• 
Dans le menu : CONFIGURATION ⇒OBJETS 
• 
Dans le menu : OBJETS 
• 
Depuis n'importe quel autre menu via le bouton encadré en rouge dans la 
diapositive ci-dessus (création contextuelle). 
NOTE : Il est possible de créer plusieurs objets portant la même valeur. Cependant, 
nous vous déconseillons de le faire afin de simplifier la lecture des menus de 
configuration (principalement les règles de filtrage/NAT) et des bases d’objets. Et 
également, afin de faciliter leur maintenance. 


125 


Les objets 

•Généralités 
•Les objets réseaux 
•Lab –Les objets 
Les objets 
➔
126 


Les objets 

6 
LES OBJETS RÉSEAUX 
La base d’objets 
réseaux est accessible depuis le menu CONFIGURATION ⇒OBJETS 

⇒Objets réseaux. Elle comprend les catégories d’objets 
suivants : 
• 
Machine : Une adresse IP 
• 
Nom DNS (FQDN) : Toutes les adresses IP associées à un nom FQDN par 
résolution DNS 
• 
Réseau : Une adresse réseau 
• 
Plage d’adresses 
IP : Une plage d’adresses 
• 
Port – 
Plage de ports : Un port ou une plage de port. Il/Elle peut être limité(e) à 
un protocole de transport particulier (TCP ou UDP), 
• 
Protocole IP : l’ID 
du protocole au niveau IP, 
• 
Groupe : Un groupe d’objets 
portant une ou plusieurs adresses IP : machines, 
plages d’adresses 
IP, réseaux ou d’autres 
groupes, 
• 
Groupe de ports : Un groupe d’objets 
portant des ports ou des plages de ports, 
ainsi que d’autres 
groupes de ports, 
• 
Groupe de régions : Un groupe de pays ou de continents. Ce type d’objet 
peut 
être utilisé dans la géolocalisation des adresses IP, 
• 
Routeur : Permet de renseigner une ou plusieurs passerelles pour un routage par 
répartition de charge avec ou sans passerelle de secours. Cet objet sera détaillé 
dans la partie Routage du module Configuration Réseau, 
• 
Temps : Un événement temporel (ponctuel, jour de l’année, 
jour(s) de la semaine 
ou plage(s) horaire(s)). 
127 


Les objets 

7 
LES OBJETS RÉSEAUX 
Le menu CONFIGURATION ⇒ 
OBJETS ⇒ 
Objets réseaux offre plusieurs 
fonctionnalités pour gérer les objets réseaux : 

• 
Barre de recherche : Effectuer une recherche sur le nom, le commentaire ou la 
valeur de l’objet. 
• 
Filtre : Filtrer l’affichage 
des objets en fonction de leur catégorie (machine, 
réseau, port, etc.). 
• 
Type : Filtrer l’affichage 
des objets en fonction du type d’adresse 
utilisé (double 
pile, IPv4, IPv6, adresse MAC). 
• 
Ajouter : Créer un nouvel objet. 
• 
Supprimer : Supprimer un objet sélectionné. Si celui-ci est utilisé dans une 
configuration, une fenêtre s’affichera 
pour vous permettre de vérifier le module 
dans lequel l’objet 
est utilisé, forcer la suppression ou annuler la suppression. 
• 
Vérifier l’utilisation 
: Affiche dans le bandeau de gauche le ou les menus dans 
lesquels l’objet 
sélectionné est utilisé. 
• 
Exporter : Exporter la base d’objets 
réseaux dans un fichier CSV. 
• 
Importer : Importer des objets à partir d’un 
fichier CSV. 
Le reste du menu est composé de deux parties : 

• 
Liste des objets : Affiche tous les objets réseaux organisés selon les filtres 
d’affichage 
utilisés. Chaque objet est affiché sur une ligne avec les informations 
suivantes : 
• 
La catégorie de l’objet 
représenté par une icône, 
• 
L’utilisation 
: vert signifie que l’objet 
est utilisé et gris le contraire, 
• 
Le nom de l’objet, 
• 
La valeur portée par l’objet. 
• 
Propriétés : Affiche les attributs de l’objet 
sélectionné. Leur modification 
s’effectue 
depuis cet encadré. 
128 


Les objets 

8 
•Objets implicites : Créés automatiquement par le firewall 
sur actionde l’administrateur (lecture seule)
•Objets préconfigurés : valeurs standardiséeset plus… 
LES OBJETS RÉSEAUX 
On peut distinguer deux catégories d’objets 
particuliers en plus des objets qui 
peuvent être créés par l’ad􀅵inistrateur 
: 

• 
Objets implicites : Ils sont créés automatiquement par le firewall et dépendent 
de la configuration réseau. Ces objets sont en lecture seule et ne peuvent être ni 
modifiés ni supprimés par l’ad􀅵inistrateur. Par exemple, l’objet 
« Firewall_out », 
créé automatiquement lors􀆋u’une 
adresse IP est associée à l’interface 
« OUT » 
ou l’objet 
« Network_internals » qui regroupe tous les réseaux accessibles via les 
interfaces internes. 
• 
Objets préconfigurés : Ils sont présents par défaut dans la liste des objets. Ils 
représentent des valeurs de paramètres réseaux standardisées (ports, 
protocoles, réseaux) et des valeurs nécessaires pour le fonctionnement du 
firewall (adresse IP des serveurs Stormshield pour les mises à jour). Les figures ci-
dessus représentent le protocole ICMP et l’objet 
« Internet ». Ce dernier 
regroupe l’ense􀅵ble 
des machines ne faisant pas partie des réseaux internes. 
NOTE : Nous vous conseillons d’utiliser 
les objets implicites et préconfigurés et 
d’éviter 
de créer d’autres 
objets portant les mêmes valeurs. 


129 


Les objets 

9 
LES OBJETS RÉSEAUX 
•Créationd’unobjet•Choix de la catégorie d’objet•Nom de l’objet•Valeur correspondante 
La fenêtre de création d’objets 
est composée de plusieurs onglets, un pour chaque 
catégorie. 

Dans la majorité des cas, la création d’un 
objet consiste à définir deux champs 
obligatoires, à savoir le nom et la valeur, le champ commentaire est facultatif. 

Il est possible de « créer » ou de « créer et dupliquer » l’objet. Ce dernier bouton 
crée l’objet 
et maintient la fenêtre de création ouverte pour faciliter la création d’un 
nouvel objet de même catégorie. 


130 


Les objets 

10 
LES OBJETS RÉSEAUX 
Les captures ci-dessus illustrent la création des objets FQDN, machine et plage 
d’adresses 
IP. 

Les objets de type hôte dynamique et FQDN sont résolus toutes les cinq minutes par 
le firewall. 
Pour l’objet 
hôte, le firewall conserve la dernière adresse IP résolue. 
Pour l’objet 
FQDN, le firewall conserve un ensemble des IP résolues dans la base 
objets. Ce comportement est adapté pour des noms de domaine utilisant de la 
répartition de charge via DNS. 

NOTE : Lors de la création d’un 
objet FQDN ou hôte dynamique, cliquez sur la loupe 
pour résoudre le nom de l’objet 
et récupérer une adresse par défaut. Si vous n’avez 
pas encore accès à un serveur DNS susceptible d’effectuer 
cette résolution, entrez 
une adresse IP quelconque, elle sera modifiée dès la résolution effective. 


131 


Les objets 

11 
LES OBJETS RÉSEAUX 
Les captures ci-dessus illustrent la création des objets port et temps. 

NOTE : Un objet temps nommé « workhours » modifiable existe dans la 
configuration usine. 


132 


Les objets 

12 
•Création de groupes de machines ou groupes de ports 
–Nom de l’objet–Objets inclus dans le groupe 
LES OBJETS RÉSEAUX 
Pour ajouter un objet (ou plusieurs objets) au groupe, il suffit de sélectionner l’objet 
et de le basculer de la liste de gauche vers la liste de droite en cliquant sur le 
bouton →. La suppression de l’objet 
du groupe se fait par l’opération 
inverse avec le 
bouton ← 
. 
Vous pouvez utiliser le champ de recherche sur une partie du nom ou de la valeur 
des objets souhaités. 


133 


Les objets 

13 
•Créationd’ungroupede régionsLES OBJETS RÉSEAUX 
134 


Les objets 

14 
•Exporter la based’objetsdansunfichier CSVLES OBJETS RÉSEAUX 
Il est possible d’exporter 
la base d’objets 
dans un fichier CSV en cliquant sur le 
bouton « Exporter ». Le fichier sera proposé en téléchargement pour être stocké en 
local sur la machine. Le fichier CSV contient les objets machines, plages d’adresses 
IP, 
réseaux, FQDN, ports – 
plages de ports, protocoles, groupes et groupes de ports. 

Les objets sont organisés par catégorie et séparés par des lignes contenant les noms 
des paramètres : #type, #name, #IP, etc… 
(les paramètres diffèrent en fonction des 
catégories d’objets). Les attributs d’un 
objet, quand à eux, sont séparés par des 
virgules. 


135 


Les objets 

15 
•Importer desobjetsà partir d’unfichier CSVLES OBJETS RÉSEAUX 
Il est possible d’i􀅵porter 
des objets depuis un fichier CSV possédant le même format 
que le fichier exporté. 

Pour cela, il faut cliquer sur le bouton Importer, une fenêtre s’affiche 
pour 
renseigner le fichier CSV contenant les objets. Cliquer sur Transférer pour 
commencer l’i􀅵port. Une barre d’avance􀅵ent 
permet de visualiser le déroulement 
de l’i􀅵port. Et une fois fini, un rapport statistique affiche le nombre d’objets 
importés par type. 
En cas d’erreur 
d’i􀅵port, 
la base d’objets 
n’est 
pas modifiée. 

NOTE : Les objets du fichier écrasent ceux du firewall s’ils 
portent le même nom. Les 
autres objets ne sont pas affectés. 


136 


Les objets 

RECOMMANDATIONS 
• 
Utiliser un 
groupe 
d’objet d’administration 
• 
Limiter l’usage 
des 
objets 
dynamiques 
• 
Suivre une convention de nommage des objets 
• 
Limiter le nombre d’objets 
inutilisés 
• 
Eviter les doublons 
16 

Un groupe d’objet 
contenant l’ense􀅵ble 
des IP et des réseaux d’ad􀅵inistration 
permet de réutiliser ce groupe dans toutes les règles de filtrage liées à 
l’ad􀅵inistration 
et donc de maintenir leur cohérence tout en facilitant leur 
modification. 

Les objets dynamiques (type FQDN et Dynamic Host) génèrent des requêtes DNS 
régulières, ce qui sollicite le réseau et le firewall: n’utilisez 
cette fonctionnalité que 
lors􀆋u’elle 
est nécessaire. 

Une convention de nommage bien définie et appliquée strictement évite la création 
de doublon et facilite la lecture des objets. 

Les objets inutilisés chargent l’affichage 
et sont bien souvent oubliés et recréés. Afin 
d’éviter 
toute source potentielle de doublon, il est recommandé de ne pas conserver 
d’objets 
spécifiques inutilisés dans la configuration. 

Les doublons doivent être traqués et supprimés, c’est 
une source d’erreur 
courante 
lors de la modification de règles de filtrage. On se retrouve dans un cas où la 
modification d’un 
objet n’i􀅵pacte 
pas toutes les règles qui auraient dû l’􀄡tre, 
créant 
ainsi des trous dans la sécurité. 


137 


Les objets 
Lab 

•Généralités 
•Les objets réseaux 
•Lab –Les objets 
Les objets 
➔
138 


Les objets 
Lab 

Lab 2 – 
Les objets 

Note : Dans ce qui suit, le « x » doit􀀁􀄡tre re􀅵pla􀄐􀄠 suiva􀅶t􀀁la lettre de l’e􀅶treprise 
A⇒1, B⇒2. 

1. Cr􀄠ez􀀁les o􀄏jets 􀅵a􀄐hi􀅶es et􀀁r􀄠seaux􀀁pour l’autre Co􀅵pag􀅶ie􀀁: 
– 
Firewalls distants (adresse des interfaces externes) 
• 
Exemple : Fw_B en 192.36.253.20 
– 
Réseaux distants (adresse des réseaux internes) 
• 
Exemple : Lan_in_B en 192.168.2.0 / 255.255.255.0 
2. Ajoutez un nouveau service basé sur TCP fonctionnant sur le port 808, appelé 
webmail. 
3. Créez un objet « pc_admin » ave􀄐 l’adresse 􀏭􀏵􀏮.􀏭6􀏴.x.􀏮􀀁
4. Créez un objet « srv_dns_priv » dont l'adresse IP est 172.16.x.10 
5. Créez un objet « srv_web_priv » dont l'adresse IP est 172.16.x.11 
6. Créez un objet « srv_ftp_priv » dont l'adresse IP est 172.16.x.12 
7. Créez un objet « srv_mail_priv » dont l'adresse IP est 172.16.x.13 
8. Créez un groupe d'objets dont vous choisirez le nom et qui contiendra les 4 
serveurs que vous venez de définir. 
9. Remplacez les serveurs DNS par défaut (dns1.google.com et dns2.google.com) 
configurés sur le firewall par un objet représentant la passerelle par défaut sur 
le réseau « NatNetwork » : 192.36.253.1. 
Bonus : 

• 
Exportez􀀁la 􀄏ase d’o􀄏jets da􀅶s u􀅶􀀁fi􀄐hier􀀁CSV.􀀁
• 
En vous basant sur le format de ce fichier, créez un autre fichier CSV contenant 
deux objets machines : 
• 
« srv_ftp_pub » : 192.36.253.x2 
• 
« srv_mail_pub » : 192.36.253.x3 
• 
I􀅵portez􀀁le fi􀄐hier􀀁􀄐r􀀁da􀅶s la 􀄏ase d’o􀄏jets r􀄠seaux.􀀁
139 


Les objets 
Quiz 

Quiz
Q1 – 
Quelles sont les assertions vraies : 

A. L’objet 
dynamique récupère son IP automatiquement depuis les serveurs 
DNS 
B. Un objet hôte peut être dynamique ou statique. 
C. Un objet FQDN est toujours résolu automatiquement. 
D. Grâce au DHCP, le pare-feu peut découvrir automatiquement les adresses 
IP des autres machines du réseau et créer les objets correspondants. 
Q2 – 
Quelles sont les assertions vraies : 

A. Il est impossible de créer manuellement l’objet 
Firewall_A. 
B. Il est possible de créer un groupe d’objets 
FQDN. 
C. L’objet 
Network_external est géré automatiquement par le pare-feu. 
D. Il est possible d’exporter 
les objets sous forme d’un 
fichier CSV 
E. L’i􀅵port 
d’un 
fichier CSV remplace systématiquement toute la base 
d’objets. Il faut donc être vigilant et ne pas oublier d’objet 
dans le fichier 
au risque de casser la configuration. 
140 


CONFIGURATION 
RÉSEAU 

CSNA -STORMSHIELD NETWORK SECURITY -VERSION 4.X 


Programme du cours 

✔ 
Cursus des formations et certifications 
✔ 
Présentation de l’entreprise 
et des produits 
✔ 
Prise en main du firewall 
✔ 
Traces et supervision 
✔ 
Les objets 

• 
Configuration réseau 
Translation d'adresses 
Filtrage 
Protection applicative 
Utilisateurs & authentification 
VPN 
VPN SSL 
141 


Configuration réseau 

•➔Modes de configuration 
• 
Types 
d’interfaces 
• 
Lab – 
Configuration réseau : interfaces 
• 
Routage système 
• 
Routage avancé 
• 
Ordonnancement des types de routage 
• 
Lab – 
Configuration réseau : routage 
Configuration réseau 


142 


Configuration réseau 

MODES DE CONFIGURATION 
1-Mode Transparent ou mode Bridge 
2-Mode Avancé ou mode Routeur 
3-Mode Hybride 
3 

Trois modes de configuration existent sur l’ense􀅵ble 
de la gamme Stormshield 
Network Security: 

• 
Mode transparent ou mode Bridge, 
• 
Mode avancé ou mode routeur, 
• 
Mode hybride. 
Il est important de noter 􀆋u’il 
n’existe 
pas d’assistant 
pour la configuration de ces 
modes, il s’agit 
uniquement d’une 
dénomination. La mise en oeuvre 
de chacun des 
modes s’effectue 
suivant le besoin, en configurant les interfaces réseaux et les règles 
de translation. 


143 


Configuration réseau 

MODES DE CONFIGURATION 
1-Mode Transparent ou Mode Bridge 
Plan d’adressage: 
192.168.0.x/24 
Routeur par défaut: 
192.168.0.1 
Passerelle 
d’accèsInternet 
Adressage Interne 
192.168.0.1 
Adressage IP du bridge Translationd’adresses 
192.168.0.2 
Adressage Public 
4 

Grâce au mode transparent, le firewall Stormshield Network s’intègre 
aisément dans 
un réseau existant sans devoir en modifier sa configuration. 
La particularité de ce mode est que toutes les interfaces du firewall sont incluses 
dans un bridge qui porte une adresse IP du réseau local (IP utilisée pour accéder à 
l’interface 
d’ad􀅵inistration 
du firewall). Ceci permet d’avoir 
plusieurs réseaux 
physiques (un réseau par interface) partageant le même réseau logique. 

La communication entre les réseaux physiques et la passerelle d’accès 
Internet se 
fait en mode bridge (niveau 2) sans soustraire les flux transitant entre les interfaces 
aux contrôles du firewall (filtrage, analyse ASQ, etc.). 

Dans la figure ci-dessus, le réseau local utilise une plage d’adresses 
privée 
192.168.0.0/24 et accède à Internet via une passerelle qui assure la translation 
d’adresses. Le firewall Stormshield Network est positionné en coupure des 
connexions entre les machines du réseau local et la passerelle d’accès 
à Internet. 


144 


Configuration réseau 

MODES DE CONFIGURATION 
2-Mode Avancé ou Mode Routeur 
Plan d’adressage: 
172.16.1.x/24 
Routeur par défaut: 
172.16.1.1 
Plan d’adressage: 
192.168.0.x/24 
Routeur par défaut: Passerelle 
192.168.0.1 Adressage DMZ 
d’accèsInternet 
172.16.1.1 
Adressage Public 
195.36.253.1 
Adressage Interne 
192.168.0.1 
Translationd’adresses 
5 

Dans le mode avancé, le firewall fonctionne comme un routeur en gérant plusieurs 
réseaux logiques (adresses réseaux). Chaque interface est configurée avec un réseau 
IP particulier, ce qui permet une segmentation du réseau aux niveaux physique et 
logique. 
Dans l’i􀅵age 
ci-dessus, le réseau local est composé de deux réseaux logiques : un 
réseau pour les machines internes et un réseau pour les serveurs en DMZ. Chaque 
réseau est connecté au firewall via une interface possédant un plan d’adressage 
IP 
spécifique. L’adresse 
IP publique est configurée directement sur une interface 
externe du firewall. 

Dans ce mode, l’UTM 
Stormshield Network doit gérer les mécanismes de translation 
d’adresse 
pour assurer l’accès 
à l’Internet 
depuis les réseaux locaux. 


145 


Configuration réseau 

MODES DE CONFIGURATION 
3-Mode Hybride (1) 
Plan d’adressage: 
192.168.0.x/24 
Routeur par défaut: 
192.168.0.1 
Adressage Public 
195.36.253.1 
Adressage IP du bridge 
192.168.0.1 
Translationd’adresses 
Passerelle 
d’accèsInternet 
6 

Le mode hybride est une combinaison des modes bridge et avancé. Le principe est 
d'avoir plusieurs interfaces dans un bridge (même plan d’adressage) 
et d'autres 
interfaces indépendantes avec des plans d’adressages 
différents. 

Dans ce mode nous pouvons avoir deux cas de figure. Le premier est illustré ci-
dessus. Le réseau des machines internes et le réseau des serveurs en DMZ partagent 
le même plan d’adressage 
et ils sont connectés au firewall via des interfaces 
appartenant au même bridge. La translation d’adresse 
doit être configurée sur le 
firewall pour que le réseau local (réseau du bridge) accède à Internet via l’interface 
externe, configurée avec une adresse IP publique. 


146 


Configuration réseau 

MODES DE CONFIGURATION 
3-Mode Hybride (2) 
Plan d’adressage: 
195.36.253.x/28 
Plan d’adressage: 
192.168.0.x/24 
Routeur par défaut: 
Adressage IP du bridge 192.168.0.1 
195.36.253.1 
Passerelle 
d’accèsInternet 
Adressage Interne 
192.168.0.1 
Translationd’adresses 
7 

Le deuxième cas de figure est illustré ci-dessus. Le réseau des serveurs en DMZ est 
configuré avec un plan d’adressage 
IP public. Chaque serveur disposera donc d’une 
IP publique distincte. 

Ce réseau est connecté au firewall par une interface incluse dans le même bridge 
que l’interface 
externe où est connecté le routeur d’accès 
Internet. Les serveurs en 
DMZ accèdent à Internet via le bridge et aucune translation d’adresse 
n’est 
nécessaire (les connexions restent néanmoins soumises aux directives de filtrage et 
autres analyses applicatives de l’UTM). 

Le réseau des machines internes possède un plan d’adressage 
privé. Il est connecté 
au firewall via une interface n’appartenant 
pas au bridge. Par conséquent, la 
translation d’adresse 
doit être configurée pour lui permettre un accès à Internet. 


147 


Configuration réseau 

• 
Types d’interfaces 
➔
• 
Modes de configuration 
• 
Lab – 
Configuration réseau : interfaces 
• 
Routage système 
• 
Routage avancé 
• 
Ordonnancement des types de routage 
• 
Lab – 
Configuration réseau : routage 
Configuration réseau 


148 


Configuration réseau 

TYPESD’INTERFACES 
VLAN2 VLAN1 
Modem 
PPTP PPPoE 
3G/4G USB 
modem 
physique 3physique 2 physique 1 
LAGG1 
physique 4 physique 5 
LACP 
physique 6 GRETAP 
Bridge 


9 

Il existe plusieurs types d’interfaces 
sur le firewall. 

Dans le menu CONFIGURATION ⇒ 
RESEAU ⇒ 
Interfaces , on peut créer et configurer les 
types d’interfaces 
suivants: 

• 
Les interfaces physiques : Le nombre dépend du modèle du firewall, 
• 
Les interfaces bridges : Association de plusieurs interfaces physiques ou VLAN. Le 
nombre maximal de bridges dépend du modèle du firewall, 
• 
Les interfaces VLAN : Segment réseau attaché à une interface physique du firewall et 
caractérisée par un tag et un plan d’adressage 
spécifique. Le nombre maximal 
d’interfaces 
VLAN dépend du modèle du firewall, 
• 
Les interfaces Modem : Ce type d’interface 
permet la prise en charge d’une 
connexion 
entre le firewall et un modem (ADSL, RNIS, RTC, …). Les types de connexions possibles 
sont : PPPoE, PPTP. Elles sont vues en annexes. 
• 
Les interfaces GRETAP : Permettent d’encapsuler 
des trames Ethernet dans des paquets 
IP via le protocole GRE. Il est ainsi possible de relier deux réseaux Ethernet distants. 
• 
Les interfaces LAGG : Jus􀆋u’à 
huit interfaces physiques de même vitesse et duplex 
peuvent être agrégées en une seule interface logique. Les liens sont surveillés grâce à 
LACP (Link Aggregation Control Protocol). L’interface 
résultante est utilisable comme les 
interfaces physiques, mais est tolérante aux pannes et possède une bande passante 
multipliée. 
D’autres 
types interfaces peuvent être créés et paramétrés dans le menu CONFIGURATION 

⇒RESEAU ⇒Interfaces virtuelles: 
• 
Les interfaces IPsec (VTI : Virtual Tunneling Interfaces) : Permettent d’établir 
des tunnels 
IPsec routés. Elles seront vues en détails dans le chapitre consacré aux VPN IPsec, 
• 
Les interfaces GRE : destinées au transport du protocole GRE, lequel permet d’encapsuler 
des flux IP dans un tunnel IP (vues en CSNE), 
• 
Les interfaces loopback : interfaces dites de bouclage, internes au firewall et utiles 
notamment dans certaines configurations de routage dynamique. 
149 



Configuration réseau 

10 
TYPESD’INTERFACES 
Le menu CONFIGURATION ⇒Réseau ⇒Interfaces est constitué de deux parties : 

• 
L’en-tête (encadré vert) : Offre les fonctionnalités de base pour la gestion des 
interfaces. 
• 
La liste des interfaces (encadré rouge) : Affiche toutes les interfaces (physique, 
bridge, vlan, modem) du firewall. Il est possible de faire un glisser-déposer sur les 
interfaces pour modifier leur configuration. Par exemple, l’ajout 
d’une 
interface à 
un bridge peut se faire en glissant l’interface 
physique et en la déposant sur 
l’interface 
bridge. L’action 
inverse est possible pour retirer une interface d’un 
bridge. 
Pour configurer une interface (encadré bleu), vous pouvez double cliquer sur sa 
ligne en surbrillance ou cliquer sur le bouton Edition. La fenêtre d’édition 
est 
composée de deux onglets pour tous les types d’interface. 
Les deux flèches en haut à droite de la fenêtre permettent de confirmer les 
modifications effectuées et de fermer la fenêtre d’édition. 

NOTE : l’icône 
visible dans l’écran 
ci-dessus indique que l’ad􀅵inistrateur 
est 

connecté au firewall via l’interface 
correspondante. 


150 


Configuration réseau 

11 
TYPESD’INTERFACES 
Bouton on /off 
L’en-tête contient : 

• 
Filtre : Recherche des interfaces par une partie ou par la totalité des champs : 
nom, adresse IP ou commentaire, 
• 
Edition : Ouverture de la fenêtre de configuration de l’interface 
courante ou de 
l’un 
des 2 profils « Modem », 
• 
Ajouter : Ajout d’une 
nouvelle interface de type Bridge, VLAN, Modem (ou USB 
Modem) ou GRETAP, 
• 
Supprimer : Suppression de l’interface 
sélectionnée. Un message d’alerte 
s’affiche 
si l’interface 
est utilisée dans un menu de configuration. Malgré ce message, la 
suppression peut être forcée, 
• 
Superviser et Accéder à la supervision : Activation ou désactivation de la 
supervision d’une 
interface pour vérifier l’utilisation 
de la bande passante et le 
nombre de connexions, 
• 
Vérifier l’utilisation 
: Afficher les menus de configuration dans lesquels l’interface 
est utilisée. Le résultat de cette vérification s’affiche 
dans l’encadré 
de gauche en-
dessous de l’icône 
favoris 
151 


Configuration réseau 

TYPESD’INTERFACES 
Usurpation détectée, IP source 


192.168.1.2 192.168.1.1 
DATA 

incluse dans un réseau protégé 


192.168.2.1 192.168.1.1 
DATA 

Interface 

Interface 

12 
interne externe 
Interface 
externe 
192.168.1.0/24 
192.168.2.0/24 
Internet 
.1 
Pass from 192.168.2.0/24 port 
any to 192.168.1.0/24 port any 
Machine mal 
configurée 
10.0.0.1 
Usurpation 
détecté, IP 
source inconnue 
sur l’interfaceRéseau interne connecté à une 
interface mal configurée 
.1 
Les interfaces internes (protégées) n’acceptent 
que les paquets provenant d’un 
réseau connu 
depuis cette interface. Soit le réseau est directement connecté et donc déduit de l’adresse 
de 
l’interface. Soit le réseau est connu par une route statique partant de cette interface. 

Les interfaces externes (non protégées) acceptent tous les paquets exceptés ceux des réseaux 
protégés (connus sur une interface interne). 

En cas de mauvaise configuration de l’interface, 
des règles de filtrage un peu laxistes (ne 
précisant pas d’interface 
d’entrée) 
autoriseraient du trafic illégitime à passer au travers du 
firewall. 
L’exe􀅵ple 
ci-dessus illustre ce problème de configuration. Le réseau vert (192.168.2.0/24) est 
relié à une interface externe, il n’est 
donc pas ajouté dans la table des réseaux protégés. Un 
pirate présent sur une autre interface externe pourra alors émettre des paquets avec une 
adresse IP usurpée appartenant au réseau vert. Ce paquet sera considéré comme légitime par le 
système anti-usurpation. 


152 


Configuration réseau 

13 
•Interface physique : configuration générale 
TYPESD’INTERFACES
Une interface physique porte au moins une adresse IP, dynamique ou statique 
(encadré bleu), les paramètres dans l’encadré 
rouge sont détaillés ci-après : 

• 
État : Interface activée ou désactivée 
• 
Nom : Le nom de l’interface 
est obligatoire, c’est 
un nom logique différent du nom 
système de l’interface, 
• 
Commentaire : Paramètre facultatif pour ajouter toute remarque informative au 
sujet de l’interface 
sélectionnée, 
• 
Cette interface est : 
• 
interne (protégée) : Une interface protégée n’accepte 
que les paquets 
provenant d’un 
plan d’adressage 
connu, tel 􀆋u’un 
réseau directement 
connecté ou un réseau défini par une route statique. Cette protection 
comprend une mémorisation des machines connectées à cette interface 
(protégeant ainsi contre l’usurpation 
d’identité), 
et permet de générer les 
règles de filtrage implicites lors de l’activation 
de certains services du 
firewall (par exemple SSH). Une icône représentant un bouclier est 
apposée à toute interface protégée. 
• 
externe (publique) : Indique que l’interface 
est dépourvue des protections 
d’une 
interface protégée et peut donc recevoir des paquets provenant de 
n’i􀅵porte 
quel plan d’adressage 
(qui ne font pas partie des plans 
d’adresses 
des interfaces internes). Ce type d’interface 
est utilisé 
principalement pour connecter le firewall à Internet. 
153 


Configuration réseau 

14 
•Interface physique : configuration générale 
TYPESD’INTERFACES
Les paramètres dans l’encadré 
Plan d’adressage 
sont détaillés ci-après : 

• 
Adressage : Choix entre les deux possibilités suivantes : 
• 
Plan d’adressage 
hérité du bridge : Se reporter à la section bridge plus 
loin dans ce chapitre, 
• 
Dynamique/statique : La définition du type d’adresse 
est précisée sur la 
ligne suivante : Adresse IPv4. 
• 
Adresse IPv4 : Choix entre les deux possibilités suivantes : 
• 
IP dynamique (obtenue par DHCP). Un menu de configuration DHCP 
avancée s’affiche 
: 
o 
Nom DNS (facultatif) : Indique le nom de domaine envoyé au 
serveur DHCP, 
o 
Durée de bail demandée (secondes) : Permet de configurer la 
durée du bail DHCP demandée au serveur DHCP, 
o 
Demander les serveurs DNS au serveur DHCP et créer les objets 
machine : Le nom des objets créés est 
Firewall_<nom_interface>_dns_1, 
Firewall_<nom_interface>_dns_2, etc. 
• 
IP fixe (statique) : La sélection de cette option indique que l’interface 
possède une adresse IP fixe qui doit être renseignée dans la liste en-
dessous, accompagnée d’un 
masque réseau. Le masque peut être écrit 
aux formats numérique ou CIDR. Plusieurs adresses IP fixes (alias) peuvent 
être configurées sur une interface, même si elles font partie du même 
réseau IP. 
NOTE : aucune configuration n’est 
prise en considération si elle n’est 
pas appliquée 
avec le bouton Appliquer . 


154 


Configuration réseau 

15 
•Interface physique : configuration avancée 
TYPESD’INTERFACES
La figure ci-dessus illustre l’onglet 
CONFIGURATION AVANCÉE : 

• 
MTU : Indique la taille du MTU de l’interface 
en octets, 
• 
Adresse physique (MAC) : Permet de forcer l’adresse 
MAC d’une 
interface, 
• 
Média : Permet de choisir la vitesse du lien utilisé par l’interface. Par 
défaut, la vitesse est détectée automatiquement. 
155 


Configuration réseau 

16 
•Bridge : création et configuration générale 
TYPESD’INTERFACES
Deux méthodes sont disponibles pour la création d’un 
bridge : 

1. Présélection des interfaces membres du bridge : les interfaces sont mises 
en surbrillance, la fenêtre de configuration est directement renseignée, 
comme ci-dessus, 
2. Création d’un 
bridge sans interface membre, le nom du bridge dans la 
fenêtre de configuration reste grisé, jus􀆋u’à 
ce 􀆋u’au 
moins deux 
interfaces soient sélectionnées comme membres du bridge. 
L’onglet 
de CONFIGURATION GÉNÉRALE contient : 

• 
Paramètres généraux : Nommage de l’interface 
(champ obligatoire) et 
commentaire facultatif, 
• 
Plan d’adressage 
: Le bridge peut être configuré avec une adresse IP fixe 
accompagnée d’un 
masque réseau ou avec une IP dynamique fournie par 
un serveur DHCP, 
• 
Gestion des membres : Choix des interfaces membres du bridge, qui 
héritent de ses paramètres IP. 
NOTE : Le nombre maximum de bridge dépend du modèle. 


156 


Configuration réseau 

17 
•Bridge : configuration avancée 
TYPESD’INTERFACES
La figure ci-dessus illustre l’onglet 
CONFIGURATION AVANCÉE d’un 
bridge : 

• 
MTU : Indique la taille du MTU de l’interface 
en octets, 
• 
Adresse physique (MAC) : Permet de forcer l’adresse 
MAC du bridge. 
Toutes les interfaces membres du bridge héritent de son adresse MAC (et 
de son adresse IP), 
• 
Détection de boucles (Spanning Tree) : Permet d’activer 
le protocole RSTP 
ou MSTP pour communiquer avec les éléments de couche 2 du réseau et 
éviter les boucles. 
157 


Configuration réseau 

18 
•Interfacemembre d’unbridge: configurationavancéeTYPESD’INTERFACES
La figure ci-dessus illustre l’onglet 
CONFIGURATION AVANCÉE d’une 
interface : 

• 
MTU et Adresse Physique (MAC) : Les champs sont grisés puis􀆋u’ils 
sont 
hérités du bridge (adresse MAC commune à toutes les interfaces 
membres), 
• 
Média : Permet de choisir la vitesse du lien Ethernet utilisé par l’interface. 
Par défaut, la vitesse est détectée automatiquement, 
• 
Autoriser sans analyser : Autorise les paquets IPX (réseau Novell), 
NetBIOS (sur NETBEUI), AppleTalk (pour les machines Macintosh), PPPoE 
ou IPv6 entre les interfaces du bridge sans aucune analyse ni inspection de 
niveau supérieur (le firewall fonctionne comme un commutateur). 
• 
Préserver le routage initial : Garde l’adresse 
MAC de destination des 
trames reçues par une interface membre du bridge et envoyée par une 
autre interface membre, ce qui permet de préserver le routage initial des 
paquets. Cette option facilite l’intégration 
transparente du firewall dans un 
réseau sans avoir à modifier la route par défaut des machines. Attention : 
L’activation 
de cette option peut avoir des effets négatifs sur certaines 
fonctionnalités qui nécessitent la modification des paquets par le firewall. 
158 


Configuration réseau 

19 
•Interface virtuelle : VLAN par port (802.1q) 
TYPESD’INTERFACESFIREWALL 
Router mode 
2 VLAN interfaces: 
-VLAN10 
-VLAN20 
IP DATAGRAM ethernet 
header 
C 
R 
C 
From PC1…
IP DATAGRAM ethernet 
header 
C 
R 
C 
…ToSERVERIP DATAGRAM etherne 
header 
C 
R 
C 
IP DATAGRAM ethernet 
header 
C 
R 
C 
VLAN 
header 
VLAN 
header 
VLAN ID 20 
VLAN ID 10 
…ToSERVERPC 2 
SERVER 
PC 1 VLAN 10 VLAN 20 
802.1q Untagged ports 
…ToPC2From PC1…
802.1q 
Tagged 
port 
VLAN ID 10 & 20 
Les réseaux virtuels (VLAN : Virtual Local Area Network) introduisent la notion de 
segmentation virtuelle qui permet de constituer des sous-réseaux logiques au sein d'une 
même architecture réseau physique. Tous les équipements réseaux appartenant au 
même VLAN peuvent communiquer ensemble et forment un domaine de diffusion. 
Ainsi, l’utilisation 
des VLAN dans une architecture réseau améliore les performances en 
limitant les diffusions et offre une sécurité accrue en séparant les réseaux logiques. 
Stormshield gère les VLAN normés IEEE 802.1q, pour lesquels un en-tête 
supplémentaire de 4 octets : 

• 
Est ajouté par un commutateur administrable ou par le firewall à une trame Ethernet 
sortante sur un port étiqueté 802.1q, 
• 
Est supprimé par un commutateur administrable ou par le firewall à une trame 
Ethernet entrante sur un port étiqueté 802.1q. 
Cet en-tête comprend le champ VLAN id (VID) qui permet d’identifier 
le VLAN auquel 
appartient la trame. Ce champ est codé sur 12 bits. Il permet de définir jus􀆋u’à 
4094 
VLAN différents (le VLANID=0 signifie que la trame n’appartient 
à aucun VLAN et le 
VLANID=4095 est réservé). L’en-tête inclut également le champ Priority ou CoS (Class of 
Service) sur 3 bits qui indique la priorité du paquet définie par le standard IEEE 802.1p. 

Dans l’exe􀅵ple 
ci-dessus, une trame envoyée depuis PC1 : 

• 
Peut atteindre PC2 sans subir de modification, car les ports du commutateur sur 
lesquels PC1 et PC2 sont connectés appartiennent au même VLAN. 
• 
Peut atteindre le firewall par un étiquetage 802.1q effectué par le commutateur 
(Ajout du VID 20). 
• 
Ne peut pas atteindre SERVER directement, puis􀆋u’il 
est dans un VLAN différent. 
• 
Peut atteindre SERVER via routage par le firewall. Après routage, une nouvelle trame 
étiquetée par le firewall (Ajout du VID 10) est envoyée vers le serveur. Le 
commutateur supprime l’éti􀆋uette 
sur le port entrant et transmet la trame au 
serveur. 
159 



Configuration réseau 

20 
TYPESD’INTERFACES : EXTRÉMITÉ DE VLAN•VLAN: création et configuration générale 
Deux méthodes sont disponibles pour la création d’un 
VLAN : 

1. Présélection de l’interface 
parente : L’interface 
est mise en surbrillance, la 
fenêtre de configuration est directement renseignée, comme ci-dessus, 
2. Création d’un 
VLAN sans interface parente : L’erreur 
« ce VLAN n’est 
pas 
associé à une interface physique » empêche la création de l’interface 
tant 
que le champ Interface parente n’est 
pas renseigné. 
L’onglet 
de CONFIGURATION GÉNÉRALE contient : 

• 
Paramètres généraux : Nommage de l’interface 
(champ obligatoire) et 
commentaire facultatif, 
• 
Interface parente : Interface à laquelle sera rattaché le VLAN, 
• 
Identifiant de VLAN : Valeur du VLANID [1-4094], 
• 
Priorité (CoS) : Valeur inscrite dans le champ CoS sur tous les paquets 
envoyés par cette interface, 
• 
Cette interface est : Choix du type de l’interface, 
interne ou externe, 
• 
Plan d’adressage 
: L’interface 
VLAN peut être configurée avec une adresse 
IP fixe accompagnée d’un 
masque réseau ou avec une IP dynamique 
fournie par un serveur DHCP. Elle peut également hériter de l’adresse 
IP 
d’un 
bridge, ce cas spécifique est détaillé sur la diapositive suivante. 
NOTE : 

• 
L’onglet 
CONFIGURATION AVANCÉE d’un 
VLAN permet de modifier la 
valeur de la MTU de l’interface, 
• 
Dans le cas ci-dessus, l’interface 
parente du VLAN est désactivée, ce qui 
n’e􀅵p􀄡che 
en rien la création et le fonctionnement correct de l’interface 
VLAN. 
160 


Configuration réseau 

21 
•VLAN en mode bridge 
TYPESD’INTERFACESPC 
VLAN 20 
SERVER 
From PC…
…ToSERVER802.1q Tagged port 
etherne 
header 
C 
R 
C 
VLAN 
header 
IP DATAGRAM ethernet 
header 
C 
R 
C 
C 
R 
C 
IP DATAGRAM ethernet 
header 
C 
R 
C 
VLAN 
header 
IP DATAGRAM 
802.1q Tagged port 
VLAN 20 
VLAN ID 20 
SWITCH 2 
SWITCH 1 
VLAN ID 20 
FIREWALL 
Bridge mode 
2 VLAN interfaces: 
-VLAN20_1 
-VLAN20_2 
IP DATAGRAM e hernet 
header 
Le cas d’usage 
ci-dessus illustre l’ajout 
d’un 
firewall en coupure en mode bridge 
entre deux commutateurs existants et reliés entre eux par un lien étiqueté 802.1q. 
Après cet ajout, le comportement des commutateurs n’est 
pas modifié mais le trafic 
sur le VLAN est analysé par le firewall. 

Les étapes de création d’un 
VLAN en mode bridge sont les suivantes : 

1. Création de deux interfaces VLAN ayant le même identifiant (VID) sur 
deux interfaces parentes différentes, 
2. Création d’un 
bridge contenant ces deux interfaces, 
3. Répétition de ces deux étapes autant de fois 􀆋u’il 
y a de VLAN différents 
devant transiter par le lien entre les deux commutateurs. 
Dans l’exe􀅵ple 
ci-dessus : 

1. Une trame envoyée depuis PC vers SERVER atteint le commutateur (Ajout 
du VID 20), puis atteint le firewall (suppression du VID 20 sur l’interface 
entrante), 
2. Le firewall analyse le contenu de la trame, 
3. La trame est étiquetée par le firewall (Ajout du VID 20 sur l’interface 
sortante) et envoyée vers le serveur, 
4. Le commutateur supprime l’éti􀆋uette 
sur le port entrant et transmet la 
trame au serveur. 
161 


Configuration réseau 

22 
•Vérification de la configuration 
TYPESD’INTERFACES
La cohérence de la configuration réseau est analysée en temps réel. Vous pouvez 
l’afficher 
en cliquant sur la flèche en bas de l’écran. 

Un avertissement n’e􀅵p􀄡che 
pas la sauvegarde de la configuration. En revanche, 
une erreur bloque la sauvegarde (le bouton Appliquer est grisé). 


162 


Configuration réseau 

• 
Lab – 
Configuration réseau : interfaces 
➔
• 
Modes de configuration 
• 
Types 
d’interfaces 
• 
Routage système 
• 
Routage avancé 
• 
Ordonnancement des types de routage 
• 
Lab – 
Configuration réseau : routage 
Configuration réseau 


163 


Configuration réseau 
Lab 

Lab 3 – 
Configuration réseau : interfaces 

Pour la suite des labs, vous devez sélectionner et activer la politique de filtrage (10) 
Pass all dans le menu CONFIGURATION ⇒ 
POLITIQUE DE SÉCURITÉ ⇒ 
Filtrage et 
NAT qui autorisera tous les trafics traversant ou à destination du firewall. 

En bas de page, cliquez ensuite sur le bouton Appliquer. 


• 
Configuration des interfaces : 
1. Configurez les interfaces OUT, DMZ1 et IN de votre firewall comme suit : 
• 
OUT : 192.36.253.x0/24 
• 
DMZ1 : 172.16.x.254/24 
• 
IN : 192.168.x.254/24 
2. Si vous utilisez la VM « Client_TRAINING_x », double cliquez sur le raccourci 
bureau «network_config.sh », et choisissez la lettre de compagnie x. Si vous 
utilisez votre hôte physique, configurez l’interface 
réseau « Virtual Host-only 
Ethernet Adapter #2 ou #3 » de votre station comme suit : 
• 
Adresse IP : 192.168.x.2/24 
• 
Passerelle par défaut : 192.168.x.254 
• 
Serveur DNS : 172.16.x.10 
164 


Configuration réseau 

• 
Routage système 
➔
• 
Modes de configuration 
• 
Types 
d’interfaces 
• 
Lab – 
Configuration réseau : interfaces 
• 
Routage avancé 
• 
Ordonnancement des types de routage 
• 
Lab – 
Configuration réseau : routage 
Configuration réseau 


165 


Configuration réseau 

ROUTAGE SYSTÈME 
• 
Routage : route par défaut 
212.13.25.120/30 

Par défaut 

out 

dmz1 


in 


2 

Le trafic qui ne correspond à aucune route dans la table de routage, quel que soit le 
type de route : standard (routage statique, dynamique), ou propriétaire Stormshield 
(routage par politique) est renvoyé vers la passerelle par défaut. 


166 


Configuration réseau 

3 
•Routage : route par défaut 
ROUTAGE SYSTÈME 
La passerelle par défaut est renseignée dans l’onglet 
ROUTES STATIQUES IPV4 du 
menu CONFIGURATION ⇒ 
RÉSEAU ⇒ 
Routage, paramètre Passerelle par défaut 
(routeur). Ce paramètre peut prendre comme valeur : 

• 
Un objet machine : Pour spécifier une seule passerelle par défaut sans test de 
disponibilité, sans répartition de charge et sans passerelle de secours (exemple ci-
dessus), 
• 
Un objet routeur : Les différentes passerelles configurées dans l’o􀄏jet 
routeur 
permettent d’effectuer 
des tests de disponibilité, de la répartition de charge et 
d’utiliser 
des passerelles de secours. Ce type d’o􀄏jet 
est décrit plus tard dans ce 
chapitre. 
NOTE : sur une interface obtenant dynamiquement son adresse IP (par DHCP), 
l’o􀄏tention 
du bail DHCP donne lieu à la création d’un 
objet nommé 
« Firewall_<nom_interface>_router », utilisable en tant que passerelle par défaut. 
Par exemple, l’adressage 
de votre interface out étant dynamique, vous pouvez 
renseigner le paramètre Passerelle par défaut (routeur) avec l’o􀄏jet 
: 
« Firewall_out_router ». 


167 


Configuration réseau 

ROUTAGE SYSTÈME 
• 
Routage : route statique 
4 
Routeur D Site distant C 
192.168.3.0/24 
Site distant B 
192.168.2.0/24 
Site distant D 
192.168.4.0/24 
in out 
Routeur C 
Routeur B 
Le routage statique consiste à renseigner manuellement la passerelle distante à 
laquelle sont transmis les paquets devant atteindre un réseau distant. Dans la figure 
ci-dessus, trois routes statiques sont nécessaires pour atteindre les réseaux distant B, 
C, D via l’interface 
de sortie nommée « sites », puis les routeurs Routeur B, Routeur 
C, Routeur D. 


168 


Configuration réseau 

5 
ROUTAGE SYSTÈME 
En cas de configuration 
incohérente 
•Routage : route statique 
La configuration des routes statiques s’effectue 
dans l’encadré 
ROUTES STATIQUES 
IPV4 du premier onglet du menu CONFIGURATION ⇒RÉSEAU ⇒Routage. 
L’encadré 
contient une barre de recherche et deux boutons pour ajouter ou 
supprimer une route. Il contient également une fenêtre qui liste toutes les routes 
statiques et leurs paramètres. Le bouton « Ajouter » ajoute une entrée à la liste. Les 
paramètres qui doivent obligatoirement être renseignés sur cette ligne sont : 

• 
État : On / off 
• 
Réseau de destination : Peut être un objet machine, réseau ou un 
groupe. 
• 
Passerelle : Un objet machine qui représente l’adresse 
IP de la passerelle 
permettant d’atteindre 
le réseau de destination. 
• 
Interface : Choix de l’interface 
de sortie pour atteindre la passerelle. En 
se basant sur les paramètres de l’interface, 
le firewall renseigne 
automatiquement le champ plan d’adressage. Le fait de sélectionner 
l’interface 
se justifie dans le cas d’un 
bridge qui peut contenir des 
interfaces protégées et non protégées. Seule la sélection de l’interface 
permet de savoir si le réseau doit être considéré comme protégé ou non. 
Dans le cas où le plan d’adressage 
de l’interface 
et de la passerelle n’est 
pas le même, un message d’erreur 
annonce que « la passerelle n’est 
pas 
routable ». 
169 


Configuration réseau 

• 
Routage avancé 
➔
• 
Modes de configuration 
• 
Types 
d’interfaces 
• 
Lab – 
Configuration réseau : interfaces 
• 
Routage système 
• 
Ordonnancement des types de routage 
• 
Lab – 
Configuration réseau : routage 
Configuration réseau 


170 


Configuration réseau 

ROUTAGE AVANCÉ 
• 
Routage dynamique 
BIRD 
RIP BGP OSPF 
in sites 
OSPF 
Routeur D 
Routeur C 
Routeur B 
Site distant C 
192.168.3.0/24 
Site distant B 
192.168.2.0/24 
Site distant D 
192.168.4.0/24 
7 

Avec le routage dynamique les routes sont apprises automatiquement grâce à un 
protocole de routage. Les firewalls SNS utilisent le logiciel BIRD pour mettre en 
oeuvre 
le routage dynamique. BIRD implémente 3 protocoles de routage RIP, OSPF et 
BGP dont les versions supportées sont renseignées dans la base de connaissances. 
Dans la figure ci-dessus, le protocole de routage OSPF est activé sur l’interface 
« sites » du firewall pour lui permettre d’apprendre 
les routes pour accéder aux 
réseaux distant B, distant C et distant D. 


171 


Configuration réseau 

8 
ROUTAGE AVANCÉ 
•Routage dynamique 
Le routage dynamique peut se configurer depuis l’interface 
graphique dans l’onglet 
ROUTAGE DYNAMIQUE IPV4 du menu CONFIGURATION ⇒RÉSEAU ⇒Routage. 
Les réseaux de destination ajoutés dans la table de routage par un protocole 
dynamique peuvent être ajoutés à la table des réseaux protégés. 


172 


Configuration réseau 

ROUTAGE AVANCÉ 
• 
Routage par politique 
Mails 
sortants 

isp2 

in 


9 

ISP 2 ISP 1 
dmz1 
Autres 
trafics 
isp1 
Le routage par politique (alias PBR : Policy Based Routing) permet de spécifier une 
passerelle dans une règle de filtrage. Le flux spécifié par la règle est ainsi envoyé vers 
une passerelle choisie par l’ad􀅵inistrateur. 

Dans l’exe􀅵ple 
illustré ci-dessus, le trafic des emails sortants est renvoyé vers la 
passerelle « ISP2 » et le reste du trafic est renvoyé vers la passerelle « ISP1 », 
laquelle est la passerelle par défaut. 


173 


Configuration réseau 

10 
ROUTAGE AVANCÉ 
•Routage par politique : configuration 
La mise en oeuvre 
d’une 
directive de routage par politique s’effectue 
dans le champ 
Action d’une 
règle de filtrage. Deux types d’o􀄏jet 
peuvent être renseignés au niveau 
de ce champ : 

• 
Un objet machine : Pour spécifier une passerelle, 
• 
Un objet routeur : Permet d'utiliser un objet routeur précédemment 
configuré et d'attribuer ses paramètres d'équilibrage et de répartition de 
charge à la règle de filtrage. 
174 


Configuration réseau 

ROUTAGE AVANCÉ 
• 
Objet routeur : répartition de charge 
ISP 1 

ISP 2 

Connexions 

Connexions 

isp1 

isp2

dmz1 

in 

11 

Un objet routeur regroupe plusieurs passerelles, permettant leur utilisation 
simultanée, mais donne lieu à l’ajout 
d’une 
seule route dans la table de routage. Par 
ailleurs, il permet d’effectuer 
des tests de disponibilité, de la répartition de charge et 
d’utiliser 
des passerelles de secours. 

La répartition de charge permet de répartir les connexions sortantes vers plusieurs 
passerelles. La répartition peut être équitable, comme elle peut être pondérée pour 
que chaque passerelle reçoive un pourcentage spécifique du trafic global. Le mode 
de répartition peut être basé sur l’adresse 
IP source ou sur les paramètres d’une 
connexion, à savoir, les adresses IP et les numéros de ports source et destination. 

La figure ci-dessus illustre un exemple dans lequel l’ense􀅵􀄏le 
des connexions 
sortantes sont réparties vers les passerelles « ISP1 » et « ISP2 » selon un mode de 
répartition choisi (par source ou par connexion). 

En utilisant les objets routeur, la répartition de charge peut être appliquée au trafic 
envoyé vers la passerelle par défaut ou bien pour un trafic particulier via le routage 
par politique. Dans le premier cas, l’o􀄏jet 
routeur doit être spécifié comme 
passerelle par défaut du firewall (voir la diapositive 2), dans le deuxième cas l’o􀄏jet 
routeur doit être renseigné dans le paramètre passerelle du champ Action d’une 
règle de filtrage (voir la diapositive 10). 


175 


Configuration réseau 

12 
•Objet routeur : création et configuration 
ROUTAGE AVANCÉ 
La configuration d’un 
routage par répartition de charge s’effectue 
dans un objet 
routeur. Les différentes passerelles doivent être ajoutées dans l’onglet 
LISTE DES 
PASSERELLES UTILISÉES. Chaque ligne permet de renseigner : 

• 
La passerelle avec un objet machine 
• 
Test de disponibilité : Permet de tester la disponibilité de la passerelle en utilisant 
des pings. Ce paramètre peut avoir plusieurs valeurs : 
• 
Pas de test de disponibilité : La disponibilité de la passerelle n’est 
pas 
testée. 
• 
Tester directement la passerelle : Des commandes ping sont envoyées 
directement à la passerelle pour tester sa disponibilité. 
• 
Une machine ou un groupe de machines, se trouvant derrière la 
passerelle, vers lesquelles les pings sont envoyés pour tester la 
disponibilité et le fonctionnement de la passerelle. 
Par défaut, l’état 
de chaque passerelle est vérifié toutes les 15 secondes en envoyant 
un ping à chaque machine renseignée. Dans le cas où aucune réponse n’est 
reçue au 
bout de 2 secondes, le firewall recommence 3 fois avant de considérer la passerelle 
indisponible. L’état 
des passerelles est visible dans le menu routes de la supervision. 

NOTE : On ne peut pas tester la disponibilité des passerelles récupérées 
automatiquement par DHCP ou par une interface modem. 


176 


Configuration réseau 

13 
•Objet routeur : création et configuration 
ROUTAGE AVANCÉ 
Le poids (encadré rouge) permet d’affecter 
à une passerelle un pourcentage du trafic 
géré par l’o􀄏jet 
routeur selon le calcul suivant : 

􀝁􀝃ℎ􀝐􀝂􀝐ℎ􀝁􀝃􀝐􀝁
􀝐􀝎􀝂􀝂% 
= 
􀝏􀝑􀝉􀝂􀝐ℎ􀝁􀝁􀝃ℎ􀝐􀝂􀝈􀝈􀝃􀝐􀝁O 
×􀍳􀍲r 


Dans l’exe􀅵ple 
ci-dessus : poids RTR_ISP1 = 3, poids RTR_ISP2 = 7 

➔30% du trafic passe par RTR_ISP1, 70% par RTR_ISP2. 
La valeur d’un 
poids doit être comprise entre 1 et 1024. 

L’algorith􀅵e 
utilisé (encadré bleu) pour la répartition de charge est configuré par le 
paramètre Répartition de charge (Configuration avancée) : 

• 
Aucune répartition : Le trafic est transmis exclusivement à la première 
passerelle qui apparait dans la liste. 
• 
Par connexion : Répartit le trafic en fonction des adresses IP et des 
numéros de ports source et destination. Cet algorithme est recommandé 
parce 􀆋u’il 
permet de répartir également les connexions provenant d’une 
même machine. 
• 
Par Adresse IP source : Répartit le trafic en fonction de l’adresse 
source. Il 
permet de s’assurer 
que le trafic d’une 
machine sera toujours renvoyé vers 
la même passerelle. 
177 


Configuration réseau 

14 
•Objet routeur : création et configuration 
ROUTAGE AVANCÉ 
Lors􀆋u’un 
objet routeur est utilisé par une règle de filtrage (routage par politique), et 
􀆋u’aucune passerelle de cet objet n’est 
joignable, le comportement du firewall peut 
être configuré par le paramètre Si aucune passerelle n'est disponible : 

• 
Routage par défaut : Le trafic est transmis au routeur par défaut. 
• 
Ne pas router : Le trafic est bloqué par le firewall. 
La répartition de charge peut fonctionner avec 64 passerelles au maximum. 


178 


Configuration réseau 

ROUTAGE AVANCÉ 
15 
•Les passerelles de secours 
ISP 2 ISP 1 
dmz1 
in 
isp1 
isp2 
Connexions 
Connexions 
Connexions 
Connexions 
Un objet routeur permet également de spécifier une liste de passerelles de secours 
qui seront utilisées dans le cas où une, plusieurs ou toutes les passerelles principales 
sont indisponibles. 

Dans l’exe􀅵ple 
illustré ci-dessus, la passerelle « ISP2 » est considérée comme une 
passerelle de secours qui sera utilisée pour tout le trafic seulement si la passerelle 
« ISP1 » n’est 
plus disponible. 

Il est important de noter que grâce aux objets routeur, les passerelles de secours 
peuvent être utilisées pour le trafic envoyé à la passerelle par défaut ou bien 
seulement pour un trafic particulier en utilisant le routage par politique. 


179 


Configuration réseau 

16 
ROUTAGE AVANCÉ 
•Les passerelles de secours : création et configuration 
Plusieurs passerelles de secours peuvent être ajoutées dans l’onglet 
LISTE DES 
PASSERELLES DE SECOURS d’un 
objet routeur. Pour chaque passerelle de secours, on 
peut définir un équipement de test et un poids comme pour les passerelles 
principales. 

La configuration avancée permet de configurer deux éléments : 

• 
Quand la ou les passerelles de secours doivent être activées : 
• 
Lorsque toutes les passerelles principales sont injoignables, 
• 
Lorsqu'au moins une passerelle principale est injoignable, 
• 
Lorsque le nombre de passerelles principales joignables est 
inférieur à un certain seuil. (1<seuil≤ 
nombre de passerelles 
principales). 
• 
S’il 
faut activer une ou toutes les passerelles de secours : par défaut, seule 
la première passerelle de secours joignable dans la liste est utilisée sauf si 
l’option 
Activer toutes les passerelles de secours en cas d'indisponibilité 

est sélectionnée. 

64 passerelles de secours au maximum peuvent être renseignées. 


180 


Configuration réseau 

ROUTAGE AVANCÉ 
• 
Route de retour 
Connexion 
entrante 

4 

isp1 

2 
3 

in 


17 

ISP 2 (DEFAULT GW) ISP 1 
dmz1 isp2 
1 
4 
La route de retour permet de spécifier l’interface 
de sortie pour atteindre une 
passerelle distante. Ce type de route est utilisé pour forcer le flux sortant d’une 
connexion entrante à repasser via l’interface 
d’entrée 
de la connexion. 

La figure ci-dessus illustre un exemple dans lequel on dispose de deux accès WAN. 
L’accès 
« ISP1 » est réservé exclusivement aux flux emails (entrants et sortants). 
L’accès 
« ISP2 » est utilisée comme sortie par défaut pour les autres flux. 

Sans route de retour, les réponses des connexions emails entrantes via l’interface 
« ISP1 » peuvent être renvoyées via l’interface 
« ISP2 ». 


181 


Configuration réseau 

18 
•Route de retour : création et configuration 
ROUTAGE AVANCÉ 
La configuration d’une 
route de retour s’effectue 
dans l’onglet 
ROUTE de RETOUR du 
menu CONFIGURATION ⇒RÉSEAU ⇒Routage. Il faut ajouter une ligne pour chaque 
route, dans laquelle il faut spécifier la passerelle, et l’interface 
par laquelle elle est 
joignable. 


182 


Configuration réseau 

• 
Ordonnancement des types de routage 
➔
• 
Modes de configuration 
• 
Types 
d’interfaces 
• 
Lab – 
Configuration réseau : interfaces 
• 
Routage système 
• 
Routage avancé 
• 
Lab – 
Configuration réseau : routage 
Configuration réseau 


183 


Configuration réseau 

20 
Ne pas router 
Routage Statique 
L’ORDONNANCEMENTDES TYPESDE ROUTAGERoutage Dynamique 
Routage par Politique 
Routage par défaut 
Paquet IP 
P 
R 
I 
O 
R 
I 
T 
É 
-
+ 
Répartition de charge et/ou 
passerelles de secours 
charge et/ou Répartition de 
passerelles de secours 
Route de retour 
La figure ci-dessus illustre l’ordre 
d’application 
des différents types de routage. 

NOTE : Si un objet routeur est utilisé dans le routage par politique et 􀆋u’aucune 
passerelle n’est 
joignable, deux options sont possibles : le routage est délégué au 
routage par défaut ou bien le trafic est bloqué par le firewall. Ces options ne sont pas 
possibles si l’o􀄏jet 
routeur est utilisé dans le routage par défaut. 


184 


Configuration réseau 

RECOMMANDATIONS 
• 
Désactiver les interfaces non utilisées 
• 
Déclarer les interfaces internes 
• 
Définir des routes statiques pour les réseaux internes 
21 

Si une interface n’est 
pas utilisée, il est recommandé de la désactiver pour éviter 
toute arrivée de trafic par celle-ci. 

Afin de profiter des mécanismes d’antispoofing, il est recommandé de déclarer une 
interface « interne » dès que possible. 
Si une alarme de ce type se déclenche, il y a très probablement un problème 
d’architecture 
à corriger. 
Attention : les modes d’inspection 
IDS et firewall court-circuitent l’antispoofing. 

Afin de légitimer les réseaux joignables depuis une interface, il faut 􀆋u’ils 
soient 
connus par le firewall. Pour cela, il est nécessaire d’avoir 
une route partant d’une 
interface protégée vers ces réseaux. A l’inverse, 
tout réseau injoignable défini dans la 
table de routage risque d’entraver 
le mécanisme d’antispoofing. Il est donc 
recommandé de ne jamais laisser de route inutile dans la table de routage. 


185 


Configuration réseau 

22 
Pour aller plus loin, consultez les notes techniques du site documentation.stormshield.eu : 

• 
Configurer un modem 3G/4G sur SNS 
• 
Encapsulation niveau 2 
• 
Stacking : répartition de trafic sur plusieurs firewalls 
• 
Agrégation de liens LACP 
• 
Routage dynamique BIRD V3 
• 
Configurer la QoS sur les firewalls SNS 
• 
SD-WAN -Sélectionner le meilleur lien réseau 
Et pour les situations/questions très spécifiques, consultez la base de connaissance du TAC 
kb.stormshield.eu. 


186 


Configuration réseau 

• 
Lab – 
Configuration réseau : routage 
➔
• 
Modes de configuration 
• 
Types 
d’interfaces 
• 
Lab – 
Configuration réseau : interfaces 
• 
Routage système 
• 
Routage avancé 
• 
Ordonnancement des types de routage 
Configuration réseau 


187 


Configuration réseau 
Lab 

Lab 3 – 
Configuration réseau : routage 

Configuration du routage : 

1. Configurez la passerelle par défaut de votre firewall « 192.36.253.1 ». 
2. Configurez le routage statique sur votre firewall pour permettre à votre station 
« Client_TRAINING_x » de joindre le réseau interne « 192.168.x.0/24 » de 
l’entreprise 
distante. 
• 
Configuration du proxy cache DNS : 
Activez le proxy cache DNS . Le proxy cache DNS n’est 
pas abordé en cours, mais il 
doit être utilisé lors de ces labs pour permettre la résolution de noms DNS de façon 
correcte. La page suivante donne plus d’indications 
sur cette option et la manière de 
la configurer. 

Le fire􀇁all 
intercepte les re􀆋u􀄡tes DNS à destination d’Internet, et 
effectue lui-même 
la requête vers le serveur DNS configuré dans le lab 2, point 9. 

Si le nom demandé est dans son cache, le firewall répond directement à la demande 

selon 
les infor􀅵ations 
􀆋u’il 
possède. 


Cette technique de Proxy cache DNS est détaillée dans les annexes de la 
configuration réseau. 

Effectuez la configuration comme suit : 

• 
Rendez-vous dans le menu CONFIGURATION ⇒Réseau ⇒Proxy cache DNS et 
activez le cache DNS. 
• 
L’o􀄏jet 
autorisé à utiliser ce cache 
est 
votre serveur DNS présent 
sur la DM) 
(172.16.x.10), ajoutez-le dans la « liste des clients autorisés à utiliser le cache 

DNS ». 


188 


Configuration réseau 
Quiz 

Quiz
Q1 – 
Les objets routeurs peuvent être utilisés comme route par défaut : 

A. Vrai 
B. Faux 
Q2 – 
Une route de retour est obligatoire pour joindre l’Internet 
: 

A. Vrai 
B. Faux 
Q3 – 
Un bridge contenant les interfaces dmz1 et dmz2 permet aux machines 
connectées sur ces deux interfaces de communiquer directement sans filtrage ni 
analyse. 

A. Vrai 
B. Faux 

222 


Translation d’adresses 


•➔Généralités 
• 
Translation dynamique 
• 
Translation statique par port 
• 
Translation statique 
• 
Menu « NAT » 
• 
Ordre d’application des 
règles de NAT 
• 
Lab – 
Translation 
d’adresses 
Translation 
d’adresses 



223 


Translation d'adresses 

GÉNÉRALITÉS 
• 
Un réseau privé utilise des plages d'adresses IP qui ne 
sont pas routées sur Internet (RFC 1918). 
Préfixe Plage adresses IPv4 Nombre d'adresses 
10.0.0.0/8 

10.0.0.0 – 
10.255.255.255 

16 777 216 
172.16.0.0/12 

172.16.0.0 – 
172.31.255.255 

1 048 576 
192.168.0.0/16 

192.168.0.0 – 
192.168.255.255 

65 536 

• 
NAT (Network Address Translation) : Un mécanisme 
permettant la modification d'un paquet IP (adresse 
source/destination, port source/destination). 
3 

Les mécanismes de translation d’adresses 
ont été mis au point pour faire face à la 
pénurie d’adresses 
IP publiques. Le principe de base consiste à utiliser des adresses 
IP privées, définies par l’IANA 
(Internet Assigned Numbers Authority) et renseignées 
par la RFC 1918 (tableau ci-dessus), pour les réseaux locaux des entreprises et des 
particuliers, et de relier ces réseaux à Internet via une seule adresse IP publique. 


224 


Translation d’adresses 


• 
Translation dynamique 
➔
• 
Généralités 
• 
Translation statique par port 
• 
Translation statique 
• 
Menu « NAT » 
• 
Ordre d’application des 
règles de NAT 
• 
Lab – 
Translation 
d’adresses 
Translation 
d’adresses 



225 


Translation d'adresses 

TRANSLATION DYNAMIQUE 
• 
Translater un réseau privé en une adresse IP publique 
Serveur WEB sur Internet 

@web 

Translation d’adresses80@Web xxxx@privA 
Port 
Destination 
Adresse 
Destination 
Port 
Source 
Adresse 
Source 
Paquet original 
80@Web 20 000 @pub_fw 
Port 
Destination 
Adresse 
Destination 
Port 
Source 
Adresse 
Source 
Paquet translaté 
1 2 
1 2 
Machine 
sur le réseau interne 
@privA 
@pub_fw 
Connexion HTTP 
34 
Adresse 
source 
Port 
source 
Adresse 
source 
Port 
Source 
@privA xxxx @pub_fw 20 000 
Paquet translaté 4 Paquet original 

3 
xxxx@privA 80@Web 
Port 
Destination 
Adresse 
Destination 
Port 
Source 
Adresse 
Source 
Adresse Port Adresse Port 
Source Source Destination Destination 
@Web 80 @pub_fw 20 000 

5 

Dans la majorité des cas, ce type de translation est mis en oeuvre 
pour permettre à 
un réseau local configuré avec des adresses IP privées d’accéder 
à Internet via une 
seule adresse IP publique. 

La figure ci-dessus illustre le fonctionnement de ce type de translation lorsque la 
machine « @privA » accède à un serveur WEB « @web » sur internet. Le paquet IP 
transmis par la machine « @privA » vers le serveur « @web » est intercepté par le 
firewall qui remplace l’adresse 
IP source « @privA » par l’adresse 
IP publique du 
firewall « @pub_fw » et le port source « xxxx » (ce port est choisi par le système 
d’exploitation 
de la machine « @privA ») par un port dans la plage [20000-59999]. Le 
firewall garde dans sa mémoire la correspondance de translation entre (l’adresse 
IP 
« @privA »/port source « xxxx ») et (l’adresse 
IP « @pub_fw »/port source 20000). 
Cette correspondance est utilisée pour translater les réponses en provenance du 
serveur WEB en remplaçant (l’adresse 
IP destination « @pub_fw »/port destination 
2000) par (l’adresse 
IP destination « @privA »/port destination « xxxx »). 


226 


Translation d'adresses 

TRANSLATION DYNAMIQUE 
• 
Translater un réseau privé en une adresse IP publique, possible 
conflit de port source. Serveur WEB sur Internet 

@web 

Translation d’adresses@pub_fw 
Connexions HTTP 
Adresse source Port source Adresse source Port Source 
@privA 

1232 

@pub_fw 

20000 


Ephemeral_fw 

@privB 

20321 

@pub_fw 

20001 


[20000, 59999] 

@privC 

1232 

@pub_fw 

20002 


6 

La modification du port source se justifie principalement dans le cas où deux 
machines « @privA » et « @privC » utilisent le même port source pour ouvrir une 
connexion vers le même serveur WEB. Si le port source n’est 
pas modifié par le 
firewall, le serveur web recevra deux demandes de connexion arrivant de la même 
adresse IP publique « @pub_fw » et même port source ce qui peut engendrer un 
dysfonctionnement des deux connexions et une ambiguïté de translation des 
réponses au niveau du firewall. Ce dernier ne pourra pas savoir à quelle machine il 
faudra renvoyer les réponses reçues du serveur. 

Lorsque l’on 
utilise l’objet 
« ephemeral_fw » en tant que Port 
source 
de Trafic 
après 
translation, les ports sources seront choisis dans une plage prédéfinie [2000059999]. 
Par défaut, ils seront choisis séquentiellement dans la plage, cependant une 
option est disponible pour rendre ce choix aléatoire. 

Il est possible d’utiliser 
une plage d’adresses 
pour masquer l’adresse 
IP source. 
La règle de NAT utilisera un objet de type réseau ou plage d’adresses 
à la place d’un 
objet de type hôte dans le champ Source 
de Trafic 
après 
translation. La translation se 
faisant avec une correspondance 1:1 entre les plages, elles doivent être de la même 
taille. Il est alors obligatoire de ne pas translater le port source. 


227 


Translation d’adresses 


• 
Translation statique par port 
➔
• 
Généralités 
• 
Translation dynamique 
• 
Translation statique 
• 
Menu « NAT » 
• 
Ordre d’application des 
règles de NAT 
• 
Lab – 
Translation 
d’adresses 
Translation 
d’adresses 



228 


Translation d'adresses 

TRANSLATION STATIQUE PAR PORT 
• 
Donner accès à des ressources internes derrière une seule 
adresse IP publique 
Machine sur Internet 
Serveur WEB 
sur le réseau interne 
@priv_web 
@client 
80@pub_fw xxxx@client 
Port 
Destination 
Adresse 
Destination 
Port 
Source 
Adresse 
Source 
Paquet original 
80@priv_web xxxx@client 
Port 
Destination 
Adresse 
Destination 
Port 
Source 
Adresse 
Source 
Paquet translaté 12 Translation d’adresses2 1 
@pub_fw 
Connexion HTTP 43 
xxxx@client 80@pub_fw 
Port 
Destination 
Adresse 
Destination 
Port 
Source 
Adresse 
Source 
Paquet translaté 
xxxx@client 80@priv_web 
Port 
Destination 
Adresse 
Destination 
Port 
Source 
Adresse 
Source 
Paquet original 43 
Adresse 
destination 
Port 
destination 
Adresse 
destination 
Port 
destination 
@priv_web 80 @pub_fw 80 
8 

Ce type de translation, appelé communément « redirection de port », permet de 
rendre accessible des services hébergés dans un réseau local via une seule adresse 
IP publique. 

La figure ci-dessus illustre l’exe􀅵ple 
d’un 
serveur web local « @priv_web » 
accessible depuis internet sur l’adresse 
IP publique du firewall « @pub_fw ». Sur le 
firewall, une règle de translation est créée pour la correspondance entre (l’adresse 
IP 
publique destination « @pub_fw »/port destination 80) et (l’adresse 
IP du serveur 
local « @priv_web »/port destination 80). 

Ainsi, le paquet émis par la machine « @client » vers l’adresse 
IP « @pub_fw » sur le 
port 80 est modifié avant d’􀄡tre 
renvoyé vers le serveur web sur le même port. Et la 
réponse renvoyée par ce serveur est également modifiée en conséquence avant 
d’􀄡tre 
renvoyée vers la machine « @client ». Il est important de noter que les ports 
destination avant et après translation peuvent être différents. 


229 


Translation d'adresses 

TRANSLATION STATIQUE PAR PORT 
• 
Donner accès à des ressources internes derrière une seule 
adresse IP publique 
Machine sur Internet 

Serveur WEB 
@priv_web 
Serveur MAIL 
@priv_mail 
@client 
@pub_fw 
Translation d’adresses 
Adresse 
destination 
Port 
destination 
Adresse 
destination 
Port 
destination 
@priv_web 80 @pub_fw 80 
@priv_mail 25 @pub_fw 25 
9 

Il est possible de rendre accessibles plusieurs services hébergés sur plusieurs 
serveurs locaux 
via une seule adresse IP publi􀆋ue co􀅵􀅵e l’illustre la figure ci-dessus. 
La distinction entre les serveurs se base uniquement sur le numéro de port du 
service. 


230 


Translation d’adresses 


• 
Translation statique 
➔
• 
Généralités 
• 
Translation dynamique 
• 
Translation statique par port 
• 
Menu « NAT » 
• 
Ordre d’application des 
règles de NAT 
• 
Lab – 
Translation 
d’adresses 
Translation 
d’adresses 



231 


Translation d'adresses 

TRANSLATION STATIQUE 
• 
Dédier une adresse IP publique à un serveur interne (connexion 
entrante) 
+ @pub_mail 
Serveur mail sur Internet 
Serveur mail 
sur le réseau interne 
@priv_mail 
@client 
25@pub_mail xxxx@client 
Port 
Destination 
Adresse 
Destination 
Port 
Source 
Adresse 
Source 
Paquet original 
25@priv_mail xxxx@client 
Port 
Destination 
Adresse 
Destination 
Port 
Source 
Adresse 
Source 
Paquet translaté 12 
Translation d’adresses2 1 
@pub_fw 
Connexion SMTP 43 
xxxx@client 25@pub_mail 
Port 
Destination 
Adresse 
Destination 
Port 
Source 
Adresse 
Source 
Paquet translaté 
xxxx@client 25@priv_mail 
Port 
Destination 
Adresse 
Destination 
Port 
Source 
Adresse 
Source 
Paquet original 43 
Adresse 
destination 
Port 
destination 
Adresse 
destination 
Port 
destination 
@priv_mail any @pub_mail any 
11 

Ce type de translation permet de dédier une adresse IP publique à un serveur local 
configuré avec une adresse IP privée. Ceci suppose 􀆋u’on 
dispose d’au 
moins deux 
adresses IP publiques : « @pub_fw » configurée sur l’interface 
externe du firewall et 
« @pub_mail » employée sur les règles de translation. 

La translation statique doit être bidirectionnelle, ce qui signifie que le serveur local 
est accessible pour les connexions entrantes, depuis internet, avec son adresse IP 
publique et les connexions sortantes initiées par ce serveur vers internet doivent 
avoir comme source la même adresse IP publique. Ceci se traduit par deux règles de 
translation : une règle pour les connexions entrantes et une autre règle pour les 
connexions sortantes. 

La figure ci-dessus, illustre les modifications que subissent les paquets d’une 
connexion entrante vers un serveur mail local en se basant sur la règle de translation 
qui fait la correspondance entre (l’adresse 
IP publique destination « @pub_mail ») et 
(l’adresse 
IP du serveur local « @priv_mail »). 
Ainsi, le paquet émis par le serveur mail « @internet » vers l’adresse 
IP 
« @pub_mail » est modifié pour être renvoyé vers le serveur mail. Et la réponse 
renvoyée par ce serveur est également modifiée en conséquence avant d’􀄡tre 
renvoyée vers le serveur mail « @internet ». Il est important de noter que les ports 
source avant et après translation peuvent être restreints à un numéro de port 
particulier et ils peuvent être différents. 


232 


Translation d'adresses 

TRANSLATION STATIQUE 
• 
Dédier une adresse IP publique à un serveur interne (connexion 
sortante) 
Serveur mail 
sur le réseau interne 

Adresse source Port source Adresse source 
Port 
source 
@priv_mail 

+ @pub_mail 
Translation d’adresses1 2 
@pub_fw 
34 
@priv_mail any @pub_mail any 
Serveur mail sur Internet 
@internet 
Paquet original 1 Paquet translaté 

2 
Adresse Port Adresse Port 
Source Source Destination Destination 
@priv_mail xxxx @internet 25 


Adresse Port Adresse Port 
Source Source Destination Destination 
@pub_mail xxxx @internet 25 

Paquet translaté 4 Paquet original 

3 
xxxx@priv_mail 25@internet 
Port 
Destination 
Adresse 
Destination 
Port 
Source 
Adresse 
Source 
Adresse Port Adresse Port 
Source Source Destination Destination 
@internet 25 @pub_mail xxxx 

12 

La figure ci-dessus, illustre les modifications que subissent les paquets d’une 
connexion sortante initiée par le serveur web local vers un serveur sur internet en se 
basant sur la règle de translation qui fait la correspondance entre (l’adresse 
IP privée 
source « @priv_mail ») et (l’adresse 
IP source publique « @pub_mail »). 

Ainsi, le paquet émis par le serveur « @priv_mail » vers une adresse IP sur internet 
est modifié pour remplacer l’adresse 
source « @priv_mail » par l’adresse 
source 
« @pub_mail ». La réponse renvoyée par le serveur externe est aussi modifiée en 
conséquence avant d’􀄡tre 
renvoyée vers le serveur mail local. Il est important de 
noter que les ports source avant et après translation peuvent être restreints à un 
numéro de port particulier et ils peuvent être différents. 


233 


Translation d'adresses 

13 
TRANSLATION STATIQUE 
Serveur FTP 
@priv_ftp 
Serveur MAIL 
@priv_mail @pub_fw 
+ @pub_ftp 
+ @pub_mail 
Translation d’adresses•Dédier une adresse IP publique à un serveur interne 
Adresse 
source 
Port 
source 
Adresse 
destination 
Port destination 
Adresse 
source 
Port 
source 
Adresse 
destination 
Port 
destination 
@priv_mail Any Internet Any @pub_mail any 
Internet Any @pub_mail Any @priv_mail 
@priv_ftp Any Internet Any @pub_ftp Any 
internet Any @pub_ftp Any @priv_ftp 
Machine sur Internet 
@internet 
Si on dispose de plusieurs adresses IP publiques, il est possible de dédier pour 
chaque serveur une adresse IP spécifique. Chaque serveur nécessite deux règles de 
translation présentées ci-dessus. 


234 


Translation d'adresses 

TRANSLATION STATIQUE 
• 
Publication ARP des adresses IP publiques virtuelles 
@pub_fw ⇒@MAC_fw @MAC_R 

IP src IP dst 


Publication ARP 

@client @pub_mail Données 
Paquet IP 

Broadcast ARP (who 
has) : @pub_mail ? 

@pub_ftp ⇒@MAC_fw 
@pub_mail ⇒@MAC_fw 

Réponse 
213 
ARP (is 
at) : @pub_mail ⇒@MAC_fw 

MAC dst MAC src 

Paquet IP @MAC_fw @MAC_R 
Ether 
Type 
Trame Ethernet 

• 
ARP (Adress Resolution Protocol) : Récupérer dynamiquement 
l’adresse MAC de l’interface qui porte une certaine adresse IP. 
14 

Étant donné que les adresses IP publiques virtuelles ne sont pas configurées sur 
l’interface 
externe du firewall, ce dernier ne répondra pas aux requêtes ARP pour la 
résolution de ces adresses IP en adresse MAC du firewall. 

Afin de résoudre ce problème, la publication ARP des adresses IP publiques virtuelles 
est nécessaire pour le fonctionnement de la translation statique. Elle permet 
d’ajouter 
une entrée dans la table ARP du firewall pour faire la correspondance entre 
chaque adresse IP publique virtuelle et l’adresse 
MAC de l’interface 
externe. Ce qui 
permet au firewall de répondre aux requêtes ARP pour la résolution de ces adresses 
IP et de recevoir ainsi tous les paquets à leur destination comme l’illustre 
la figure ci-
dessus. 


235 


Translation d’adresses 

• 
Menu « NAT» 
➔
• 
Généralités 
• 
Translation dynamique 
• 
Translation statique par port 
• 
Translation statique 
• 
Ordre d’application des 
règles de NAT 
• 
Lab – 
Translation 
d’adresses 
Translation 
d’adresses 



236 


Translation d'adresses 

MENU « NAT » 
Politique de Filtrage et NAT 
(1) (2) (3) (4) (5) (6) (7) (8) (9) (10) 
Block all High Medium Low Filter 05 Filter 06 Filter 07 Filter 08 Pass all High Pass all 
Règles de Règles de 
Filtrage NAT 
16 


Dans les firewalls Stormshield Network, les règles de filtrage et NAT (translation 
d’adresses) sont regroupées sous une même politique. Il est possible de définir 10 
politiques différentes mais une seule politique est active à la fois, identifiée par 

l’icône : 


237 


Translation d'adresses 

17 
•Édition de la politique de sécurité 
MENU « NAT » 
La configuration des règles de filtrage et NAT s’effectue 
dans le 
menu CONFIGURATION ⇒POLITIQUE DE SÉCURITÉ ⇒Filtrage et NAT. 
L’ent􀄡te 
du menu permet : 

• 
La sélection de la politique de filtrage et NAT grâce à une liste déroulante. 
• 
Éditer : 
• 
Renommer : Modifier le nom de la politique. 
• 
Réinitialiser : Remettre les règles de filtrage et NAT par défaut. 
Attention car cette action ne peut pas se défaire. 
• 
Copier vers : Copier une politique vers une autre. 
• 
Exporter : Permet d’exporter 
les règles de filtrage/NAT de la politique 
sélectionnée dans un fichier CSV, cet export est utilisé pour récupérer les 
règles sur un serveur Stormshield Management Center (SMC). 
Le reste du menu est composé de deux onglets : 

• 
Filtrage : Pour la configuration des règles de filtrage. 
• 
NAT : Pour la configuration des règles de translation d’adresses. 
238 


Translation d'adresses 

18 
•Création d’une règle et entête 
MENU « NAT » 
L’onglet 
NAT est composé d’un 
entête pour la gestion des règles de translation: 

• 
Nouvelle règle : 
• 
Règle standard : Ajouter une règle de translation standard. 
• 
Règle de partage d’adresse 
source (masquerading) : Ajouter une règle 
pour la translation dynamique en précisant la plage de port 
ephemeral_fw. 
• 
Séparateur – 
regroupement de règles : Ajouter un séparateur qui 
regroupe toutes les règles se trouvant au dessous, ce qui permet de 
fermer le séparateur pour masquer l’affichage 
de toutes les règles lui 
appartenant. De plus, le séparateur peut être personnalisé par une 
couleur et un commentaire. 
• 
Règle de NAT statique (bimap) : Lancer un assistant qui facilite l’ajout 
de 
règles de translation statique bimap. 
• 
Supprimer : Supprimer la/les règle(s) sélectionnée(s). 
• 
Monter / Descendre : Monter ou descendre la/les règle(s) sélectionnée(s) d’une 
position dans la liste. 
• 
Tout dérouler / Tout fermer : Dérouler/fermer tous les séparateurs pour 
afficher/cacher les règles de NAT. 
• 
Couper : Couper la/les règle(s) sélectionnée(s). 
• 
Copier : Copier la/les règle(s) sélectionnée(s). 
• 
Coller : Coller la/les règle(s) auparavant copiée(s)/coupée(s) de la même ou 
d’une 
autre politique. 
• 
Chercher dans les logs : Chercher le nom de cette règle dans les journaux d’audit. 
• 
Chercher dans la supervision : Chercher le nom de cette règle dans la supervision 
des connexions. 
• 
Réinitialiser les statistiques des règles : Réinitialiser les compteurs de toutes les 
règles filtrage et NAT de la politique. En positionnant la souris sur l’icône, 
la date 
de la dernière réinitialisation s’affiche. 
• 
Réinitialiser Colonnes : Réinitialiser l’affichage 
des colonnes qui compose la 
fenêtre des règles. 
239 


Translation d'adresses 

• 
Trafic avant translation : Permet de renseigner les valeurs des paramètres 
du trafic original. 
• 
Source : L’adresse 
IP ou le réseau source. 
• 
Destination : L’adresse 
IP ou le réseau destination. 
• 
Port dest : Port destination. 
• 
Commentaire : Permet d’ajouter 
un commentaire. La date, l’heure, 
l’ad􀅵inistrateur 
et l’adresse 
IP du PC d’ad􀅵inistration 
sont ajoutés par 
défaut lors de la création de la règle. 
• 
Trafic après translation : Permet de renseigner les nouvelles valeurs des 
paramètres après translation. Dans le cas où cette partie n’est 
pas 
renseignée, le trafic gardera les valeurs originales. 
• 
Source : L’adresse 
IP ou le réseau source. 
• 
Port src : Port source. 
• 
Destination : L’adresse 
IP ou le réseau destination. 
• 
Port dest : Port destination. 
• 
Options : Le passage d’un 
flux par une règle de translation n’est 
pas 
journalisé en mode standard. En mode « Tracer », le trafic est journalisé 
dans le journal « Filtrage ». La seconde option permet aussi d’activer 
le 
NAT dans un tunnel VPN IPSec. 
• 
Commentaire : Permet d’ajouter 
un commentaire. La date, l’heure, 
l’ad􀅵inistrateur 
et l’adresse 
IP du PC d’ad􀅵inistration 
sont ajoutés par 
défaut lors de la création de la règle. 
240 


Translation d'adresses 

20 
•Indicateur d’utilisationdesrèglesde NAT•Sauvegardeet activation d’unepolitiquede sécuritéMENU « NAT » 
L’indicateur d’utilisation (encadré en bleu) précise le nombre de fois où un flux traité 
correspond aux critères de la règle de translation. Le compteur numérique s’affiche 
en passant la souris par dessus. Il peut afficher 4 couleurs qui sont le résultat d’un 
rapport mathématique entre le nombre de hits de la règle et le nombre de hits 
maximum atteint par une règle dans le même slot: 

• 
Blanc (vide) : la règle n’a jamais été appliquée. 
• 
Bleue : la valeur affichée est comprise entre 0 et 2% du hit maximal. 
• 
Vert : la valeur affichée est comprise entre 2% et 20% du hit maximal. 
• 
Orange : la valeur affichée est supérieure ou égale à 20% du hit maximal 
et est supérieure à 10 000 hits. 
Pour sauvegarder une politique, il suffit de cliquer sur le bouton APPLIQUER. La 
sauvegarde est immédiate, une nouvelle fenêtre s’ouvre, permettant par ailleurs de 
rendre la politique active, ou pas, en cliquant sur le bouton OUI, ACTIVER LA 
POLITIQUE, ou PLUS TARD. 


241 


Translation d'adresses 

21 
MENU « NAT » 
•Affichage des colonnes 
L’affichage 
des colonnes de la fenêtre peut être personnalisé en cliquant sur l’icône 
indiquée par la flèche bleue ci-dessus, ensuite sur colonnes. Il suffit de sélectionner 
une colonne pour 􀆋u’elle 
s’affiche. 
Les règles de NAT peuvent être déplacées dans la fenêtre par un glisser/déposer en 
cliquant à gauche sur le numéro de la règle. 

NOTE : La recherche dans les logs ou la supervision s’effectuant 
sur le nom d’une 
règle, vous pouvez afficher la colonne Nom, remarquez alors 􀆋u’une 
règle a 
forcément un nom par défaut, modifiable par l’ad􀅵inistrateur. 


242 


Translation d'adresses 

22 
•Paramètres d’une règle 
MENU « NAT » 
Les paramètres d’une 
règle peuvent être renseignés directement dans la fenêtre des 
règles ou sur une nouvelle fenêtre qui s’affiche 
en double cliquant sur n’i􀅵porte 
quel 
paramètre de cette règle. Cette fenêtre permet aussi l’accès 
aux paramètres de 
configuration avancée. 
Les valeurs des paramètres étant des objets, ils peuvent être copiés d’une 
règle à 
une autre par un simple glisser/déposer. 


243 


Translation d'adresses 

23 
•Translation dynamique 
MENU « NAT » 
La règle de NAT dynamique est créée avec le bouton Nouvelle règle ⇒ 
règle de 
partage d’adresse 
source (masquerading) qui ajoute automatiquement la plage de 
ports ephemeral_fw en tant que port src dans le trafic après translation. 

La figure ci-dessus présente un exemple d’une 
règle de NAT dynamique avec les 
principaux paramètres qui doivent être renseignés. Dans la section Trafic original 
(avant translation), la source représente le réseau interne Network_in accessible 
depuis l’interface 
« in » qui veut accéder à n’i􀅵porte 
quelle destination sur 
n’i􀅵porte 
quel port destination. Dans la section Trafic après translation, la source 
est modifiée par l’adresse 
IP publique portée par l’interface 
« out » et le port source 
est translaté part un numéro de port dans la plage ephemeral_fw. 

Il est conseillé de cocher l’option 
choisir aléatoirement le port source translaté qui 
permet de choisir aléatoirement un numéro de port dans la plage ephemeral_fw 
pour les nouvelles connexions. Cette option offre une protection contre certaines 
attaques en rendant le port translaté moins prédictible. 


244 


Translation d'adresses 

24 
•Translation statique par port 
MENU « NAT » 
La règle de NAT statique par port est créée à partir d’une 
règle standard. Un exemple 
est présenté dans la figure ci-dessus. 
Dans la section Trafic original, la source représente n’i􀅵porte 
quelle machine sur le 
réseau public, ayant pour destination l'adresse IP publique du firewall sur le port 80 
(HTTP). Dans la section trafic après translation, l'adresse IP destination est 
remplacée par l’adresse 
IP privée du serveur et le numéro de port 80 (HTTP) est 
maintenu comme port destination. Il est important de noter que les ports 
destination avant et après translation peuvent être différents. 


245 


Translation d'adresses 

25 
•Translation statique 
MENU « NAT » 
Les règles de NAT statiques sont créées avec Nouvelle règle ⇒règle de NAT statique 
(bimap) qui lance un assistant pour renseigner les informations suivantes : 

• 
Machine(s) privée(s) :L’adresse IP privée du serveur en interne 
• 
Machine(s) virtuelle(s) :L’adresse IP publique virtuelle dédiée au serveur 
interne 
• 
Uniquement sur l’interface :L’interface externe depuis laquelle le serveur 
est accessible avec son adresse IP publique virtuelle. 
• 
Uniquement pour les ports : La règle de NAT statique permet de translater 
tous les ports, cependant, il est possible de la restreindre en spécifiant un 
port ou une plage de ports sur ce paramètre. Il est conseillé de laisser 
cette valeur à Any et de restreindre le port directement dans les règles de 
filtrage. 
• 
publication ARP : Activer la publication ARP pour l’adresse IP publique. 
L’exemple illustré dans la figure ci-dessus translate statiquement un serveur SMTP 
interne identifié par une adresse IP privée srv_mail_priv et une adresse IP publique 
virtuelle dédiée srv_mail_pub. 
L’assistant ajoute deux règles de translation. La première règle pour la translation du 
flux sortant du serveur interne vers le réseau public et la deuxième pour le flux 
entrant à destination de l’adresse IP publique virtuelle. Les deux règles peuvent être 
modifiées par la suite indépendamment l’une de l’autre. 
246 


Translation d’adresses 

• 
Ordre d’application des règles de NAT 
➔
• 
Généralités 
• 
Translation dynamique 
• 
Translation statique par port 
• 
Translation statique 
• 
Menu « NAT » 
• 
Lab – 
Translation d’adresses 
Translation 
d’adresses 



247 


Translation d'adresses 

27 
ORDRE D’APPLICATIONDES RÈGLES DE NAT
L’ordre d’apparition des règles de translation dans la liste est très important, il définit 
l’ordre dans lequel les nouvelles connexions sont confrontées aux règles de 
translation. Ainsi, une nouvelle connexion est confrontée aux règles en partant de la 
première dans la liste jusqu’à la dernière. Dans le cas où la connexion correspond à 
une règle, la translation définie par cette règle est appliquée et la connexion n’est 
plus confrontée aux règles suivantes. 

Ce principe de fonctionnement peut engendrer une situation de recouvrement si les 
règles ne sont pas ordonnées d’une manière cohérente. Un exemple est illustré dans 
la figure ci-dessus, la deuxième règle de translation ne sera jamais utilisée parce 
qu’elle est recouverte par une règle plus globale située au-dessus dans la liste (Les 
réseaux présents dans le groupe IP_PUB sont inclus dans l'objet Internet). 
Le firewall embarque un moteur de cohérence permettant de détecter ce type de 
recouvrement qui est signalé à l’administrateur par un message d’alerte affiché en 
bas de fenêtre. 

NOTE : Une solution simple pour cet exemple consiste à inverser l’ordre des deux 
règles de translation. 


248 


Translation d'adresses 

RECOMMANDATIONS DE SÉCURITÉ 
• 
Renommer la politique de production 
• 
Eviter les chevauchements de règles 
• 
Ne pas laisser de règle inutilisée 
28 

Afin de clarifier la lecture des politiques de filtrage, il est recommandé de les 
nommer explicitement en suivant une convention de nommage précise. 

Il est recommandé de ne jamais laisser des règles se recouvrir. Outre l’inutilité 
de la 
règle recouverte, cela pourrait mener à laisser des points d’entrée 
en cas de 
suppression de la règle couvrante. 

Toute règle inutile laisse un point d’entrée 
potentiel et augmente la surface 
d’atta􀆋ue. Elles sont donc à traquer et supprimer régulièrement. 


249 


Translation d'adresses 

29 
Pour aller plus loin, consultez les ressources du site documentation.stormshield.eu : 

• 
Note technique -Mise en oeuvre 
d'une règle de NAT 
Et pour les situations/questions très spécifiques, consultez la base de connaissance du TAC 
kb.stormshield.eu. 


250 


Translation d’adresses 
Lab 

• 
Lab – 
Translation d’adresses 
➔
• 
Généralités 
• 
Translation dynamique 
• 
Translation statique par port 
• 
Translation statique 
• 
Menu « NAT » 
• 
Ordre d’application des 
règles de NAT 
Translation d’adresses 


251 


Translation d’adresses 


Lab 

Lab 4 – 
Translation d’adresses 

LAB -TRANSLATIOND’ADRESSES
Company B Private Network_in 

Company A Private Network_in 

192.168.2.0/24 

192.168.1.0/24 

192.36.253.10 192.36.253.20 
172.16.1.254 172.16.2.254 
192.36.253.1 
172.16.2.0/24 Company A Private Network_dmz1 
172.16.1.0/24 
Inter-Company public Network 
192.36.253.0/24 

192.168.1.254 192.168.2.254 

Company B Private Network_dmz1 


2 

Pour ce LAB, nous considérons le réseau externe inter-entreprises comme un réseau public dans 
lequel aucune adresse IP privée n’est tolérée. 

1. Désactivez les routes statiques ajoutées dans le lab précédent. 
2. Copiez la politique de filtrage/NAT (10) Pass all vers la politique numéro 4. Renommez la 
politique numéro 4 « Lab_4 ». Ensuite, activez cette politique. 
3. Ajoutez une règle de NAT afin que les machines de vos réseaux internes puissent accéder à 
Internet sans que leur IP privée n’y soit vue. Ensuite, testez l’accès à Internet depuis votre poste. 
4. Vous disposez de 2 adresses IP publiques supplémentaires « 192.36.253.x2 » et 
« 192.36.253.x3 » réservées respectivement à vos serveurs FTP et MAIL situés en DMZ. Ajoutez 
les règles de NAT statique (bimap) qui permettent de joindre chaque serveur depuis le réseau 
externe grâce à son adresse IP publique. 
5. Ajoutez une règle de NAT statique par port afin que votre serveur WEB situé en DMZ soit 
joignable grâce à une redirection de port via l’adresse IP publique portée par votre firewall 
« 192.36.253.x0 ». 
6. Avec l’autre entreprise, testez l'accès à l'ensemble des ressources (le serveur MAIL peut être 
testé à l’aide d’une commande TELNET). 
Bonus : 

• 
Ajoutez une règle de NAT afin que les machines de votre réseau interne puissent accéder à vos 
serveurs en DMZ sans que leur adresse IP privée n’y soit vue. 
• 
Quels sont les avantages et inconvénients selon vous de translater les adresses depuis votre 
réseau interne vers votre DMZ, laquelle est aussi un réseau interne ? 
252 



Translation d’adresses 





264 


Filtrage 

•Généralités 
•La notion de « stateful » 
•L’ordonnance􀅵entdes règles de filtrage etde translation 
•Menus « filtrage » 
•L’analyseur de cohérence etde confor􀅵ité•Lab -Filtrage 
Filtrage 
➔
265 


Filtrage 

3 
GÉNÉRALITÉS 
•Définition des flux autorisés et/ou bloqués par le firewall 
•Critèresd’applicationde larègle•Inspections de sécurité selon les flux 
Grâce à la politique de filtrage, l’administrateur est capable de définir les règles qui 
permettront d’autoriser ou de bloquer les flux au travers du firewall Stormshield 
Network. Selon les flux, certaines inspections de sécurité (analyse antivirale, analyse 
antispam, filtrage URL, …) peuvent être activées (nous détaillerons ces analyses dans le 
module « Protection applicative »). Les règles de filtrage définies doivent respecter la 
politique de sécurité de l’entreprise. 

Pour définir un flux, une règle de filtrage se base sur de nombreux critères ; ce qui offre 
un haut niveau de granularité. Parmi ces critères, il est notamment possible de préciser : 

• 
L’adresse IP source et/ou destination, 
• 
La réputation et la géolocalisation de l’adresse IP source et/ou destination, 
• 
L’interface d’entrée et/ou sortie, 
• 
L’adresse réseau source et/ou destination, 
• 
Le FQDN source et/ou destination, 
• 
La valeur du champ DSCP, 
• 
Le service TCP/UDP/SCTP (n° de port de destination), 
• 
Le protocole IP (dans le cas d’ICMP, le type de message ICMP peut être 
précisé), 
• 
L’utilisateur ou le groupe d’utilisateurs devant être authentifié. 
Le nombre de règles de filtrage actives dans une politique est limité. Cette limite 
dépend du modèle de firewall. Le premier paquet appartenant à chaque nouveau flux 
reçu par le firewall est confronté aux règles de filtrage de la première à la dernière ligne. 
Il est donc recommandé d’ordonner au mieux les règles de la plus restrictive à la plus 
généraliste. 
Par défaut, tout trafic qui n’est pas autorisé explicitement par une règle de filtrage est 
bloqué. 

266 



Filtrage 

•Généralités 
•La notion de « stateful » 
•L’ordonnance􀅵entdes règles de filtrage etde translation 
•Menus « filtrage » 
•L’analyseur de cohérence etde confor􀅵ité•Lab -Filtrage 
Filtrage 
➔
267 


Filtrage 

LA NOTION DE « STATEFUL » 
requête 
réponse 
1 
2 
Échanges 
TCP, UDP, SCTP, ICMP 
Adresse 
source 
Port 
source 
Adresse 
destination 
Port 
destination 
@privA xxxx @web 80 @web 
5 

Les firewalls Stormshield Network utilisent la technologie SPI (Stateful Packet 
Inspection) qui leur permet de garder en mémoire l’état des connexions TCP, SCTP et 
des pseudo-connexions UDP et ICMP afin d’en assurer le suivi et de détecter 
d’éventuelles anomalies ou attaques. La conséquence directe de ce suivi « Stateful » 
est l’autorisation d’un flux par une règle de filtrage uniquement dans le sens de 
l’initiation de la connexion ; les réponses faisant partie de la même connexion sont 
implicitement autorisées. Ainsi, nous n’avons nul besoin d’une règle de filtrage 
supplémentaire pour autoriser les paquets réponse d’une connexion établie au 
travers du firewall. 


268 


Filtrage 

•Généralités 
•La notion de « stateful » 
•L’ordonnancement des règles de filtrage et de 
translation 
•Menus « filtrage » 
•L’analyseur de cohérence et de conformité 
•Lab -Filtrage 
Filtrage 
➔
269 


Filtrage 

L’ORDONNANCEMENTDES RÈGLES DE FILTRAGE ETDE TRANSLATION
7 
Passer 
Paquet initial 
P 
R 
I 
O 
R 
I 
T 
É 
Bloquer 
Bloquer 
Bloquer 
N/A 
Passer 
Bloquer 
Action 
de 
NAT 
NO 
NAT 
Passer 
N/A 
N/A 
N/A 
N/A 
N/A 
Règle applicable 
Règle applicable 
Règle applicable 
Filtrage 
Implicite 
0 
Filtrage 
Global 
1 
Filtrage 
Local 
2 
NAT 
Implicite 
3 
NAT 
Global 
4 
NAT 
Local 
5 
Dans les firewalls Stormshield Network, les règles de filtrage et de NAT sont 
organisées en différents niveaux appelés « slot » représentés selon leur priorité dans 
la figure ci-dessus : 

• 
Le filtrage implicite : Regroupe les règles de filtrage préconfigurées ou 
ajoutées dynamiquement par le firewall pour autoriser ou bloquer certains 
flux après l’activation 
d’un 
service. Par exemple, une règle implicite 
autorise les connexions à destination des interfaces internes de l’UTM 
sur 
le port HTTPS (443/TCP) afin d’assurer 
un accès continu à l’interface 
d’ad􀅵inistration 
Web. Autre exemple, dès l’activation 
du service SSH, un 
ensemble de règles implicites sera ajouté pour autoriser ces connexions 
depuis toutes les machines des réseaux internes. 
• 
Le filtrage global : Regroupe les règles de filtrage injectées au firewall 
depuis l’outil 
d’ad􀅵inistration 
« Stormshield Management Server » (SMC) 
ou après affichage des politiques globales. 
• 
Le filtrage local : Représente les règles de filtrage ajoutées par 
l’ad􀅵inistrateur 
depuis l’interface 
d’ad􀅵inistration. 
• 
Le NAT implicite : Regroupe les règles de NAT ajoutées dynamiquement 
par le firewall. Ces règles sont utilisées principalement lors de l’activation 
de la haute disponibilité. 
• 
Le NAT global : À l’instar 
du filtrage global, il regroupe les règle de NAT 
injectées au firewall depuis l’outil 
d’ad􀅵inistration 
« Stormshield 
Management Server » (SMC) ou après affichage des politiques globales. 
• 
Le NAT local : Regroupe les règles de NAT ajoutées par l’ad􀅵inistrateur 
depuis l’interface 
d’ad􀅵inistration. 
270 


Filtrage 

•Généralités 
•La notion de « stateful » 
•L’ordonnancement des règles de filtrage et de translation 
•Menus « filtrage » 
L’analyseur de cohérence et de conformité 
•Lab -Filtrage 
Filtrage 
➔
271 


Filtrage 

9 
MENUS « FILTRAGE » 
Les règles implicites sont accessibles depuis le menu CONFIGURATION ⇒POLITIQUE 
DE SÉCURITÉ ⇒Règles implicites. Chaque règle peut être activée/désactivée. 

NOTE : La modification de l’état 
de ces règles a un impact direct sur le 
fonctionnement des services du firewall. Pour que le service concerné fonctionne 
toujours, il faut s’assurer 
au préalable que le flux est autorisé par les règles de 
priorité moindre telles que globales ou locales. 


272 


Filtrage 

10 
MENUS « FILTRAGE » 
•Affichage des règles globales 
Pour afficher les règles globales, il faut cocher l’option 
Afficher les politiques 
globales (Filtrage, NAT, VPN IPsec et Objets) dans le menu Préférences accessible 
directement depuis l’icône 
de l’en-tête encadré en rouge. Cette option fait 
apparaître dans l’en-tête du menu CONFIGURATION ⇒ 
POLITIQUE DE SÉCURITÉ ⇒ 
Filtrage et NAT une liste déroulante qui permet de sélectionner les politiques 
globales ou locales. Par défaut, aucune règle de filtrage et NAT n’est 
présente dans 
les slots globaux. 


273 


Filtrage 

11 
MENUS « FILTRAGE » 
•Créationd’unerègle•Ajout, édition et colorisation de séparateurs 
•Choix des colonnes affichées 
Les règles de filtrage font partie d’une politique présentée précédemment dans le 
module « Translation d’adresses ». 
L’onglet FILTRAGE est composé d’un en-tête pour la gestion des règles de filtrage: 

• 
Nouvelle règle : 
• 
Règle simple : Ajouter une règle de filtrage standard. Par défaut, 
une nouvelle règle est désactivée et tous ses critères sont 
paramétrés à Any. 
• 
Séparateur – 
regroupement de règles : Ajouter un séparateur qui 
regroupe toutes les règles se trouvant au-dessous (ou jusqu’au 
prochain séparateur). Cela permet de faciliter l’affichage d’une 
politique contenant un nombre de règles important. Le séparateur 
peut être personnalisé par une couleur et un commentaire. 
• 
Règle d’authentification : Démarrer un assistant facilitant l’ajout 
d’une règle dont le rôle est de rediriger les connexions des 
utilisateurs non-authentifiés vers le portail captif (voir module 
« Utilisateurs et Authentification » pour plus de détails à ce sujet). 
• 
Règle d’inspection SSL : Démarrer un assistant qui facilite l’ajout de 
règles pour l’activation du proxy SSL. 
• 
Règle de proxy HTTP explicite : Démarrer un assistant qui facilite 
l’ajout de règles pour l’activation du proxy HTTP explicite. 
• 
Supprimer : Supprimer une règle. 
• 
Monter / Descendre : Monter ou descendre la/les règle(s) sélectionnée(s) 
d’une position dans la liste. 
274 


Filtrage 

12 
MENUS « FILTRAGE » 
•Nommage des règles 
•Options d’en-tête 
• 
Tout dérouler / Tout fermer : Dérouler/Fermer tous les séparateurs pour 
afficher/cacher les règles de filtrage. 
• 
Couper : Couper la/les règle(s) sélectionnée(s). 
• 
Copier : Copier la/les règle(s) sélectionnée(s). 
• 
Coller : Coller la/les règle(s) auparavant copiée(s)/coupée(s) de la même 
ou d’une 
autre politique. 
• 
Chercher dans les logs : Chercher les traces générées par l’application 
de 
cette règle dans les journaux d’audit 
(la recherche s’effectue 
sur le nom de 
la règle). 
• 
Chercher dans la supervision : Chercher le nom de cette règle dans la 
supervision des connexions. 
• 
Réinitialiser les statistiques des règles : Réinitialiser les compteurs 
d’utilisation 
de toutes les règles de filtrage et NAT de la politique active. La 
date de la dernière réinitialisation s’affiche 
en positionnant la souris sur 
l’icône. 
• 
Reinit Colonnes : Réinitialiser l’affichage 
des colonnes qui composent la 
fenêtre des règles comme le prévoit l’affichage 
par défaut. 
NOTE : A la création d’une 
règle, le système lui attribue un nom (par exemple: 
1828cd033db_6) modifiable et même supprimable par l’ad􀅵inistrateur. Bien que la 
colonne concernée soit cachée par défaut, c’est 
sur ce nom que s’effectue 
la 
recherche dans les logs ou la supervision. Il est par conséquent judicieux de donner à 
la règle un nom explicite. Plusieurs règles peuvent porter le même nom, ce qui peut-
être utile à des fins de regroupement. 


275 


Filtrage 

13 
MENUS « FILTRAGE » 
•Indicateur d’utilisationdesrèglesde filtrage•Compositiond’unerègle defiltrage
La fenêtre des règles est composée de plusieurs colonnes listées ci-dessous : 

• 
Numéro de la règle et un indicateur (encadré en bleu) sur le nombre de 
fois où les éléments du paquet reçu correspondent aux critères de la règle 
de filtrage. Le compteur numérique s’affiche en passant la souris par 
dessus. Il peut afficher 4 couleurs qui sont le résultat d’un rapport 
mathématique entre le nombre de hits de la règle et le nombre de hits 
maximum atteint par une règle dans le même slot: 
• 
Blanc (vide) : la règle n’a jamais été appliquée, 
• 
Bleue : la valeur affichée est comprise entre 0 et 2% du hit 
maximal, 
• 
Vert : la valeur affichée est comprise entre 2% et 20% du hit 
maximal, 
• 
Orange : la valeur affichée est supérieure ou égale à 20% du hit 
maximal et est supérieure à 10 000 hits. 
• 
État : Permet d’activer/désactiver une règle de filtrage. 
• 
Action : Indique l’action appliquée sur la connexion : passer, bloquer, 
tracer, renvoyer vers un portail captif, etc. 
• 
Source : Spécifie la source du trafic : adresse IP ou réseau source, interface 
d’entrée, utilisateur, etc. 
• 
Destination : Spécifie la destination du trafic : adresse IP ou réseau 
destination, interface de sortie. 
• 
Port de dest : Indique le port destination du trafic. 
276 


Filtrage 

14 
MENUS « FILTRAGE » 
•OmniBox pour éditer tous les champs de la règle à la 
fois 
Les paramètres d’une 
règle peuvent être renseignés directement dans la fenêtre des 
règles ou sur une nouvelle fenêtre (omnibox) qui s’affiche 
en double cliquant sur 
n’i􀅵porte 
quel paramètre de cette règle. 

Les valeurs des paramètres étant des objets, ils peuvent être copiés d’une 
règle à 
une autre par un simple glisser/déposer. Ce procédé permet également de déplacer 
les règles de filtrage en cliquant à gauche sur le numéro de la règle. Enfin, les 
nouvelles règles ajoutées doivent être sauvegardées et activées explicitement avec 
le bouton Sauvegarder et activer. 


277 


Filtrage 

15 
MENUS « FILTRAGE » 
•MenuAction: définitiondel’action
Le menu ACTION est constitué de plusieurs onglets, nous nous intéresserons 
principalement à l’onglet GÉNÉRAL qui permet de spécifier les paramètres suivants : 

• 
Action : Définit l’action à appliquer au paquet correspondant à la règle de 
filtrage : 
• 
passer : Autorise le paquet, 
• 
bloquer : Bloque le paquet, 
• 
déchiffrer : Renvoie le paquet vers le proxy SSL, 
• 
réinit. TCP/UDP : Dans le cas d’un trafic TCP, le firewall renvoie un 
paquet « TCP RST » à l’émetteur. Dans le cas d’un trafic UDP, le 
firewall renvoie une notification ICMP port inaccessible (port 
unreachable) à l’émetteur. 
278 


Filtrage 

16 
MENUS « FILTRAGE » 
•Menu Action : définition du niveau de trace 
• 
Niveau de trace : Permet de tracer les flux traités par la règle. Il peut avoir 
plusieurs valeurs : 
• 
standard (journal de connexions) : C’est 
la valeur par défaut, 
seules les connexions établies ayant leur couche de transport en 
TCP/UDP sont journalisées : 
• 
Dans le journal « Connexions réseau » ou dans le journal 
« Connexions applicatives » si une analyse applicative est 
menée par un plugin (en mode IPS, IDS), 
• 
Les connexions avec action « Bloquer » ne sont pas 
journalisées. 
• 
avancé (journal de filtrage) : Les flux sont tracés dans le journal 
« Filtrage ». Cette option n’est 
utile que pour : 
• 
Journaliser des flux directement au-dessus d’IP 
(ICMP, GRE, 
ESP,…), 
• 
Journaliser le blocage d’un 
flux par l’action 
« Bloquer ». 
• 
alarme mineure : La connexion est tracée dans le journal 
« Alarmes » avec une alarme mineure. 
• 
alarme majeure : La connexion est tracée dans le journal 
« Alarmes » avec une alarme majeure. 
NOTE : L’utilisation 
du mode verbeux sur une connexion en TCP/UDP est non 
seulement inutile, mais crée des doublons avec une écriture dans un des journaux 
de connexions et une écriture dans le journal de filtrage pour le même flux. 


279 


Filtrage 

17 
MENUS « FILTRAGE » 
•Menu Action : Programmation horaire et routage par 
politique 
• 
Programmation horaire : Sélection d’un objet temps qui permet de définir 
des plages horaires hebdomadaires, des évènements annuels ou 
ponctuels. Les objets temps peuvent être créés dans le menu 
CONFIGURATION ⇒OBJETS ⇒Objets temps ou en cliquant sur le bouton 
encadré en bleu. Si ce paramètre est renseigné, la règle de filtrage sera 
active uniquement durant la plage horaire définie par l’objet temps. 
• 
Passerelle – 
routeur : Ce paramètre permet de mettre en oeuvre 
le 
routage par politique (présenté dans le module « Configuration réseau »). 
Dès lors qu’une passerelle est renseignée, tout le trafic traité par cette 
règle de filtrage sera transmis à cette passerelle et non à la passerelle par 
défaut si aucune autre directive de routage plus prioritaire n’est 
configurée. 
280 


Filtrage 

18 
MENUS « FILTRAGE » 
•Menu Source : onglet général 
Le menu Source ⇒ 
GÉNÉRAL regroupe les paramètres qui identifient la source du 
trafic concerné par la règle de filtrage : 

• 
Utilisateur : Permet de renseigner l’utilisateur 
ou le groupe d’utilisateurs 
qui est à l’origine 
du trafic. Ce paramètre est fonctionnel dans le cadre 
d’un 
système d’authentification 
basé sur un annuaire utilisateurs (voir 
module « Utilisateurs et Authentification »). 
• 
Machines sources : Indique l’adresse 
IP, le Fully Qualified Domain Name 
(FQDN) ou l’adresse 
réseau du trafic. Les icônes « = » ou « ≠ 
» signifient 
que le paramètre peut être égal ou différent de la valeur spécifiée. De 
plus, il est possible de renseigner une liste d’objets 
en cliquant sur le 
bouton Ajouter, le coin rouge en haut à gauche des objets ajoutés signifie 
que cet ajout n’a 
pas encore été sauvegardé. 
• 
Interface d’entrée 
: Permet de préciser l’interface 
d’entrée 
du trafic. Ce 
paramètre est utile dans le cas des bridges où les interfaces partagent le 
même plan d’adressage. 
281 


Filtrage 

19 
MENUS « FILTRAGE » 
•Menu Source : onglet géolocalisation et réputation 
Le menu Source ⇒ 
GÉOLOCALISATION / RÉPUTATION regroupe les paramètres 
suivants : 

• 
Géolocalisation : Permet de renseigner un continent ou un pays à l’origine 
du trafic. La liste ne contient pas d’adresses IP, le Firewall détermine le 
pays auquel appartient une IP, plutôt que de charger toutes les IP (les 
blocs d’adressage sont très fragmentés sur Internet). 
• 
Réputation des adresses IP publiques : Une IP publique peut avoir une 
réputation à la limite de deux catégories. Le groupe « Bad » regroupe les 
catégories : anonymizer, botnet, malware, phishing, scanner, spam et tor. 
• 
Réputation des machines : Il est possible d’activer le filtrage selon le score 
de réputation des machines du réseau interne. Il faut au préalable activer 
la gestion de réputation des machines et définir les machines concernées 
par le calcul d'un score de réputation, ce point est détaillé dans les 
annexes. 
Dans le menu Source, les paramètres Géolocalisation et Réputation des adresses IP 
publiques sont utilisés généralement pour qualifier le flux entrant (provenant 
d’Internet), alors que le paramètre Réputation des machines est utilisé pour 
qualifier le flux sortant. 

NOTE : Le score de réputation des machines internes, configurable dans ce menu, 
permet de préciser le score au-dessus duquel ou en-dessous duquel la règle de 
filtrage s'appliquera aux machines supervisées. 


282 


Filtrage 

20 
MENUS « FILTRAGE » 
•Menu Destination : onglet général 
Le menu Destination regroupe les paramètres qui identifient la destination du trafic. 
Dans l’onglet 
GÉNÉRAL, le paramètre Machines destination indique l’adresse 
IP, 
l’adresse 
réseau ou le FQDN destination du trafic. Nous pouvons également choisir si 
le paramètre doit être égal ou différent de la valeur et renseigner une liste d’objets. 

La géolocalisation et la réputation des adresses IP publiques ainsi que la réputation 
des machines peuvent être utilisées également dans les paramètres de destination 
depuis l’onglet 
GÉOLOCALISATION / RÉPUTATION. 

NOTE : Lorsque l’objet 
de destination est un objet FQDN, il doit être le seul objet de 
la liste. 


283 


Filtrage 

21 
MENUS « FILTRAGE » 
•Menu Destination : configuration avancée 
Dans l’onglet CONFIGURATION AVANCÉE, nous pouvons restreindre l’application de 
la règle uniquement au trafic sortant par l’interface indiquée dans interface de 
sortie . 

NOTE : Pour les règles autorisant un flux sortant vers Internet, il n’est pas conseillé 
de renseigner l’interface de sortie car la route à emprunter pour joindre la 
destination du flux n’est pas encore connue dans le cas où on utilise plusieurs 
passerelles (objet routeur). 


284 


Filtrage 

22 
MENUS « FILTRAGE » 
•Menu Port –Protocole : définition d’un port 
Le menu PORT / PROTOCOLE permet de renseigner le Port destination avec la 
possibilité de choisir s’il 
doit être égal, différent, inférieur ou supérieur à la valeur 
sélectionnée. Il est également possible de renseigner une liste de ports de 
destination. 


285 


Filtrage 

23 
MENUS « FILTRAGE » 
•Menu Port –Protocole : définitiond’unprotocole
Le menu PORT / PROTOCOLE permet également de spécifier le protocole IP 
concerné par la règle de filtrage. Pour cela, il faut sélectionner le paramètre Type de 
protocole et choisir la valeur Protocole IP, puis préciser le protocole dans le champ 
Protocole IP. Si le protocole ICMP est sélectionné, le paramètre Message 
ICMP s’affiche automatiquement pour permettre d’affiner le filtrage en choisissant le 
type de notification ICMP concerné par la règle de filtrage. 

NOTE : Le suivi des états « stateful » qui permet de mémoriser et de suivre les 
connexions traversant le firewall est activé et figé (non modifiable) uniquement pour 
les protocoles TCP, UDP et ICMP. Pour les autres protocoles (GRE, ESP, etc.), il faut 
cocher cette option pour activer le suivi. 


286 


Filtrage 

24 
MENUS « FILTRAGE » 
•Règle de filtrage avec NAT sur destination 
Dans une règle de filtrage, une directive de NAT sur la destination (DNAT) peut être 
appliquée, sauf si elle contient un objet FQDN, ou des éléments de géolocalisation 
et /ou de réputation. 

Exemple : La figure ci-dessus illustre une translation sur la destination d’un trafic 
SMTP entrant. La règle de filtrage autorise ce trafic en provenance d’un 
réseau 
externe et à destination de l’adresse 
IP publique du serveur STMP sur le port 
SMTP/25. L’adresse 
et le port destination sont translatés respectivement par 
l’adresse 
IP privée du serveur SMTP et le port SMTP/25 directement dans la règle de 
filtrage où la publication ARP est également activée. Grâce à cette configuration, il 
n’est 
pas nécessaire d’ajouter 
une règle de translation pour rediriger ce trafic. 

Il existe plusieurs avantages à créer une directive de NAT sur destination au sein 
d’une 
règle de filtrage: 

• 
Indication rapide du flux autorisé avec redirection vers la machine interne, 
• 
Gestion et supervision des règles entrantes dans un seul menu, 
• 
Optimisation du temps de traitement des règles puisque les règles 
présentes dans l’onglet 
NAT ne sont pas parcourues, 
• 
Activation de protections applicatives (filtrage SMTP, antispam, etc.) à des 
connexions entrantes translatées. 
287 


Filtrage 

•Généralités 
•La notion de « stateful » 
•L’ordonnance􀅵entdes règles de filtrage etde translation 
•Menus « filtrage » 
•L’analyseur de cohérence et de confor􀅵itéLab -Filtrage 
Filtrage 
➔
288 


Filtrage 

26 
L’ANALYSEUR DE COHÉRENCE ET DE CONFORMITÉ 
Les firewalls Stormshield Network embarquent un moteur de vérification qui permet 
de détecter d’éventuelles 
situations de recouvrement ou d’incohérence 
créées dans 
la politique de filtrage. Ce type de situation est signalé par un message 
d’avertisse􀅵ent 
en bas du menu. 
Trois exemples sont illustrés dans la figure ci-dessus : 

• 
Dans la règle n°1, le port destination HTTP est incompatible avec le 
protocole UDP parce que le protocole applicatif HTTP utilise le protocole 
de transport TCP, 
• 
La règle n°3 ne sera jamais utilisée parce 􀆋u’elle 
est recouverte par la règle 
n°2, 
• 
La règle n°4 souligne que le flux arrive sur un objet dont l’IP 
peut changer 
(IP dynamique associée à la patte out), et 􀆋u’il 
faut préciser l’interface 
d’entrée 
(dans le champ source). 
NOTE : Les messages signalés avec une croix rouge bloquent la sauvegarde et 
l’activation 
de la politique. 


289 


Filtrage 

RECOMMANDATIONS 
• 
Compléter lesrèglesd’antispoofing par du filtrage 
• 
Désactiver les règles implicites excepté la règle HA 
• 
Utiliser des 
groupes 
d’objets 
• 
Supprimer les règles qui se chevauchent ou inutiles 
• 
Nommer les règles 
27 

L’antispoofing a ses limites et ne bloque pas les réseaux privés arrivant par internet 
par exemple. Il est donc nécessaire de compléter la protection avec des règles de 
blocage déduites de la topologie du réseau. Par exemple bloquer les IP RFC5735 sur 
les réseaux publics. 

Les règles implicites étant évaluées avant les autres, elle peuvent rendre inopérantes 
des règles créées par l’administrateur. Attention à bien préparer les règles 
d’autorisation d’accès à l’interface web pour ne pas perdre la main sur le firewall. Le 
SSH vers le SNS étant accessible par défaut sur toutes les interfaces internes, c’est 
l’occasion de le limiter. 
La règle implicite pour la haute disponibilité ne peut pas être créée explicitement via 
l’interface web, le plugin ASQ correspondant n’étant pas disponible (protocole 
hasync). 

Les groupes d’objets simplifient la modification des règles. Il est recommandé 
d’utiliser des groupes plutôt que de créer des listes de machines dans les règles. Cela 
améliore aussi la lisibilité. 

Tout comme pour les NAT, il est recommandé de ne jamais laisser des règles se 
recouvrir. De même, il faut traquer et supprimer régulièrement toutes les règles 
inutilisées. 

La colonne (par défaut cachée) nom permet d’identifier une règle par son nom, c’est 
un filtre puissant pour rechercher une règle ou pour suivre son comportement en 
débogage. 


290 


Filtrage 

28 
Vous trouverez ci-dessous les liens vers deux notes techniques publiées par l’ANSSI 


• 
Reco􀅵􀅵andations pour la définition d’une politi􀆋ue de filtrage réseau 
d’un 
fire􀇁all 
: 
https://www.ssi.gouv.fr/guide/recommandations-de-securisation-dun-pare-feu-stormshieldnetwork-
security-sns/ 

• 
Recommandations de sécurisation d’un 
firewall Stormshield Network Security (SNS) : 
https://www.ssi.gouv.fr/guide/recommandations-pour-la-definition-dune-politique-de-filtragereseau-
dun-pare-feu/ 

Pour aller plus loin, consultez la note technique du site documentation.stormshield.eu : 

• 
Mise en oeuvre 
d'une règle de filtrage 
Et pour les situations/questions très spécifiques, consultez la base de connaissance du TAC 
kb.stormshield.eu. 


291 


Filtrage 
Lab 

•Généralités 
•La notion de « stateful » 
•L’ordo􀅶􀅶a􀅶ce􀅵e􀅶tdesr􀄟gles de filtrage etde 
translation 
•Menus « filtrage » 
•L’a􀅶alyseur de cohére􀅶ce etde co􀅶for􀅵ité•Lab -Filtrage 
Filtrage 
➔
292 


Filtrage 
Lab 

Lab 5 – 
Filtrage 

Copiez la politique de filtrage/NAT (4) Lab_4 vers la politique numéro 5. Renommez 
la politique numéro 5 « Lab_5 », puis activez cette politique. Supprimez la règle Pass 
any any any et ajoutez les règles de filtrage qui respecteront le cahier des charges 
suivant: 

-Utilisez les séparateurs pour indiquer le rôle de chaque bloc de règles. 

-Affichez la colonne « Nom » des règles et la compléter pour chaque règle. 

Trafics internes : 

1. Votre réseau interne (in : 192.168.y.0/24) doit pouvoir accéder aux serveurs de 
votre DMZ : DNS, WEB (ports 80 et 808 pour le webmail), FTP et SMTP. 
Trafics sortants : 

2. Votre réseau interne, doit pouvoir naviguer sur les sites web d'Internet en HTTP 
et HTTPS, sauf sur les sites de la République de Corée (test avec 
www.visitkorea.or.kr). 
3. L’acc􀄟s 
au site https://www.cnn.com doit être bloqué depuis le réseau interne. 
Pour cela utilisez un objet FQDN. 
4. Votre réseau interne doit pouvoir joindre les serveurs FTP d’I􀅶ter􀅶et. 
5. Un stagiaire, nouvellement arrivé dans l'entreprise, a l'interdiction d'effectuer 
la moindre requête FTP. L'adresse IP de sa machine (pc_200) est 192.168.y.200. 
6. Votre réseau interne doit pouvoir émettre un ping vers n'importe quelle 
destination. 
7. Votre réseau interne doit pouvoir se connecter en SSH aux firewalls des autres 
sites. 
8. Seul votre serveur DNS interne (172.16.y.10) peut envoyer des requêtes DNS 
vers l'extérieur. 
9. Votre serveur de messagerie peut envoyer des mails vers 􀅶’i􀅵porte 
quel 
serveur de mail externe. 
Trafics entrants : 

10. Les réseaux externes peuvent joindre vos serveurs Web et FTP ; ces 
événements doivent être tracés. 
11. Les serveurs mail externes sont autorisés à transmettre des e-mails à votre 
serveur de messagerie. 
12. Les réseaux externes sont autorisés à pinger l'interface « out » de votre 
firewall; ce type d’évé􀅶e􀅵e􀅶t 
doit lever une alarme mineure. 


PROTECTION 
APPLICATIVE 

CSNA -STORMSHIELD NETWORK SECURITY -VERSION 4.X 


Programme de la formation 

✔ 
Cursus des formations et certifications 
✔ 
Présentation de l’entreprise 
et des produits 
✔ 
Prise en main du firewall 
✔ 
Traces et supervision 
✔ 
Les objets 
✔ 
Configuration réseau 
✔ 
Translation d'adresses 
✔ 
Filtrage 

• 
Protection applicative 
Utilisateurs & authentification 
VPN 
VPN SSL 
303 


Protection applicative 

•➔Activation du mode Proxy 
• 
Proxy HTTP 
• 
Proxy HTTPS 
• 
Analyse antivirale 
• 
Prévention d’intrusion et inspection de sécurité 
• 
Lab – 
Filtrage de contenu (HTTP et HTTPS) 
Protection applicative 


304 


Protection applicative 

ACTIVATION DU MODE PROXY 
• 
Objectifs : 
– 
Contrôler les accès aux sites web d’Internet (filtrage d’URL et 
filtrage SSL) 
– 
Créer une politique anti-relais et antispam (filtrage SMTP) 
– 
Effectuer une analyse antivirale sur les flux DATA (HTTP, SMTP, 
FTP, POP3,…) 
– 
Bloquer les maliciels à l’aide d’une analyse comportementale sur 
des machines de détonation (sandboxing Breachfighter) 
3 

L’analyse 
applicative complète des flux, 􀆋u’ils 
soient initialement chiffrés ou pas, 
induit l’utilisation 
d’un 
mode Proxy sur les firewalls Stormshield. 


305 


Protection applicative 

4 
ACTIVATION DU MODE PROXY 
•Miseenoeuvre :
L’activation d’une inspection applicative (encadré rouge) sur une règle de filtrage du 
firewall entraîne le démarrage des analyses en mode Proxy transparent : 

• 
Le firewall se fait passer pour le client auprès du serveur et pour le serveur auprès 
du client, 
• 
La configuration du poste client n’est pas modifiée (c’est le principe du mode 
transparent), par exemple, le port d’écoute et l’adresse IP du Proxy n’ont pas à 
être configurés sur son navigateur Internet. 
NOTE : 

• 
Le mode Proxy explicite des firewalls Stormshield n’est pas évoqué dans ce 
chapitre. L’utilisation d’un Proxy explicite sur un firewall Stormshield offre moins 
de fonctionnalités que celle d’un Proxy transparent. Par exemple, un Proxy 
explicite n’est pas compatible avec l’authentification multi-annuaires ou avec le 
Proxy SSL (le trafic HTTPS ne peut pas être déchiffré pour subir une analyse 
antivirale). L’usage du Proxy en mode transparent est donc conseillé. 
• 
Une analyse sur une règle de filtrage en mode IPS seulement n’utilise pas de 
mécanisme de type Proxy. 
306 


Protection applicative 

• 
Proxy HTTP 
➔
• 
Activation du mode Proxy 
• 
Proxy HTTPS 
• 
Analyse antivirale 
• 
Prévention d’intrusion et inspection de sécurité 
• 
Lab – 
Filtrage de contenu (HTTP et HTTPS) 
Protection applicative 


307 


Protection applicative 

PROXY HTTP 
• 
Contrôler les 
accèsaux siteswebd’Internet enHTTP: 
– 
Par mots-clés personnalisés 
– 
Par consultation de sites présents dans une base de données : 
• 
Base embarquée Stormshield : 16 catégories 
• 
EWC : Extended Web Control : 65 catégories 
6 

La fonction de filtrage des URL permet de contrôler l'accès aux sites web d'Internet 
pour l'ensemble de vos utilisateurs. 

Pour contrôler ces accès, la politique de filtrage URL va se baser sur une liste d’URL 
rangée au sein de catégories ou de mots clés personnalisés. 

Deux fournisseurs de base URL sont disponibles: 

1. Base URL embarquée composée de 16 catégories téléchargées sur les serveurs 
de mise à jour, 
2. Base Extended Web Control (EWC) constituée de 65 catégories, toutes hébergées 
dans le Cloud. Cette solution est disponible en option supplémentaire. Veuillez 
vous reporter à la section « Fonctionnement d’EWC » pour plus de détails sur 
son fonctionnement. 
308 


Protection applicative 

PROXY HTTP 
• 
Extended Web Control: 
– 
Solution de filtrage URL 
– 
Base de données maintenue dans le Cloud 
– 
Évite toute saturation d’espace disque (surtout pour les produits 
d’entrée de gamme) 
7 

Extended Web Control est une solution de filtrage URL. La base de données est 
maintenue à jour dans le Cloud. 

L'avantage majeur est que la base de données n’est 
pas téléchargée, ce qui permet 
d’éviter 
la saturation de l’espace 
disque alloué au stockage de la base. 

Il s’agit 
d’une 
option payante, elle n’est 
pas intégrée par défaut sur l’ense􀅵ble 
de la 
gamme. 


309 


Protection applicative 

PROXY HTTP 
• 
ExtendedWebControl : visite d’unsiteweb 
4 
Requête HTTP 
1 
Classification 
3 
Proxy 
Cache 
local 
EWC 
5 
Mise en cache 
Application du filtrage 
Demande de classification 
2 
Serveurs CloudURL 

8 


Sur réception d’une 
connexion HTTP à destination d’un 
site web sur Internet, le 
firewall envoie une requête vers un des serveurs Extended Web Control afin de 
recenser les catégories auxquelles appartient l'URL visitée. Le résultat sera ensuite 
confronté à la politique de filtrage URL active. 

Les serveurs peuvent renvoyer jus􀆋u’à 
5 catégories par URL. Par conséquent, une 
URL peut se trouver simultanément dans une catégorie bloquée et une catégorie 
autorisée. Dans ce cas, c'est l'ordre des règles de filtrage URL qui prime; assurez-
vous donc d'ordonnancer convenablement vos règles de filtrage URL. 

Afin d’opti􀅵iser 
le fonctionnement et éviter l'envoi de plusieurs requêtes vers les 
serveurs pour la même URL, la solution Extended Web Control utilise un cache. 
Lors􀆋u’une 
requête HTTP est interceptée, le proxy interroge tout d’abord 
le cache 
local. Si l’URL 
n’est 
pas présente, une requête est alors envoyée aux serveurs 
Extended Web Control pour connaître les catégories incluant cette URL. 
Le cache est mis à jour pour conserver la décision appliquée à et l’URL 
déjà visitée. 

La taille du cache, dépendante du modèle, est dimensionnée pour conserver 1 jour 
de navigation ; son contenu n’est 
pas visualisable (même en mode console). 
Le cache est vidé en cas de redémarrage du Firewall ou du daemon gérant les 
Proxies (tproxyd). 

Dans la base objets, les serveurs Extended Web Control (CloudURL) sont nommés 
cloudurl[1-5]-sns.stormshieldcs.eu 


310 


Protection applicative 

PROXY HTTP 
• 
Extended Web Control : utilisation du cache 
Requête HTTP 
1 
2 
Serveurs CloudURL 
3 
Proxy 
Cache 
local 
EWC 
Application du filtrage 
Lecture du cache 


9 

Le proxy interroge le cache local, l’URL est présente. Dans ce cas, les serveurs 
Extended Web Control ne sont pas interrogés. 

Le résultat appliqué lors de la dernière visite (donner l’accès ou le bloquer) est 
également appliqué pour cette connexion. 


311 


Protection applicative 

10 
•Choix de labased’URLEWCPROXY HTTP 
Le choix de la base s'effectue depuis le menu CONFIGURATION ⇒ 
OBJETS ⇒ 
URL, 
dans l'onglet BASE D’URL. 

Le passage de la base URL embarquée à EWC entraîne la suppression des catégories 
embarquées ; cela vous est notifié par un message d'avertissement. 

Après une modification de base, il est conseillé de vérifier la politique de filtrage URL 
active car le nom des catégories diffère de l’une 
à l’autre 


Exemple 
: 
la 
catégorie 
Job 
Search 
existe 
avec 
Extended 
Web 
Control 
mais 
n’existe 
pas 
avec 
la 
base 
embarquée. 
Par 
conséquent, 
l’utilisation 
de 
cette 
catégorie 
dans 
le 
filtrage 
URL 
génère 
un 
avertissement 
lors 
de 
l’activation 
de 
la 
politique 
si 
un 
retour 
à 
la 
base 
embarquée 
a 
été 
effectué. 



312 


Protection applicative 

11 
•Création d’une catégorie personnalisée 
PROXY HTTP 
Depuis le menu CONFIGURATION ⇒OBJETS ⇒URL, dans l’onglet 
URL, vous pouvez 
créer vos propres catégories, une catégorie contient une liste d’URL, 
à ajouter en 
respectant les suggestions. 


313 


Protection applicative 

12 
•Créationd’ungroupede catégoriespersonnaliséPROXY HTTP 
Depuis le menu CONFIGURATION ⇒ 
OBJETS ⇒ 
URL, dans l’onglet GROUPE DE 
CATÉGORIES, vous pouvez créer et éditer vos propres groupes de catégories. 
Choisissez de créer un objet de type groupe de catégories URLs. 

Un groupe de catégories peut être composé de catégories présentes dans la base 
(EWC ou embarquée), mais aussi de catégories personnalisées, comme dans 
l’exemple ci-dessus. 

Vous pouvez utiliser les touches CTRL et SHIFT pour présélectionner plusieurs 
groupes avant de les déplacer. 


314 


Protection applicative 

13 
•Contenu des groupes ou recherche de classification 
PROXY HTTP 
Le contenu des catégories ne peut pas être consulté, cependant, l'appartenance 
d’une 
URL à un groupe peut être vérifiée par le biais des champs de classification. 

Ces champs sont disponibles depuis les menus URL ou au sein d’une 
politique de 
filtrage URL. 


315 


Protection applicative 

14 
•Édition de la politique de filtrage URL 
PROXY HTTP 
Depuis le menu CONFIGURATION ⇒ 
POLITIQUE DE SÉCURITÉ ⇒ 
Filtrage URL, 
choisissez une politique à éditer (dans l'exemple ci-dessus la politique default00 a 
été renommée Block_prohibited_URL). 

Il convient ensuite de choisir les sites à autoriser, bloquer ou à rediriger vers l’une 
des 4 pages de blocage personnalisables. 

Le contrôle de cohérence en temps réel affiche les erreurs détectées dans votre 
politique. 


316 


Protection applicative 


Le bouton Ajouter toutes les catégories prédéfinies permet de créer une politique 
très rapidement. 

Cette option ajoute une ligne avec l'action BlockPage_00 pour chaque catégorie 
présente dans la base d’URL 
courante. Les groupes personnalisés ne sont pas pris en 
compte et doivent être ajoutés manuellement. 

Un site web peut être classé dans plusieurs catégories. Dans ce cas, l’ordre 
des règles 
de filtrage définit l’action 
à appliquer pour le site concerné. 

Exemple 
: 
www.leroymerlin.fr 
fait 
partie 
de 
deux 
groupes 
EWC 
(Leisure 
and 
Recreation, 
Shopping). 
L’ordre 
de 
ces 
deux 
groupes 
dans 
la 
politique 
de 
filtrage 
URL 
active 
va 
dicter 
le 
comportement 
à 
appliquer 
pour 
toute 
visite 
sur 
le 
site 
www.leroymerlin.fr. 



317 


Protection applicative 

16 
•Application du filtrage URL dans la politique de filtrage 
PROXY HTTP 
Une fois la politique de filtrage URL définie, il convient de l'appliquer à une règle de 
filtrage autorisant les flux HTTP sortants, comme le montre l'exemple ci-dessus. Dans 
cette règle, le réseau nommé Network_dmz1 n’a 
accès 􀆋u’aux 
sites classifiés dans la 
catégorie News. 

Cette manière de procéder permet d’activer 
plusieurs politiques de filtrage URL 
simultanément ; afin de gérer les accès de différents réseaux ou machines sources. 


318 


Protection applicative 

17 
•Personnalisation des pages de blocage 
PROXY HTTP 
Les pages de blocage peuvent être éditées depuis le menu CONFIGURATION ⇒ 
NOTIFICATIONS ⇒Messages de blocage ⇒Onglet PAGE DE BLOCAGE HTTP. 

Les modifications peuvent s'effectuer grâce l’éditeur HTML, cela permet de 
personnaliser la page de manière précise. 


319 


Protection applicative 

• 
Proxy HTTPS 
➔
• 
Activation du mode Proxy 
• 
Proxy HTTP 
• 
Analyse antivirale 
• 
Prévention d’intrusion et inspection de sécurité 
• 
Lab – 
Filtrage de contenu (HTTP et HTTPS) 
Protection applicative 


320 


Protection applicative 

19 
–Par vérification du SNI, 
présent dans la requête du 
client et consultation des 
catégories de sites dans 
les bases : 
•Embarquée Stormshield : 
16 catégories 
•Extended Web Control : 
65 catégories 
PROXY HTTPS 
•Contrôler les accès aux sites web d’Internet en HTTPS : 
–Par déchiffrement du flux HTTPS pour appliquer une politique 
de filtrage URL comme vu précédemment 
Lorsqu'un client initie une connexion vers un site en HTTPS, il envoie en clair au 
serveur le nom de domaine du site demandé. Ce mécanisme appelé Server Name 
Indication (SNI) permet au serveur de sélectionner le bon certificat à présenter au 
client. 
Stormshield Network Security s'appuie sur ce système pour contrôler l'accès à ces 
sites web sans déchiffrer le flux. 

NOTE : Seules les vérifications par SNI et leur classification pour autoriser ou bloquer 
le flux sans le déchiffrer sont vues dans ce chapitre. Les traitements approfondis 
(comme par exemple une politique de filtrage URL ou une analyse antivirale) permis 
par le déchiffrement du flux HTTPS sont détaillés lors de la formation CSNE. 


321 


Protection applicative 

20 
•Créationd’unecatégoriepersonnaliséePROXY HTTPS 
Depuis le menu CONFIGURATION ⇒ 
OBJETS ⇒ 
URL, dans l’onglet NOM DE 
CERTIFICAT (CN), vous pouvez créer vos propres catégories. Une catégorie contient 
une liste de CN qui seront comparés aux SNI des connexions SSL/TLS. 


322 


Protection applicative 

21 
•Créationd’ungroupede catégoriesPROXY HTTPS 
Depuis le menu CONFIGURATION ⇒ 
OBJETS ⇒ 
URL, dans l’onglet GROUPE DE 
CATÉGORIES, vous pouvez créer et éditer vos propres groupes de catégories. 
Choisissez de créer un objet de type groupe de catégories Certificats. 

Un groupe de catégories peut être composé de catégories présentes dans la base 
(EWC ou embarquée), mais aussi de catégories personnalisées, comme dans 
l’exemple ci-dessus. 

Vous pouvez utiliser les touches CTRL et SHIFT pour présélectionner plusieurs 
groupes avant de les déplacer. 


323 


Protection applicative 

22 
•Édition de la politique de filtrage SSL 
PROXY HTTPS 
Depuis le menu CONFIGURATION ⇒ 
POLITIQUE DE SÉCURITÉ ⇒ 
Filtrage SSL, 
choisissez une politique à éditer. 

Il convient ensuite de choisir les SNI pour lesquelles les actions Bloquer sans 
déchiffrer et Passer sans déchiffrer doivent être appliquées. 
Pour rappel, l’action Déchiffrer, permettant une analyse approfondie sur le flux 
HTTPS, sera vue en CSNE. 

Le contrôle de cohérence en temps réel affiche les erreurs détectées dans votre 
politique. 


324 


Protection applicative 

23 
•Application du filtrage SSL dans la politique de filtrage 
PROXY HTTPS 
Une fois la politique de filtrage SSL définie, il convient de l'appliquer, ainsi que 
l’action 
Déchiffrer, à une règle de filtrage autorisant les flux HTTPS sortants, comme 
le montre l'exemple ci-dessus. 

Cette manière de procéder permet d’activer 
plusieurs politiques de filtrage SSL 
simultanément afin de gérer les accès de différents réseaux ou machines sources. 


325 


Protection applicative 

PROXY HTTPS 
• 
Message affiché sur le navigateur Internet (action 
Bloquer sans déchiffrer) 
24 

Si le CN du site demandé dépend de l’action 
Passer sans déchiffrer, aucune 
modification n’est 
effectuée sur la page web demandée. 
Si le CN du site demandé dépend de l’action 
Bloquer sans déchiffrer, la page web 
affichée précise seulement que la connexion est rejetée par l’ad􀅵inistrateur. 


326 


Protection applicative 

• 
Analyse antivirale 
➔
• 
Activation du mode Proxy 
• 
Proxy HTTP 
• 
Proxy HTTPS 
• 
Prévention d’intrusion 
et inspection de sécurité 
• 
Lab – 
Filtrage de contenu (HTTP et HTTPS) 
Protection applicative 


327 


Protection applicative 

26 
•Choix du moteur antiviral 
ANALYSE ANTIVIRALE 
Le choix du moteur antiviral s'effectue depuis le menu CONFIGURATION ⇒ 
PROTECTION APPLICATIVE ⇒Antivirus. 

L'offre de service antivirus sur les firewalls Stormshield Network se compose de deux 
solutions: 

• 
ClamAV: Ce moteur antiviral est intégré gratuitement et par défaut dans 
l’ense􀅵ble 
des produits de la gamme Stormshield Network. 
• 
Antivirus avancé: Pour bénéficier du service antivirus avancé, il est 
nécessaire de souscrire à un pack de sécurité incluant cette option. Pour plus 
d’infor􀅵ations 
sur le service antivirus avancé, veuillez contacter votre 
revendeur. 
En cas de changement de moteur, un message vous indiquera que ce changement 
nécessite le téléchargement de la base concernée. Par conséquent, et durant toute 
la durée du téléchargement, l'analyse antivirale échouera. 

NOTE : L’option 
« Sandboxing », possible uniquement avec l’Antivirus 
avancé, dépend 
d’une 
option de licence supplémentaire nommée « Sandboxing Breach Fighter », qui 
est détaillée dans le chapitre « Analyse Breach Fighter ». 


328 


Protection applicative 

27 
•Analyse des fichiers 
ANALYSE ANTIVIRALE 
Vous trouverez des paramètres additionnels à appliquer aux protocoles pouvant être 
soumis à une analyse antivirale (voir le menu CONFIGURATION ⇒ 
PROTECTION 
APPLICATIVE ⇒Protocoles ⇒HTTP, SMTP, FTP ou POP3 ⇒ANALYSE DES FICHIERS) 

Ce menu est identique pour les protocoles FTP, SMTP et POP3 où il contient : 

• 
La taille maximale pour l'analyse antivirale, 
• 
Les actions sur les messages. 
Pour le protocole HTTP, une section supplémentaire contient le comportement de 
l'antivirus en fonction des types MIME déclarés dans l'entête HTTP. 


329 


Protection applicative 

28 
•Réponseémisepar l’antivirusà l’utilisateurANALYSE ANTIVIRALE 
Depuis le menu CONFIGURATION ⇒NOTIFICATIONS ⇒Messages de blocage, il est 
possible de modifier les notifications envoyées aux utilisateurs lorsqu’un mail ou un 
fichier téléchargé par FTP contient un virus. 

Il s’agit d’un paramètre global. Il n’est pas possible de distinguer un message pour les 
flux entrants et les flux sortants par exemple. 


330 


Protection applicative 

29 
•Activationde l’analyseantiviraleANALYSE ANTIVIRALE 
Les flux pouvant être analysés par le moteur antiviral sont: 

• 
HTTP et HTTPS*, 
• 
FTP, 
• 
SMTP et SMTPS*, 
• 
POP3 et POP3S*. 
Pour mettre en oeuvre 
cette analyse, il suffit de sélectionner l'inspection applicative 
Antivirus dans la colonne inspection de sécurité de la règle de filtrage concernée. 

NOTE : Pour être soumis à une analyse antivirale les flux HTTPS, SMTPS et POP3S 
doivent au préalable être déchiffrés par une règle d’inspection 
SSL. 


331 


Protection applicative 

• 
Prévention d’intrusion 
et inspection de 
➔
• 
Activation du mode Proxy 
• 
Proxy HTTP 
• 
Proxy HTTPS 
• 
Analyse antivirale 
sécurité 

• 
Lab – 
Filtrage de contenu (HTTP et HTTPS) 
Protection applicative 


332 


Protection applicative 

PRÉVENTION D’INTRUSION ETINSPECTION DE SÉCURITÉ
• 
Définition 
– 
Analyses à partir de la 
couche IP 
– 
Jusqu’au niveau applicatif 
– 
Vérifier la conformité des 
protocoles 
Plugins 
TCP, UDP, SCTP, ICMP 
Fragmentation 
Analyses IPv4, IPv6 
Signatures 
contextuelles 
31 

Les équipements Stormshield Network sont équipés nativement d'un module de 
prévention d'intrusion nommé ASQ (Active Security Qualification). Chaque paquet 
reçu par l'UTM sera soumis à un ensemble d'analyses à commencer par la 
vérification du protocole IP. 

Le rôle principal de l'ASQ est de s'assurer de la conformité du paquet par rapport aux 
protocoles utilisés de la couche IP jus􀆋u’à 
la couche applicative (grâce aux plugins) et 
aux signatures contextuelles (ou Patterns). 

C’est 
également l'ASQ qui est en charge de filtrer les flux et d'appliquer une 
opération de NAT si nécessaire. 

Le fonctionnement détaillé de l'ASQ ainsi que ses options sont abordés dans le 
cursus Expert. 


333 


Protection applicative 

32 
•Interactions avec le module de filtrage 
–Modes d’inspection–Profils d’inspectionPRÉVENTION D’INTRUSION ET INSPECTION DE SÉCURITÉ 
Chaque paquet reçu par l'UTM est soumis à la politique de filtrage. Par défaut, 
l'analyse IPS est appliquée, ce qui signifie que le firewall est capable de détecter une 
anomalie et de bloquer le paquet correspondant. 

D'autres modes d'inspection peuvent être utilisés, à des fins de tests ou par 
nécessité ; par exemple si on contacte un serveur ne respectant pas la RFC des 
protocoles qu'il gère. 
Ces modes sont à sélectionner dans la colonne Inspection de sécurité de la règle de 
filtrage concernée. 

• 
IPS : Détecter et bloquer (choix par défaut). L'ASQ va soumettre le paquet à 
l'ensemble des couches qu'il est capable d'analyser et le bloquer en cas 
d'anomalie. 
• 
IDS : Détecter. L'ASQ effectue une analyse similaire à l'IPS sauf que le 
paquet est toujours autorisé. C'est un profil permettant de faire un audit 
rapide pour une règle de filtrage donnée. 
• 
Firewall : Ne pas inspecter. L'ASQ ne va effectuer que très peu d’analyses 
sur le paquet reçu. Pour connaître la liste exhaustive des alarmes qui ne sont 
pas contournées par le mode Firewall, veuillez vous référer à l’article "What 
are 
the 
alarms 
that 
are 
not 
bypassed 
by 
Firewall 
Mode?" de la base de 
connaissances du support technique. 
334 


Protection applicative 

L'ASQ est composé de 10 configurations (également nommées profils IPS). Chacune 
de ces configuration peut être éditée en fonction des besoins de l'administrateur. 

Par défaut, et comme indiqué dans le menu CONFIGURATION ⇒ 
PROTECTION 
APPLICATIVE ⇒ 
Profils d'inspection, les profils IPS_00 et IPS_01 sont appliqués 
respectivement aux connexions entrantes (paquet dont l'adresse IP source ne fait 
pas partie d'un réseau protégé) et aux connexions sortantes (paquet dont l'adresse 
IP source fait partie d'un réseau protégé). 

Malgré cette configuration, il est possible, dans la grille de filtrage, de forcer 
l'utilisation d'un profil ASQ spécifique depuis la colonne Inspection de sécurité. Les 
profils sont ensuite administrables depuis les menus Protocoles et Applications et 
protections sous CONFIGURATION ⇒PROTECTION APPLICATIVE. 


335 


Protection applicative 

RECOMMANDATIONS 
• 
Adapter les profils d’inspection au rôle de l’équipement 
• 
Adapter les profils d’inspection en fonction du contexte 
• 
Remonter à Stormshield les faux positifs 
34 

En fonction de l’utilisation 
de l’é􀆋uipe􀅵ent, 
il peut être utile de désactiver certaines 
vérifications de l’IPS 
pour gagner des ressources de calcul. Par exemple, ne pas 
appliquer un filtrage IPS sur du HTTP si le trafic est ensuite redirigé vers un proxy 
filtrant. 

Par défaut, l’IPS 
est actif sur toutes les règles de filtrage en mode de détection 
automatique du protocole. Afin de mieux inspecter les flux, il est recommandé de 
qualifier manuellement le type de protocole si le port utilisé n’est 
pas standard. L’IPS 
risquerait de ne pas détecter correctement l’application. 

Si des flux sains déclenchent des alarmes, il sera sûrement nécessaire de modifier les 
paramètres de l’ASQ 
pour ne pas bloquer la production. Dans ce cas, les 
modifications doivent être faites au plus spécifique. De préférence dans un profil 
dédié qui sera appliqué sur les règles identifiant précisément le trafic concerné. 
N’hésitez 
pas à remonter au support technique ou à votre contact privilégié les cas 
de faux positif en configuration par défaut. 


336 


Protection applicative 

35 
RESSOURCES COMPLÉMENTAIRES SUR LES SITES STORMSHIELD 
Pour aller plus loin, consultez la note technique du site 
documentation.stormshield.eu : 

• 
Filtrer les connexions HTTPS 
Et pour les situations/questions très spécifiques, consultez la base de connaissance 
du TAC kb.stormshield.eu. 




UTILISATEURS & 
AUTHENTIFICATION 

CSNA -STORMSHIELD NETWORK SECURITY -VERSION 4.X 


Programme de la formation 

✔ 
Cursus des formations et certifications 
✔ 
Présentation de l’entreprise 
et des produits 
✔ 
Prise en main du firewall 
✔ 
Traces et supervision 
✔ 
Les objets 
✔ 
Configuration réseau 
✔ 
Translation d'adresses 
✔ 
Filtrage 
✔ 
Protection applicative 

• 
Utilisateurs & authentification 
VPN 
VPN SSL 
360 


Utilisateurs & authentification 

•➔Introduction 
• 
Liaison à un annuaire 
• 
Gestion des utilisateurs 
• 
Les méthodes d’authentification 
• 
La politique d’authentification 
• 
Le portail captif 
• 
Règles de filtrage pour l’authentification 
• 
Définir de nouveaux administrateurs 
• 
Lab -Authentification 
Utilisateurs & authentification 


361 


Utilisateurs & authentification 

3 
•Objectif : 
Accorder auxutilisateurs desdroitsd’accèsspécifiquesaux réseaux et aux services (portail captif, VPN SSL, 
VPN IPsec, administration du firewall, etc.) 
•Les étapes de configuration sur un firewall Stormshield 
INTRODUCTION 
3. Méthode(s) d’authentification 
1. Annuaire(s) 
5. Portail captif 
4. Politique d’authentification 
6. Politique de sécurité 
(filtrage) 
2. Utilisateurs et groupes 
Étapes de mise en oeuvre 
sur un firewall Stormshield 

Le schéma ci-dessus illustre la logique de mise en oeuvre 
de l’authentification. Les 
chapitres de ce cours détaillent les étapes dans l’ordre. 

1. Les annuaires stockent des informations de manière hiérarchisée dans une 
arborescence. La norme LDAP permet l’organisation des données dans l’annuaire 
et fournit un protocole d’interrogation de l’annuaire (RFC 4510), la configuration 
sur un firewall consiste à établir un lien vers un ou plusieurs annuaires. 
2. Les utilisateurs sont stockés dans un annuaire et décrits par des attributs (nom, 
prénom, identifiant, mot de passe, adresse e-mail, certificat, etc.) utilisés par le 
firewall pour l’authentification. 
3. Les méthodes d’authentification utilisées permettent au firewall de configurer la 
façon de vérifier l’identité des utilisateurs. 
4. La politique d’authentification permet d’accorder aux utilisateurs des droits 
d’accès aux réseaux et services gérés par le firewall. 
5. Le portail captif peut avoir plusieurs usages : authentifier des utilisateurs pour 
accéder au réseau, enrôler de nouveaux utilisateurs, demander la création d’un 
certificat, télécharger le client VPN SSL et sa configuration, faire une demande de 
parrainage pour accéder au réseau, etc. 
6. La politique de sécurité contient les règles de filtrage nécessaires pour que les 
utilisateurs inconnus soient redirigés vers la solution d’authentification retenue 
(par exemple, via le portail captif). 
NOTE : En fonction de la méthode d’authentification retenue, certaines étapes de 
configuration seront facultatives. 


362 


Utilisateurs & authentification 

• 
Liaison à un annuaire 
➔
• 
Introduction 
• 
Gestion des utilisateurs 
• 
Les 􀅵éthodes 
d’authentification 
• 
La politi􀆋ue d’authentification 
• 
Le portail captif 
• 
Règles de filtrage pour l’authentification 
• 
Définir de nouveaux administrateurs 
• 
Lab -Authentification 
Utilisateurs & authentification 


363 


Utilisateurs & authentification 

5 
•4 typesd’annuaireLDAP/AD:
•Externes : 
•Interne : 
LIAISON À UN ANNUAIRE 
•Microsoft Active Directory 
•LDAP externe 
•LDAP externe de type PosixAccount 
LDAP TCP/389 
LDAPS TCP/636 
Protocole LDAP 
Client LDAP 
Client LDAP Annuaire LDAP 
Protocole LDAP 
Les firewalls supportent quatre types d’annuaire 
qui peuvent être classés en deux 
catégories : 

• 
LDAP/AD externes : L’annuaire 
est stocké sur un serveur externe. trois types 
d’annuaire 
sont supportés : 
• 
Microsoft Active Directory (AD), 
• 
LDAP standard, 
• 
LDAP de type PosixAccount. 
• 
LDAP interne :L’annuaire 
LDAP est créé sur le firewall et héberge les utilisateurs. 
Les firewalls peuvent supporter cinq annuaires simultanément : un LDAP interne et 
quatre LDAP/AD externes, ou cinq LDAP/AD externes. Ce qui signifie que les firewalls 
peuvent supporter en même temps cinq domaines différents. 

NOTE : 

• 
Un client LDAP intégré au firewall permet de se connecter à n’i􀅵porte 
quel type 
d’annuaire 
(interne ou externe) en utilisant le protocole LDAP (ou LDAPS pour 
sécuriser les connexions avec les annuaires externes). 
• 
Dans le cas d’un 
LDAP interne, l’annuaire 
et les utilisateurs sont automatiquement 
sauvegardés/restaurés avec la configuration du firewall. 
364 


Utilisateurs & authentification 

6 
•Ajout et configuration d’un annuaire 
LIAISON À UN ANNUAIRE 
Annuaire par défaut 
L’ajout 
et la configuration des annuaires s’effectuent 
depuis le menu : 
CONFIGURATION ⇒UTILISATEURS ⇒Configuration de l'annuaire. 

Pour lancer l’assistant 
d’ajout 
d’annuaire 
cliquez sur Ajouter un annuaire. Le bouton 
Action permet, quant à lui, d’accéder 
à plusieurs fonctionnalités : 

• 
Supprimer un annuaire, 
• 
Désigner un annuaire par défaut, 
• 
Vérifier la connexion à l’annuaire, 
• 
Vérifier l’utilisation 
de l’annuaire, 
• 
Renommer un annuaire. 
Le reste du menu liste tous les annuaires ajoutés, parmi lesquels l’annuaire 
par 
défaut s’affiche 
en vert. En cliquant sur un annuaire, ses paramètres s’affichent 
à 
droite de la page. 


365 


Utilisateurs & authentification 

7 
•Ajouter et configurer un annuaire externe 
LIAISON À UN ANNUAIRE 
La configuration des annuaires externes (Microsoft Active Directory, LDAP et LDAP de 
type PosixAccount) est sensiblement identique. L’assistant de configuration vous 
demande d’abord de renseigner les paramètres du serveur à contacter : 

• 
Nom du domaine : Le nom DNS du domaine, 
• 
Serveur :L’objet machine qui porte l'adresse IP du serveur qui héberge l’annuaire, 
• 
Port : Le port d’écoute de votre serveur LDAP. Les ports par défaut sont : 389/TCP 
pour une authentification en clair (ldap) et 636/TCP pour une authentification en 
SSL (ldaps), 
• 
Domaine racine (Base DN) : Le DN de la racine de votre annuaire (exemple : 
stormshield.eu ou dc=stormshield,dc=eu), 
• 
Identifiant (user DN) et le mot de passe : Un compte administrateur permettant 
au firewall de se connecter sur votre serveur LDAP et d’effectuer des 
lectures/écritures sur certains champs. Nous vous recommandons de créer un 
compte spécifique pour le firewall et de lui attribuer les droits uniquement sur les 
champs qui lui sont nécessaires (exemple : cn=TrainingAdmin,ou=Training). 
• 
Haché du mot de passe : Permet de sélectionner l’algorithme de hachage qui doit 
être utilisé pour enregistrer les mots de passe des utilisateurs, ce qui évitera de 
l’enregistrer en clair. 
366 


Utilisateurs & authentification 

8 
•Ajouter et configurer un annuaire externe 
LIAISON À UN ANNUAIRE 
Par la suite, l’assistant 
vous propose d’activer 
le profil d’authentification 
0 (internal) 
sur une interface, dans le cas où le profil n’a 
pas déjà été activé. Si c’est 
le cas, cette 
étape ne s’affiche 
pas. 


367 


Utilisateurs & authentification 

9 
•Ajouter et configurer un annuaire externe 
LIAISON À UN ANNUAIRE 
Les paramètres d’un annuaire externe sont organisés en deux onglets : 

• 
CONFIGURATION : Contient 3 encadrés : 
• 
Annuaire distant : Regroupe les paramètres de connexion à l’annuaire 
(l’adresse IP du serveur, le numéro de port, le base DN, l’identifiant, etc.). 
• 
Connexion sécurisée (SSL) : Permet d’activer une connexion sécurisée 
avec l’annuaire en spécifiant l’autorité de certification dont doit être issu le 
certificat présenté par le serveur d’annuaire. 
• 
Configuration avancée : Permet de définir un serveur de secours, de 
spécifier l’identifiant (firewall ou utilisateur) utilisé pour se connecter à 
l’annuaire et d’ajouter ou non le base DN lors de la connexion. Il permet 
également d’autoriser les groupes imbriqués (un groupe d’utilisateurs 
contenant d’autres groupes). 
• 
STRUCTURE : Contient également 3 encadrés : 
• 
Accès en lecture : Permet de définir les filtres pour la sélection des 
utilisateurs et des groupes dans l’annuaire. Ces filtres dépendent du type 
d’annuaire et ils sont préconfigurés en conséquence. L’encadré permet 
également d’indiquer si l’annuaire est accessible en lecture seule ou 
lecture/écriture. NOTE : Même si un annuaire de type Microsoft Active 
Directory est en accès lecture/écriture, l’ajout ou la suppression 
d’utilisateurs à partir du firewall reste impossible. En revanche, la 
publication de certificats pour les utilisateurs de l’AD reste possible. 
368 


Utilisateurs & authentification 

• 
Correspondance d’attri􀄏uts 
: Permet d’indi􀆋uer 
la correspondance entre 
les attributs utilisés par le firewall et ceux utilisés par l’annuaire 
externe. 
Par exemple, avec un annuaire de type Microsoft Active Directory, 
l’attribut 
Stormshield uid a comme équivalent Active Directory 
sAMAccountName. Des modèles peuvent être appliqués en fonction du 
type de l’annuaire. 
• 
Configuration avancée : 
• 
Hachage de mot de passe : Permet de sélectionner l’algorith􀅵e 
de 
hachage qui doit être utilisé pour enregistrer les mots de passe des 
utilisateurs, ce qui évitera de l’enregistrer 
en clair. 
• 
Branche 􀍚utilisateurs’ 
et Branche 􀍚groupes’ 
: À utiliser dans le cas 
d’un 
LDAP externe accessible en lecture/écriture. Il permet de 
renseigner les branches où seront enregistrés les utilisateurs et 
groupes créés à partir du firewall. Par exemple ou=users pour la 
branche utilisateurs. 
• 
Branche de l’autorité 
de certification : Permet de définir 
l’e􀅵place􀅵ent 
de l’autorité 
de certification présente dans 
l’annuaire 
externe. Cet emplacement est notamment utilisé lors de 
la recherche de la CA utilisée pour la méthode d’authentification 
SSL. 
369 


Utilisateurs & authentification 

11 
LIAISON À UN ANNUAIRE 
•Ajouter et configurer un annuaire interne 
La configuration d’un 
annuaire interne nécessite le renseignement des informations 
suivantes : 

• 
Organisation : Le nom de l’organisation. Par exemple, Stormshield, 
• 
Domaine : Le TLD (Top Level Domain) du domaine. Par exemple, pour le domaine 
« Stormshield.eu », le TLD est « eu », 
• 
Mot de passe : Un mot de passe permettant de se connecter à l’annuaire 
LDAP 
depuis un navigateur LDAP. 
• 
Haché du mot de passe : Permet de sélectionner l’algorith􀅵e 
de hachage qui doit 
être utilisé pour enregistrer les mots de passe des utilisateurs, ce qui évitera de 
l’enregistrer 
en clair. 
370 


Utilisateurs & authentification 

12 
•Ajouter et configurer un annuaire interne 
LIAISON À UN ANNUAIRE 
L’étape suivante permet de configurer des paramètres complémentaires : 

• 
Activer le profil d’authentification 0 (internal) sur une interface : Dans le 
cas où le profil n’a pas déjà été activé. Si c’est le cas, cette option sera 
désactivée (grisée) et un message indique que l’association entre profil 
d’authentification et interface est déjà réalisée. 
• 
Activer l'enrôlement des utilisateurs via le profil 0 (interne) du portail 
Web : Active le service d’enrôlement sur le profil 0 (interne) permettant 
aux utilisateurs de remplir un formulaire de création de compte qui sera 
soumis à l’approbation de l’administrateur. 
• 
Autoriser l’accès à la base LDAP: Donne la possibilité d’exposer le service 
LDAP sur le réseau et d’y accéder depuis un client LDAP. Si cet accès n’est 
pas nécessaire, il est vivement conseillé de ne pas activer cette option. 
371 


Utilisateurs & authentification 

13 
•Ajouter et configurer un annuaire interne 
LIAISON À UN ANNUAIRE 
Une fois la configuration terminée, il est possible de modifier certains paramètres du 
LDAP interne : 

• 
Activer l’utilisation 
de l’annuaire 
utilisateur : Cette option permet de 
démarrer le service LDAP, 
• 
Mot de passe : Le mot de passe permettant de se connecter à l’annuaire, 
il 
est possible de le modifier, 
• 
Activer l’acc􀄟s 
non chiffré (PLAIN) : Active l’accès 
non chiffré à l’annuaire, 
• 
Activer l’acc􀄟s 
SSL : Active l’accès 
sécurisé à l’annuaire, 
il faut alors 
renseigner le champ certificat SSL présenté par le serveur, 
• 
Utiliser le compte du firewall pour vérifier l'authentification des 
utilisateurs sur l'annuaire : Si cette option n’est 
pas cochée, 
l’authentification 
s’effectue 
avec le compte de l’utilisateur. Le compte 
disposant de tous les droits sur l'annuaire est cn=NetasqAdmin. 
372 


Utilisateurs & authentification 

• 
Gestion des utilisateurs 
➔
• 
Introduction 
• 
Liaison à un annuaire 
• 
Les 􀅵éthodes 
d’authentification 
• 
La politi􀆋ue d’authentification 
• 
Le portail captif 
• 
Règles de filtrage pour l’authentification 
• 
Définir de nouveaux administrateurs 
• 
Lab -Authentification 
Utilisateurs & authentification 


373 


Utilisateurs & authentification 

15 
GESTION DES UTILISATEURS 
Les utilisateurs et les groupes, de tous les annuaires configurés, peuvent être 
visualisés depuis le menu CONFIGURATION⇒UTILISATEURS ⇒Utilisateurs. 
Le menu est composé de 3 parties : 

• 
La barre du menu qui offre les fonctionnalités suivantes : 
• 
Barre de recherche, 
• 
Filtrer l’affichage 
en se basant sur le type : groupes ou utilisateurs, 
• 
Filtrer l’affichage 
en se basant sur l’annuaire 
(s’affiche 
seulement si 
plusieurs annuaires sont configurés), 
• 
Ajouter un utilisateur, 
• 
Ajouter un groupe, 
• 
Supprimer un utilisateur ou un groupe, 
• 
Vérifier l’utilisation 
d’un 
utilisateur ou d’un 
groupe. 
• 
CN : la liste des utilisateurs et des groupes de tous les annuaires. Pour distinguer 
les annuaires, un suffixe est ajouté aux utilisateurs et aux groupes pour indiquer le 
nom de l’annuaire 
(et non pas le nom du domaine). Par exemple : 
user6@institute.com 

• 
Paramètres d’un 
groupe ou d’un 
utilisateur : ils apparaissent à droite de la page. 
Les paramètres d’un 
utilisateur sont organisés en 3 onglets : les informations de 
l’utilisateur 
(COMPTE), son certificat (CERTIFICAT) et les groupes auxquels il 
appartient (MEMBRE DES GROUPES). 
Le lien Droits d'accès renvoie vers le menu CONFIGURATION⇒ 
UTILISATEURS ⇒ 
Droits d'accès ⇒onglet ACCÈS DÉTAILLÉ pour accorder des droits à l’utilisateur. 


374 


Utilisateurs & authentification 

NOTE : Lors de l’accès à ce menu, la liste des utilisateurs et groupes est toujours vide, 
c’est un comportement normal. En effet, si vous êtes connecté à un annuaire 
contenant un grand nombre d’utilisateurs et de groupes, l’affichage sans filtre dans le 
champ Recherche peut avoir un impact sur les performances de l’interface 
graphique. 
Pour voir les utilisateurs ou les groupes : 

• 
Vous pouvez cliquer sur l’un des filtres (utilisateurs ou groupes), 
• 
Vous pouvez ouvrir le menu des préférences du firewall accessible en 
cliquant sur l’icône représentant des outils dans l’en-tête de l’interface 
Web, et cocher la case « Afficher les utilisateurs dès le démarrage du 
module ». 
375 


Utilisateurs & authentification 

17 
•Créationd’unutilisateurGESTION DES UTILISATEURS 
Avec un LDAP interne (ou un LDAP externe accessible en lecture/écriture), il est 
possible d’ajouter 
ou de supprimer des utilisateurs et des groupes depuis le menu 
CONFIGURATION ⇒UTILISATEURS ⇒Utilisateurs. 

NOTE : 

• 
La création d’utilisateurs 
et de groupes s’effectue 
dans l’annuaire 
désigné par 
défaut dans le menu CONFIGURATION ⇒ 
UTILISATEURS ⇒ 
Configuration de 
l'annuaire, 
• 
La création d’utilisateurs 
est impossible dès 􀆋u’une 
correspondance d’attributs 
existe entre le firewall et la base LDAP externe (voir la diapositive numéro 9). 
376 


Utilisateurs & authentification 

• 
Les méthodes d’authentification 
➔
• 
Introduction 
• 
Liaison à un annuaire 
• 
Gestion des utilisateurs 
• 
La politique d’authentification 
• 
Le portail captif 
• 
Règles de filtrage pour l’authentification 
• 
Définir de nouveaux administrateurs 
• 
Lab -Authentification 
Utilisateurs & authentification 


377 


Utilisateurs & authentification 

19 
Méthodes 
avec annuaire 
Méthodes 
sans annuaire 
LES MÉTHODES D’AUTHENTIFICATION 
Explicite via le portail captif Implicite (transparente) 
LDAP interne/externe 
AD 
Kerberos 
(LDAP externe ou AD) 
Radius 
(LDAP externe ou AD) 
Certificat SSL 
(LDAP interne/externe ou AD) 
Spnego 
(AD) 
SSO 
(AD) 
Méthodes d’authentification avec SNS 
Multi-utilisateurs avec la méthode cookie 
(Flux HTTP) 
Invités 
Parrainage 
Comptes 
temporaires 
Les firewalls SNS implémentent plusieurs méthodes d’authentification 
qui peuvent 
être classées en deux catégories : 

• 
Les méthodes explicites via le portail captif : l’utilisateur 
est redirigé vers le 
portail captif pour saisir un identifiant/mot de passe. Ces derniers sont récupérés 
par le firewall pour vérifier l’identité 
de l’utilisateur 
en fonction de la méthode 
utilisée : 
• 
LDAP : L’identité 
de l’utilisateur 
est vérifiée sur un annuaire interne ou 
externe (LDAP/AD), 
• 
RADIUS : L’identité 
de l’utilisateur 
est vérifiée par un serveur Radius 
externe qui reçoit l’identifiant/􀅵ot 
de passe de l’utilisateur, 
• 
KERBEROS : L’identité 
de l’utilisateur 
est vérifiée par un serveur Kerberos 
externe qui reçoit l’identifiant/􀅵ot 
de passe de l’utilisateur, 
Trois autres méthodes d’authentification 
explicites peuvent être utilisées pour des 
besoins spécifiques : 

• 
Comptes temporaires : Permet à des utilisateurs temporaires de 
s’authentifier 
via le portail captif en utilisant un identifiant/mot de passe 
fournis par l’ad􀅵inistrateur, 
378 


Utilisateurs & authentification 

Les utilisateurs temporaires sont ajoutés par l’administrateur depuis le 
menu CONFIGURATION ⇒ 
UTILISATEURS ⇒ 
Comptes temporaires, leur 
mots de passe est généré automatiquement et la validité des comptes 
peut être limitée dans le temps. Ainsi, l’administrateur n’est pas obligé 
d’ajouter ces utilisateurs dans l’annuaire (interne ou externe) pour qu’ils 
puissent s’authentifier. 

• 
Parrainage : Permet à un utilisateur identifié par son nom et prénom 
d’accéder au réseau grâce au parrainage d’un utilisateur local ayant les 
droits pour cela. L’utilisateur est invité d’abord, depuis le portail captif, à 
saisir son nom, prénom et l’adresse e-mail du parrain. Ce dernier reçoit 
alors un e-mail contenant un lien pour valider cette requête. Suite à la 
validation, le parrainé est automatiquement redirigé du portail captif vers 
la page Web demandée. 
• 
Invités : Permet à un utilisateur d’accéder au réseau après validation des 
conditions générales d’utilisation sur le portail d’authentification. Cette 
méthode est généralement utilisée dans des lieux publics tels que les 
hôtels, les gares ou les hot-spot publics. 
• 
Les méthodes implicites ou transparentes :l’authentification est transparente vis-
à-vis de l’utilisateur qui n’a pas besoin de renseigner son identité explicitement 
pour accéder au réseau. 
• 
Certificat SSL :L’utilisateur est authentifié automatiquement au moyen 
d’un certificat installé sur sa machine (dans son navigateur par exemple), 
• 
Authentification transparente (SPNEGO) : Si l’utilisateur est authentifié 
sur un domaine Active Directory, il est automatiquement authentifié sur le 
firewall suite à la connexion à un site en HTTP, 
• 
Agent SSO (Single Sign-On) : Si l’utilisateur est déjà authentifié sur un 
domaine Active Directory, il est également automatiquement authentifié 
sur le firewall. 
NOTE : 

• 
Le « multi-utilisateurs » avec la méthode cookie permet à plusieurs utilisateurs de 
s’authentifier depuis la même adresse IP. Étant donné que les utilisateurs sont 
distingués par des cookies dans les requêtes HTTP, cette option fonctionne donc 
uniquement pour les flux HTTP (ou HTTPS déchiffrés) passant dans le proxy HTTP. 
Elle est disponible avec toutes les méthodes d’authentification à l’exception de 
l’agent SSO. 
• 
Les méthodes d’authentification implicites sont détaillées dans la formation 
Expert CSNE. 
379 


Utilisateurs & authentification 

21 
LES MÉTHODES D’AUTHENTIFICATION
Les méthodes d’authentification utilisées par le firewall peuvent être ajoutées depuis 
le menu CONFIGURATION ⇒ 
UTILISATEURS ⇒ 
Authentification ⇒ 
onglet 
MÉTHODES DISPONIBLES. Chaque méthode nécessite de renseigner des paramètres 
spécifiques. 

Suite à la configuration d’un annuaire LDAP pour ce qui concerne l’exemple ci-dessus 
la méthode d’authentification LDAP est renseignée automatiquement. 


380 


Utilisateurs & authentification 

• 
La politi􀆋ue d’authentification 
➔
• 
Introduction 
• 
Liaison à un annuaire 
• 
Gestion des utilisateurs 
• 
Les 􀅵éthodes 
d’authentification 
• 
Le portail captif 
• 
Règles de filtrage pour l’authentification 
• 
Définir de nouveaux administrateurs 
• 
Lab -Authentification 
Utilisateurs & authentification 


381 


Utilisateurs & authentification 

23 
LAPOLITIQUE D’AUTHENTIFICATION 
Puisque les firewalls SNS supportent plusieurs annuaires et plusieurs méthodes 
d’authentification 
simultanément, il est nécessaire de définir une politique 
d’authentification 
pour indiquer la ou les méthodes à appliquer en fonction de deux 
critères : l’utilisateur 
ou le groupe d’utilisateurs, 
et l’adresse 
IP source ou l’interface 
d’entrée. 

La politique d’authentification 
est définie dans le menu CONFIGURATION ⇒ 
UTILISATEURS ⇒ 
Authentification ⇒ 
onglet POLITIQUE D’AUTHENTIFICATION. Elle 
peut être constituée de plusieurs règles appliquées en fonction de leur ordre. 

Plusieurs méthodes d’authentification 
peuvent être utilisées par une seule règle. 
Dans ce cas, les méthodes sont appliquées suivant l’ordre 
d’apparition 
dans la règle. 
Si une méthode permet d’authentifier 
l’utilisateur, 
les méthodes suivantes ne seront 
pas testées. Par exemple, dans la règle 9, tous les membres du group « chief » du 
domaine « a-team.com » qui se connectent depuis le réseau « net_secret » doivent, 
en premier lieu, s’authentifier 
via la méthode Agent SSO. Si l’authentification 
échoue, 
alors on propose à l’utilisateur 
de sélectionner son certificat. Enfin, si cette seconde 
méthode n’aboutit 
pas (pas de certificat pour cet utilisateur par exemple), il est 
convié à renseigner un couple d’identifiant/􀅵ot 
de passe pour une authentification 
via la méthode LDAP. 
Dans le cas où aucune règle ne correspond aux critères du trafic, la méthode 
d’authentification 
par défaut est appliquée. 

NOTE : lors􀆋u’elle 
est utilisée dans une règle, la méthode Agent SSO est 
automatiquement la plus prioritaire des méthodes parce que cette dernière 
authentifie l’utilisateur 
sur le firewall dès son authentification sur le domaine Active 
Directory. 


382 


Utilisateurs & authentification 

24 
•Créer unepolitiqued’authentificationLA POLITIQUE D’AUTHENTIFICATION 
Pour ajouter une règle d’authentification, il faut cliquer sur le bouton Nouvelle règle 

⇒Règle Standard. La création de la règle s’effectue via un assistant en 3 étapes : 
1. Renseigner les utilisateurs ou les groupes, 
2. Renseigner les réseaux ou les interfaces sources. Dans le cas de la création d’un 
premier annuaire, le rattachement du profil d’authentification 0 (internal) à une 
interface est proposé lors de la création de l’annuaire. Sinon le rattachement 
peut s’effectuer dans le menu CONFIGURATION ⇒ 
UTILISATEURS ⇒ 
Authentification ⇒ 
PORTAIL CAPTIF, en ajoutant une entrée dans la liste 
CORRESPONDANCE ENTRE PROFIL D’AUTHENTIFICATION ET INTERFACE. 
Dans l’entrée, il faut sélectionner l’interface et le profil. La méthode ou l’annuaire par 
défaut sont renseignés automatiquement en fonction de ce qui est configuré sur le 
profil sélectionné. 

3. Choisir les méthodes d’authentification à utiliser (kerberos, Radius, SSL, 
SPNEGO, Agent SSO, méthode par défaut et interdire). 
Pour les autres méthodes : invités, comptes temporaires et parrainage, l’ajout 
s’effectue respectivement avec les boutons : Nouvelle règle ⇒ 
Règle invités, Règle 
comptes temporaires et règle Parrainage. 


383 


Utilisateurs & authentification 

25 
•Exemple d’unepolitiqued’authentificationLDAPLA POLITIQUE D’AUTHENTIFICATION 
Dans la politique d’authentification, 
vous pouvez créer une politique pour 
déterminer les réseaux et les utilisateurs qui utiliseront la méthode LDAP, ou la 
définir comme la méthode par défaut. 


384 


Utilisateurs & authentification 

• 
Le portail captif 
➔
• 
Introduction 
• 
Liaison à un annuaire 
• 
Gestion des utilisateurs 
• 
Les 􀅵éthodes 
d’authentification 
• 
La politi􀆋ue d’authentification 
• 
Règles de filtrage pour l’authentification 
• 
Définir de nouveaux administrateurs 
• 
Lab -Authentification 
Utilisateurs & authentification 


385 


Utilisateurs & authentification 

27 
•URL du portail : https://(@IP_firewall | FQDN_firewall)/auth 
LE PORTAIL CAPTIF 
Le portail captif, ou portail d’authentification, 
est une page web embarquée sur le 
firewall et accessible via une connexion sécurisée (HTTPS) depuis ses adresses IP (il 
peut être activé sur toutes les interfaces du firewall). 

Les usages du portail captif sont les suivants : authentifier des utilisateurs pour 
accéder au réseau, enrôler de nouveaux utilisateurs, créer et télécharger un 
certificat, télécharger le client VPN SSL et sa configuration, faire une demande de 
parrainage pour accéder au réseau, etc. 

Les utilisateurs peuvent se connecter sur le portail en utilisant leur identifiant/mot 
de passe d’annuaire. Dans le cas où plusieurs annuaires sont configurés au niveau du 
firewall, les utilisateurs peuvent ajouter à l’identifiant 
le nom du domaine auquel ils 
appartiennent, par exemple, j.doe@company-a.com. Si le nom du domaine n’est 
pas 
précisé, l’authentification 
s’effectuera 
avec la méthode ou avec l’annuaire 
défini par 
défaut au niveau du profil d’authentification. 


386 


Utilisateurs & authentification 

28 
LE PORTAIL CAPTIF 
La configuration du portail captif s’effectue 
depuis le menu CONFIGURATION ⇒ 
UTILISATEURS ⇒Authentification ⇒onglet PORTAIL CAPTIF. L’onglet 
est constitué 
de plusieurs encadrés : 

• 
CORRESPONDANCE ENTRE PROFIL D’AUTHENTIFICATION 
ET INTERFACE : Il existe 
10 profils différents pour le portail captif qui sont nommés profils 
d’authentification. Pour activer le portail sur une interface, il suffit d’ajouter 
une 
ligne dans cet encadré, sur laquelle il faut sélectionner une interface et un profil 
d’authentification. Un seul profil peut être sélectionné par interface. 
• 
SSL Server : Permet de modifier le certificat présenté par le portail captif. 
387 


Utilisateurs & authentification 

29 
LE PORTAIL CAPTIF 
• 
Condition d’utilisation 
de l’acc􀄟s 
à Internet : Permet d’ajouter une charte 
d’utilisation 
de l’accès 
réseau qui doit être acceptée par l’utilisateur 
une fois 
authentifié. Elle peut être téléchargée en format PDF ou en format HTML. Le 
bouton Réinitialiser la personnalisation des conditions d’utilisation 
de l’acc􀄟s 
à 
Internet permet de supprimer une charte préalablement téléchargée. 
• 
Configuration avancée : 
• 
Interrompre les connexions lorsque l’authentification 
expire, 
• 
Fichier de configuration du proxy (.pac), 
• 
Portail captif : Permet de modifier le port du portail captif, et son 
apparence : masquer le logo Stormshield sur le portail, télécharger un 
nouveau logo et modifier la feuille de style. 
388 


Utilisateurs & authentification 

30 
LE PORTAIL CAPTIF 
Les profils d’authentification 
peuvent être configurés dans le menu CONFIGURATION 

⇒UTILISATEURS ⇒Authentification ⇒onglet PROFILS DU PORTAIL CAPTIF. La liste 
déroulante permet de sélectionner le profil que vous souhaitez modifier. Il existe 10 
profils différents, les cinq premiers sont préconfigurés : 
• 
internal, external : Ils possèdent la même configuration. Le premier est destiné à 
être attaché aux interfaces internes et le deuxième aux interfaces externes en 
utilisant n’i􀅵porte 
quelle méthode d’authentification 
utilisant le portail captif, 
• 
Guest : Préconfiguré pour la méthode d’authentification 
invité, 
• 
Voucher : Préconfiguré pour la méthode d’authentification 
des comptes 
temporaires, 
• 
Sponsor : Préconfiguré pour la méthode d’authentification 
par parrainage. 
389 


Utilisateurs & authentification 

31 
LE PORTAIL CAPTIF 
Il faut configurer la méthode ou l’annuaire 
par défaut utilisé par le profil sélectionné 
dans l’étape 
précédente. Dans le cas d’une 
authentification LDAP, ce paramètre peut 
prendre deux valeurs : 

• 
Annuaire LDAP (none) : Signifie 􀆋u’il 
n’y 
a aucun annuaire par défaut. Les 
utilisateurs qui s’authentifient 
depuis le portail captif doivent renseigner 
leur identifiant accompagné du domaine, par exemple, 
j.smith@institute.com. Dans le cas où le domaine n’est 
pas renseigné, 
l’authentification 
échoue. 
• 
Annuaire LDAP (Domaine) : Signifie que l’annuaire 
du domaine 
sélectionné est utilisé pour authentifier les utilisateurs qui renseignent 
seulement leur identifiant (sans le domaine) depuis le portail captif, par 
exemple, j.smith. Les utilisateurs des autres domaines doivent, quant à 
eux, doivent renseigner le domaine avec l’identifiant 
pour être 
authentifiés. 
NOTE : la méthode ou l’annuaire 
par défaut, ne restreint pas ce profil seulement à 
cette méthode ou à cet annuaire. La restriction peut se faire seulement avec une 
politique d’authentification. 

• 
Conditions d’utilisation 
d’acc􀄟s 
internet : Regroupe les paramètres qui contrôlent 
l’affichage 
des conditions d’utilisation 
d’accès 
internet renseignées dans l’onglet 
PORTAIL CAPTIF. Il contient également trois champs personnalisables qui 
s’affichent 
sur le portail d’authentification 
avec la méthode invité et qui 
permettent de récupérer différentes informations sur l’invité 
(Prénom, Nom, 
Téléphone, E-mail, etc.). 
390 



Utilisateurs & authentification 

32 
LE PORTAIL CAPTIF 
• 
Durées d’authentification 
autorisées : Permet de configurer les durées maximum 
et minimum d’authentification 
pour l’authentification 
explicite. L’utilisateur 
peut 
choisir une durée comprise dans ces limites lors de l’authentification. Il permet 
également de choisir la durée d’authentification 
pour les méthodes transparentes 
(Certificats SSL et SPNEGO). 
• 
Configuration avancée : 
• 
Gestion du portail (notamment activation pour un profil, activation de la 
page de déconnexion), 
• 
Définition de la politique appliquée aux mots de passe des utilisateurs, 
• 
Gestion de l’enrôle􀅵ent 
des utilisateurs depuis le portail captif. 
391 


Utilisateurs & authentification 

33 
•Déconnexion depuis le navigateur 
LE PORTAIL CAPTIF 
Lorsque la case Activer la page de déconnexion est cochée dans le menu 
CONFIGURATION ⇒ 
UTILISATEURS ⇒ 
Authentification ⇒ 
onglet PROFILS DU 
PORTAIL CAPTIF (configuration avancée). Un onglet de déconnexion s’ouvre 
dans le 
navigateur de l’utilisateur 
ayant réussi à se connecter. Pour se déconnecter, 
l’utilisateur 
doit simplement cliquer sur le bouton Déconnexion de cet onglet. 


392 


Utilisateurs & authentification 

34 
•Déconnexion depuis le portail captif 
LE PORTAIL CAPTIF 
Pour se déconnecter, l’utilisateur 
doit se connecter de nouveau au portail captif, 
cliquer sur Connexion dans le menu de gauche et ensuite sur le bouton 
Déconnexion. 


393 


Utilisateurs & authentification 

35 
•Déconnexiond’unutilisateur depuis l’interfacegraphiqueLE PORTAIL CAPTIF 
L’administrateur peut déconnecter les utilisateurs depuis l’interface Web dans le 
menu Supervision puis Utilisateurs. Cliquez sur l’utilisateur avec le bouton droit, et 
ensuite sur Déconnecter l’utilisateur. 


394 


Utilisateurs & authentification 

36 
•Activationde l’enrôlement sur le portailcaptif 
LE PORTAIL CAPTIF 
Lorsdel’ajout dela baseLDAP 
interne ou externe 
Depuis le profil du portail captif 
L’enrôlement permet aux utilisateurs de s’auto-enregistrer depuis le portail captif. La 
demande d’enregistrement est envoyée au firewall pour être d’abord soumise à 
l’approbation de l’administrateur. Une fois approuvé, l’utilisateur est ajouté 
automatiquement dans l’annuaire. 

L’enrôlement peut être activé lors de l’ajout d’un annuaire, mais seulement sur le 
profil 0 (internal). Sinon, il peut être activé également depuis le profil 
d’authentification, dans l’encadré Enrôlement d’utilisateurs situé dans la 
Configuration avancée. 

NOTE :l’enrôlement ne peut pas être activé avec un annuaire Active Directory, car 
sur ce type d’annuaire, il est impossible d’ajouter un utilisateur depuis le firewall. 


395 


Utilisateurs & authentification 

37 
LE PORTAIL CAPTIF 
•Formulaire d’enrôlement 
Lorsque l’enrôlement est activé, les utilisateurs peuvent s’enregistrer en remplissant 
un formulaire accessible, en cliquant sur le bouton Nouvel utilisateur dans le menu 
de gauche du portail captif. Une fois remplie, l’utilisateur envoie sa demande en 
cliquant sur Soumettre ces informations. 

NOTE :l’enrôlement est utilisé en règle générale pour enregistrer les utilisateurs 
externes à l’entreprise dans votre annuaire. Le domaine indiqué dans l’adresse de 
messagerie est dans ce cas différent du vôtre. 


396 


Utilisateurs & authentification 

38 
•Configurationde l’enrôlement 
LE PORTAIL CAPTIF 
L’administrateur peut modifier l’identifiant (login) de l’utilisateur généré 
automatiquement avec le format par défaut %F.%L, ce qui correspond à 
FIRSTNAME.LASTNAME (la casse étant respectée). 
La modification doit être appliquée avant de valider le premier enrôlement, afin que 
tous les identifiants respectent les mêmes règles. 
Avec l’utilisateur John Doe montré en exemple : 

• 
%f1.%l : Donne « j.doe » (sans espace : première lettre du prénom en minuscule, 
point, et nom en minuscules), 
• 
%f%L1 : Donne « johnD » (sans espace : prénom en minuscules, première lettre 
du nom en majuscule). 
L’administrateur peut activer également la notification par mail lors de l’acceptation 
ou le rejet des demandes des utilisateurs. Pour cela un serveur mail doit être 
configuré sur le firewall dans le menu CONFIGURATION ⇒ 
NOTIFICATIONS ⇒ 
Alertes e-mails. 


397 


Utilisateurs & authentification 

39 
•Validationdel’enrôlement 
LE PORTAIL CAPTIF 
Sur l’interface 
d’ad􀅵inistration 
du firewall, les demandes d’enrôle􀅵ent 
sont listées 
dans le menu CONFIGURATION ⇒ 
UTILISATEURS ⇒ 
Enrôlement. L’ad􀅵inistrateur 
peut approuver, rejeter ou ignorer la demande. En cas d’approbation, 
l’identifiant 
(login) de l’utilisateur 
est généré automatiquement selon le format choisi à l’étape 
précédente. 


398 


Utilisateurs & authentification 

• 
Règles de filtrage pour l’authentification 
➔
• 
Introduction 
• 
Liaison à un annuaire 
• 
Gestion des utilisateurs 
• 
Les méthodes d’authentification 
• 
La politique d’authentification 
• 
Le portail captif 
• 
Définir de nouveaux administrateurs 
• 
Lab -Authentification 
Utilisateurs & authentification 


399 


Utilisateurs & authentification 

41 
•Créer des règles de filtrage et de NAT spécifiques pour 
des utilisateurs ou des groupes 
RÈGLES DE FILTRAGEPOURL’AUTHENTIFICATION
La règle d’authentification 
permettant seulement de rediriger les utilisateurs 
inconnus vers le portail captif, il faut impérativement ajouter par la suite d’autres 
règles permettant aux utilisateurs authentifiés d’accéder 
au réseau. 
Lors de l’édition 
de la source d’une 
règle de filtrage ou de NAT, le champ Utilisateur 
permet de spécifier l’utilisateur 
(ou le groupe) devant être authentifié pour que la 
règle s’appli􀆋ue. Plusieurs entrées sont listées : 

• 
No User : Choix par défaut lors de l’ajout 
d’une 
nouvelle règle. La règle sera 
appliquée sans prendre en considération le paramètre utilisateur, 
• 
Any user@any : Désigne tout utilisateur authentifié, quel que soit 
l'annuaire ou la méthode d'authentification utilisés, 
• 
Any user@guest_users.local.domain : Désigne tout utilisateur authentifié 
par la méthode invité, 
• 
Any user@voucher_users.local.domain : Désigne tout utilisateur 
authentifié par la méthode comptes temporaires, 
• 
Any user@sponsored_users.local.domain : Désigne tout utilisateur se 
présentant via la méthode parrainage, 
• 
Any user@<domaine> : Désigne tout utilisateur authentifié par l’annuaire 
du domaine, 
• 
Any user@none : Désigne tout utilisateur authentifié par une méthode 
n’utilisant 
pas un annuaire, par exemple : parrainage, compte temporaire, 
etc. 
• 
Utilisateurs inconnus: Désigne tout utilisateur non authentifié. Cette 
valeur est principalement utilisée dans une règle d’authentification. 
• 
La liste de tous les utilisateurs et groupes présents dans les annuaires. 
Le bouton à droite du paramètre utilisateur permet de filtrer les utilisateurs en 
fonction de l’annuaire 
ou de la méthode d’authentification. 
400 



Utilisateurs & authentification 

RÈGLES DE FILTRAGEPOURL’AUTHENTIFICATION
• 
Mécanisme de redirection vers le portail captif 
42 
Tentative d’accès à unsite enHTTPhttp://www.bbc.com 
Redirection vers le portail captif 
https://@IP_firewall/auth 
Identifiant/mot de passe de 
l’utilisateur 
Authentificationde l’utilisateur 
par la base LDAP interne ou 
LDAP/AD externe 
Redirection vers le site en HTTP 
http://www.bbc.com 
Requête HTTP interceptée 
par le firewall 
L’authentification 
LDAP via le portail captif est décrite ci-dessus. L’utilisateur 
ouvre 
un navigateur pour accéder à un site en HTTP. La requête HTTP est interceptée par le 
firewall qui renvoie l’utilisateur 
vers le portail d’authentification 
(https://@IP_firewall/auth). L’utilisateur 
introduit son identifiant/mot de passe 
d’annuaire 
qui sont envoyés au firewall via une connexion sécurisée (HTTPS). Le 
firewall authentifie l’utilisateur 
au niveau de l’annuaire 
(LDAP interne/externe ou 
AD). Dans le cas où l’utilisateur 
est authentifié, le navigateur est renvoyé vers le site 
web demandé au départ. 

NOTE : la redirection vers le portail captif peut fonctionner en accédant à des sites 
en HTTPS, mais cela nécessite l’activation 
du proxy SSL qui est présenté dans la 
formation expert CSNE. 

La configuration LDAP via le portail captif est détaillée dans les diapositives 
suivantes. 


401 


Utilisateurs & authentification 

43 
•Rediriger les requêtes HTTP des utilisateurs non 
authentifiés vers le portail captif 
RÈGLES DE FILTRAGEPOURL’AUTHENTIFICATION
La redirection des connexions HTTP vers le portail d’authentification 
s’effectue 
par 
une règle d’authentification 
dans les règles de filtrage. Cependant, avant d’ajouter 
cette règle, il faut s’assurer 
que les connexions DNS sont autorisées pour tous les 
utilisateurs (authentifiés ou non), car sans résolution DNS, il n’y 
aura pas de requêtes 
HTTP et par conséquent, pas de redirection vers le portail captif. 

Pour créer la règle d’authentification 
cliquez sur Nouvelle règle ⇒ 
Règle 
d’authentification. Au niveau de l’assistant, 
il faut renseigner le réseau source d’où 
les utilisateurs se connectent, le réseau destination et éventuellement une liste de 
catégories d’URLs 
qui sont accessibles sans authentification. 


402 


Utilisateurs & authentification 

• 
Définir de nouveaux administrateurs 
➔
• 
Introduction 
• 
Liaison à un annuaire 
• 
Gestion des utilisateurs 
• 
Les méthodes d’authentification 
• 
La politique d’authentification 
• 
Le portail captif 
• 
Règles de filtrage pour l’authentification 
• 
Lab -Authentification 
Utilisateurs & authentification 


403 


Utilisateurs & authentification 

45 
•Droitsd’administrationparticuliers•Créer des comptes permettant de visualiser ou modifier la 
configuration 
•Choix des modules à affecter 
DÉFINIR DE NOUVEAUX ADMINISTRATEURS 
Depuis le menu Configuration ⇒ 
Système ⇒ 
Administrateurs ⇒ 
Onglet 
Administrateurs, il est possible de définir une politique de droits d’accès 
en fonction 
des utilisateurs de la base LDAP. Ainsi, plusieurs statuts sont disponibles : 

• 
Administrateur sans droit, 
• 
Administrateur avec accès en lecture seule uniquement, 
• 
Administrateur avec tous les droits, 
• 
Administrateur de comptes temporaires : autorise la création des comptes 
pour la méthode d’authentification 
compte temporaire, 
• 
Administrateur avec accès aux données sensibles : permet d’avoir 
un accès 
complet aux logs, 
• 
Administrateur sans accès aux données sensibles : restreint l’accès 
à 
certaines informations dans les logs. 
L’édition 
des règles propose deux modes d’affichage, 
la vue simple et la vue avancée 
(comme ci-dessus) pour obtenir davantage de détails sur les droits accordés. 


404 


Utilisateurs & authentification 

DÉFINIR DE NOUVEAUX ADMINISTRATEURS 
• 
Chaque administrateur peut modifier son mot de passe 
• 
Un administrateur ne peut pas modifier le mot de passe 
d’un 
autre 
administrateur 
• 
« admin » peut modifier le mot de passe de tout le 
monde 
• 
Un administrateur avec les droits « utilisateur » peut 
modifier le mot de 
passe 
d’un 
simple utilisateur 
46 


405 


Utilisateurs & authentification 

RECOMMANDATIONS 
• 
Protéger le compte administrateur local 
• 
Utiliser des comptes nominatifs 
• 
Utiliser des groupes pour gérer les droits 
• 
Ajuster les droits d’administration, séparer lesrôles 
• 
Authentifier localement par certificat 
• 
Dédier un annuaire externe aux administrateurs 
• 
Configurer LDAP de manière sécurisée 
• 
Utiliser un 
compted’accèsà l’annuairerestreint et 
sécurisé 


47 

Le mot de passe administrateur doit être conservé au coffre-fort et son utilisation 
exceptionnelle doit être supervisée et limitée à un ensemble déterminé de 
personnes. Il ne doit être utilisé que pour l’accès SSH ou pour établir les droits des 
utilisateurs. 

Seul le compte administrateur local peut attribuer les droits administratifs. C’est 
pour cela qu’il est recommandé d’attribuer des droits à des groupes. Les comptes 
des utilisateurs seront ensuite répartis dans les groupes (cette opération peut se 
faire depuis l’annuaire). 

Un administrateur dédié à une tâche précise ne doit avoir qu’un périmètre d’action 
limité. Cela permet de cloisonner les risques en cas de compromission de son 
compte, ainsi que limiter les modifications involontaires de configuration. 

L’accès à l’annuaire LDAP externe doit être configuré de manière sécurisée et 
redondante. Le compte utilisé pour authentifier le firewall sur l’annuaire doit avoir le 
minimum de droits (lecture seule) et être spécifique. 


406 


Utilisateurs & authentification 

48 
Pour aller plus loin, consultez les notes techniques du site documentation.stormshield.eu : 

• 
Configuration SSO -Microsoft SPNEGO 
• 
Configurer les méthodes d'authentification de type « Guest » 
• 
Installation et déploiement de l’agent 
SSO 
• 
Se conformer aux règlements sur les données personnelles 
Et pour les situations/questions très spécifiques, consultez la base de connaissance du TAC 
kb.stormshield.eu. 



419 


Virtual Private Network 

5 
VPN IPSEC –CONCEPTS ET GÉNÉRALITÉS 
@IP FW A @IP FW B 
Réseau Local A 
ou 
Interface VTI_A 
Réseau distant B 
ou 
interface VTI_B 
Extrémités de trafic ou sélecteurs de trafic 
Extrémités de tunnel 
@IP A, @IP B Données…
Pa􀆋uet d’origineOuverture du tunnel 
@IP A, @IP B Données…E_ESP @IP FW A, @IP FW B F_ESP Auth 
Champs chiffrés 
Champs authentifiés 
Paquet d’origine 
ISAKMP = IKE v1 ou v2 
@IP A @IP B 
Transmission de données dans le tunnel @IP A, @IP B Données…
Le tunnel VPN IPsec site-à-site permet de connecter deux réseaux privés via un réseau 
public tout en assurant les services de sécurité suivants : 

• 
L’authentification : Permet la vérification des identités des deux extrémités de tunnel. 
Deux méthodes d’authentification 
sont possibles : clé pré-partagée (PSK : Pre-Shared 
key) ou certificats (PKI : Public Key Infrastructure), 
• 
L’intégrité : Vérifie que les données n’ont 
pas été modifiées en utilisant les 
algorithmes de hachage, 
• 
La confidentialité : Assure que les données ne peuvent être lues par une personne 
tierce capturant le trafic, 
• 
L’anti-rejeu : Permet d'ignorer des anciens paquets (des paquets dont le numéro de 
séquence est antérieur à un certain seuil) déjà reçus, s'ils sont transmis à nouveau. 
Le tunnel VPN IPsec site-à-site peut s’établir 
entre le firewall SNS et n’i􀅵porte 
quel 
équipement compatible VPN IPsec. La négociation du tunnel s’effectue 
avec le protocole 
ISAKMP (Internet Security Association Key Management Protocol), appelé également IKE 
(Internet Key Exchange), qui existe actuellement en deux versions V1 (RFC 2409) et V2 
(RFC 7296). 

La négociation s’effectue 
entre les extrémités de tunnel qui correspondent aux adresses 
IP des équipements (@IP FW A et @IP FWB). Le protocole IKE est transmis via le 
protocole UDP sur le port 500. 


420 


Virtual Private Network 

Une fois le tunnel établi entre les deux équipements, les extrémités de trafic 
correspondantes aux réseaux privés peuvent communiquer via le protocole ESP 
(Encapsulating Security Payload) qui assure la confidentialité et l’intégrité des 
données. Le protocole ESP (le numéro de protocole IP est 50, défini dans RFC 4303) 
est encapsulé directement dans un paquet IP. 

Deux modes de fonctionnement conditionnent différemment la décision 
d’encapsuler les paquets IP dans ESP : 

• 
Correspondance de politique (fonctionnement standard) : Concordance des 
adresses IP des usagers avec la politique VPN IPsec ; ce mode de fonctionnement 
repose sur les critères [IP source + IP de destination] de ces paquets IP en 
comparaison avec la politique chargée dans les structures IPsec du système. Dans 
ce mode de fonctionnement, la politique IPsec est évaluée en amont des 
directives générales de routage IP. Son application repose exclusivement sur la 
correspondance de politique. 
• 
Virtual Tunneling Interface (mode de fonctionnement si le routage par VTI est 
activé) : Routage via la VTI (Virtual Tunneling Interface) distante dont l'adresse IP 
appartient au même réseau que la VTI locale. Les interfaces VTI permettent de 
définir des routes passant par le tunnel IPsec. Elles agissent comme passerelles 
réciproques l’une de l’autre. Elles sont comme des points d’entrée et de sortie du 
tunnel. Ce mode de fonctionnement est prioritaire sur la correspondance de 
politique. 
NOTE : 

• 
Dans le cas où une extrémité de tunnel est située dans un réseau translaté, NAT-
Traversal sera activé automatiquement afin que le protocole UDP sur le port 4500 
soit utilisé pour finaliser la négociation IKE et transmettre les paquets ESP (thème 
abordé dans la formation CSNE). 
421 


Virtual Private Network 

VPN IPSEC –CONCEPTS ET GÉNÉRALITÉS 
• 
Les identités des correspondants : 
• 
Site-à-site avec adresses IP fixes 
@IP FW A @IP FW B 
Firewall A Firewall B 
• 
Site-à-site avec un correspondant dont l’adresse IP 
est 
dynamique 
@IP FW A 
FQDN 
fw.company-b.com 
Firewall B Firewall A 
7 

Durant l’authentification, 
chaque extrémité vérifie l’identité 
de l’autre. Les identités 
pouvant représenter une extrémité de tunnel sont : 

• 
L’adresse 
IP de l’interface 
réseau externe « Firewall_out » dans le cas où elle est 
configurée avec une adresse IP fixe, 
• 
Un FQDN dans le cas où une extrémité ne possède pas d’adresse 
IP fixe. 
En fonction de la méthode d’authentification 
utilisée, l’identité 
est associée à : 

• 
Une clé pré-partagée PSK (Pre-Shared Key) : Chaque extrémité fera la preuve 
􀆋u’elle 
détient la PSK commune. 
• 
Une PKI (Public Key Infrastructure) : Chaque extrémité présentera un certificat 
numérique X509 qui doit être signé par une autorité de certification de confiance 
pour l’autre 
correspondant. L’utilisation 
de certificat pour l’authentification 
est 
abordée dans la formation expert CSNE. 
422 


Virtual Private Network 

VPN IPSEC –CONCEPTS ET GÉNÉRALITÉS 
Profil de chiffrement phase 1 
•Algorithme de chiffrement : 
AES, Blowfish 
•Fonction de hachage : sha1, 
sha2 
•Groupe pour Diffie-Hellman 
•Durée de vie maximum (s) 
Authentification : PSK, PKI 
Profil de chiffrement phase 2 
•Perfect Forward Secrecy 
(PFS) 
•Durée de vie (s) 
•Code d’authentification : 
HMAC-SHA1, HMAC-MD5 
•Algorithme de chiffrement : 
AES, Blowfish 
Extrémités de trafic 
IKE Phase 1 
Profil de chiffrement phase 1 
•Algorithme de chiffrement : 
AES, Blowfish 
•Fonction de hachage : sha1, 
sha2 
•Groupe pour Diffie-Hellman 
•Durée de vie maximum (s) 
Authentification : PSK, PKI 
IKEv1 : ISAKMP-SA 
IKEv2 : PARENT-SA 

IKE Phase 2 
IKEv1 : ESP-SA 2, IKEv2 : Child-SA 2 

Profil de chiffrement phase 2 
•Perfect Forward Secrecy 
(PFS) 
•Durée de vie (s) 
•Code d’authentification : 
HMAC-SHA1, HMAC-MD5 
•Algorithme de chiffrement : 
AES, Blowfish 
Extrémités de trafic 
8 

IKEv1 : ESP-SA 1, IKEv2 : Child-SA 1 


La négociation IKE pour l’établisse􀅵ent 
d’un 
tunnel VPN IPsec se déroule en deux 
phases : 

• 
Phase 1 : Durant cette phase, les deux extrémités de tunnel négocient un profil de 
chiffrement phase 1 qui contient les algorithmes de chiffrement/authentification. 
Durant cette phase également, les deux extrémités s’authentifient 
avec une clé 
pré-partagée ou les certificats. 
Si les deux extrémités n’arrivent 
pas à se mettre d’accord 
sur un profil de 
chiffrement commun ou à s’authentifier, 
la phase 1 échoue et la négociation 
s’arr􀄡te. 
Dans le cas contraire, un dialogue d'application chiffré, nommé ISAKMP-SA 
(Internet Security Association Key Management Protocol – 
Security Association) 
dans IKEv1 ou PARENT-SA dans IKEv2, est établi entre les deux extrémités. Il 
permet la négociation de la phase 2 qui sera entièrement chiffrée grâce à la clé de 
phase 1 ISAKMP-SA. 
• 
Phase 2 : Durant cette phase les deux extrémités négocient le profil de 
chiffrement phase 2 et les extrémités de trafic qui pourront communiquer via le 
tunnel VPN IPsec. 
423 


Virtual Private Network 

Si les deux extrémités ne parviennent pas à faire concorder ces paramètres, la phase 
2 échoue, sinon, deux canaux sont ouverts pour la transmission des données (un 
dans chaque direction). Chaque canal utilise sa propre clé de chiffrement. Elles sont 
appelées ESP-SA1 et ESP-SA2 en IKEv1 et CHILD-SA1 et CHILD-SA2 en IKEv2. Ainsi 
chaque extrémité possédera les deux clés symétriques : une pour chiffrer les 
données transmises et l’autre 
pour déchiffrer les données reçues. 

NOTES : 

• 
En IKEv1, la négociation phase 1 peut se faire avec deux modes MAIN ou 
AGGRESSIVE. Ce dernier est plus simple et plus rapide (échange de 3 paquets au 
lieu de 6 en mode MAIN) mais est moins sécurisé. Il n’est 
plus supporté depuis la 
version 4.2. 
• 
En IKEv1, il est impératif que les extrémités de trafic soient identiques pour les 
deux correspondants, sinon la phase 2 échoue. Ce n’est, 
en revanche, pas 
obligatoire en IKEv2 mais il est fortement recommandé de configurer ces 
paramètres à l’identi􀆋ue 
afin d’éviter 
tout effet de bord indésirable. 
• 
Pour simplifier et conserver une certaine homogénéité dans la présentation des 
logs, les firewalls SNS utilisent la terminologie de IKEv1 (phase 1 et phase 2) sur 
IKEv2. 
• 
La négociation du tunnel est déclenchée par le correspondant dont le réseau local 
a initié du trafic vers le réseau distant. Par conséquent, s’il 
n’y 
a pas de trafic entre 
les réseaux, le tunnel ne sera pas ouvert. 
424 


Virtual Private Network 

• 
VPN IPsec – 
Configuration de tunnel site-àsite 
➔
• 
Les différents réseaux privés virtuels 
• 
VPN IPsec – 
Concepts et généralités 
• 
VPN IPsec – 
Configuration de tunnels site-à-site 
multiples 
• 
VPN IPsec – 
Virtual Tunneling Interface 
• 
Lab -VPN IPsec (site à site) 
Virtual Private Network 


425 


Virtual Private Network 

11 
VPN IPSEC -CONFIGURATIOND’UNTUNNELSITE-À-SITE 
La configuration d’un 
tunnel VPN IPsec site-a-site s’effectue 
depuis le menu VPN ⇒ 
VPN IPsec > onglet POLITIQUE DE CHIFFREMENT – 
TUNNELS > onglet SITE À SITE 
(GATEWAY – 
GATEWAY), en cliquant sur Ajouter ⇒Tunnel site à site. 


426 


Virtual Private Network 

12 
VPN IPSEC -CONFIGURATION D’UN TUNNEL SITE-À-SITE 
Un assistant s’affiche 
pour renseigner les principaux paramètres : les extrémités de 
trafic (réseaux local et réseau distant) et l’extré􀅵ité 
de tunnel distante (le 
correspondant). 

Si le correspondant n’existe 
pas, il faut le créer en cliquant sur le bouton AJOUTER 
(bleu) qui sera utilisé pour la négociation du tunnel. Un nouvel assistant s’affiche 
pour renseigner les paramètres du correspondant : la passerelle distante, le nom et 
la version IKE (1 ou 2). Par défaut, la version IKE 1 est utilisée. 

Le champ Passerelle distante permet de renseigner l’objet 
machine qui porte 
l’adresse 
IP du correspondant. 

REMARQUE : à partir de la version 4.2.4, la version IKE par défaut est IKEv2. 


427 


Virtual Private Network 

13 
VPN IPSEC -CONFIGURATIOND’UNTUNNELSITE-À-SITE 
Après avoir cliqué sur Suivant , l’assistant 
se poursuit et il est possible de configurer 
la méthode d’authentification. En sélectionnant PSK, la clé pré-partagée renseignée 
sera associée à l’identité 
du correspondant. 

Enfin, la dernière étape liste les paramètres renseignés et permet éventuellement 
d’ajouter 
une passerelle de secours. En cliquant sur Terminer, on retourne sur 
l’assistant 
de création du tunnel VPN. 


428 


Virtual Private Network 

14 
VPN IPSEC -CONFIGURATIOND’UNTUNNELSITE-À-SITE 
Une fois les trois paramètres (réseau local, réseau distant et le correspondant) 
renseignés, vous pouvez cliquer sur Terminer. Le tunnel VPN IPsec est ajouté sur une 
ligne distincte de la politique. L’ 
assistant crée une politique désactivée par défaut. 
Celle-ci doit être activée manuellement en définissant l’ 
État sur ACTIVE au sein de la 
politique. 


429 


Virtual Private Network 

15 
VPN IPSEC -CONFIGURATIOND’UNTUNNELSITE-À-SITE 
•Colonne « Nom » dans la vue « Politique » 
La colonne Nom peut être cachée par défaut ; pour la faire apparaître, cliquer sur 
l’en-tête de colonne, puis sélectionner le menu Colonnes et cocher l’option Nom. 
Elle affiche le nom des politiques. Dans les traces VPN (l_vpn), l’entrée rulename se 
rapporte à ce nom. 

NOTE: Un champ qui précise le type de règle VPN (tunnel mobile ou tunnel site-àsite) 
a été ajouté aux traces VPN IPsec également. 


430 


Virtual Private Network 

16 
VPN IPSEC -CONFIGURATIOND’UNTUNNELSITE-À-SITE 
L’onglet 
«Correspondant» liste les correspondants créés avec l’assistant 
et permet 
d’en 
créer d’autres. Dans tous les cas, il offre la possibilité de modifier ou de 
compléter leur configuration après la création. 

Parmi les paramètres modifiables, on trouve notamment : 

• 
Adresse locale : ce champ permet de sélectionner l’adresse 
IP présentée pour 
établir le tunnel avec le correspondant affiché. 
• 
ID du correspondant et local ID : sous forme d’une 
adresse IP, d’un 
FQDN ou 
d’une 
adresse mail, ce champ représente les extrémités locale et distante du 
tunnel partageant une PSK. En cas de traversée d’un 
équipement appliquant du 
NAT, il est nécessaire de renseigner son localID avec l’adresse 
IP «publique» 
apparente après traduction de l’adresse 
IP d’extré􀅵ité 
locale de tunnel. 
• 
Ne pas initier le tunnel : cette option indique au firewall de se mettre en écoute 
et de laisser l’initiative 
de la négociation du tunnel au correspondant. 
• 
Fragmentation IKE : permet d’activer 
la fragmentation des paquets IKE lorsque 
ces derniers dépassent la taille standard paramétrée sur le firewall (plus de détails 
en CSNTS). 
431 


Virtual Private Network 

17 
•Les profils de chiffrement phase 1 et phase 2 
VPN IPSEC -CONFIGURATION D’UN TUNNEL SITE-À-SITE 
Profil phase 1 (IKE) 
Profil phase 2 (IPSEC) 
Le profil de chiffrement phase 1 appelé également profil IKE est configuré au niveau 
du correspondant, tandis que le profil de chiffrement phase 2, appelé profil IPSEC est 
configuré au niveau du tunnel VPN. 


432 


Virtual Private Network 

18 
•Consulter, modifier et créer des profils de chiffrement 
phase 1 et phase 2 
VPN IPSEC -CONFIGURATIOND’UNTUNNELSITE-À-SITE 
Pour les deux phases, il existe quatre profils préconfigurés : StrongEncryption, 
GoodEncryption, Mobile et DR. L’onglet 
PROFILS DE CHIFFREMENT du menu VPN ⇒ 
VPN IPsec permet de : 

• 
Consulter et de modifier la configuration des profils préconfigurés, 
• 
Définir les profils qui seront utilisés par défaut lors de l’ajout 
des tunnels (à l’aide 
du paramètre Définir le profil par défaut ), 
• 
Créer de nouveaux profils phase 1 et phase 2 personnalisés en cliquant sur le 
bouton Ajouter. 
433 


Virtual Private Network 

19 
•La fonction Keepalive 
VPN IPSEC -CONFIGURATIOND’UNTUNNELSITE-À-SITE 
S’il n’est pas établi, un tunnel IPsec est négocié seulement lors de l’émission de 
paquets correspondant à la politique IPsec. Cela engendre de la latence et les 
premiers paquets risquent d’être perdus le temps de la négociation. La fonction 
Keepalive vise à maintenir le tunnel disponible en envoyant à intervalles réguliers un 
datagramme UDP correspondant aux extrémité du trafic sur le port UDP numéro 9, 
ce qui provoque la négociation initiale du tunnel, puis ses renégociations 
périodiques. 

La colonne keepalive peut être cachée par défaut. Pour la faire apparaître, cliquer 
sur l’en-tête de colonne, puis sélectionner le menu Colonnes et cocher l’option 
Keepalive. Elle permet de configurer la fréquence d’envoi de datagrammes UDP. Un 
positionnement sur 0 désactive cette fonction. 


434 


Virtual Private Network 

20 
•Les règles implicites autorisent le trafic IKE et ESP en 
provenance du correspondant distant. 
VPN IPSEC -CONFIGURATIOND’UNTUNNELSITE-À-SITE 
Pour les tunnels VPN IPsec site-à-site configurés avec des adresses statiques de 
correspondants, des règles implicites sont ajoutées automatiquement lors de la 
création du tunnel de façon à pouvoir recevoir le trafic constituant un tunnel VPN 
IPsec : les ports UDP/500, UDP/4500 et le protocole ESP. 

Ces règles ne concernent que les flux entrants car les flux sortants sont déjà couverts 
par les règles flux implicites du Firewall. 


435 


Virtual Private Network 

21 
•Règles de filtrage explicites pour autoriser le trafic entre 
les extrémités de trafic (les réseaux distants) 
VPN IPSEC -CONFIGURATIOND’UNTUNNELSITE-À-SITE 
Le trafic autorisé entre les usagers du tunnel doit être explicitement défini par des 
règles de filtrage : 

• 
La première règle permet l’initiation de connexions à partir du réseau local 
Network_in et à destination du réseau distant NET_IN_B. 
• 
La deuxième règle permet, quant à elle, l’initiation de connexions à partir du 
réseau distant NET_IN_B à destination du réseau local Network_in. La directive 
via Tunnel VPN IPsec a été ajoutée à la source de cette règle pour s’assurer que le 
trafic du réseau distant provient bien du tunnel VPN IPsec. 
NOTE : ces règles sont très permissives puisqu’elles ne spécifient pas de flux 
particuliers ; en situation réelle, il convient de définir une politique de filtrage qui 
décrit strictement les flux à autoriser afin de couvrir rigoureusement les 
communications nécessaires entre les différentes machines des deux sites. 


436 


Virtual Private Network 

22 
•Logs de la négociation IKE 
VPN IPSEC -CONFIGURATIOND’UNTUNNELSITE-À-SITE 
Le menu TRACES ⇒ 
VPN affiche les évènements relatifs au déroulement de la 
négociation IKE. Les extrémités de trafic qui ont provoqué les négociations et pour 
lesquelles le tunnel est disponible apparaissent explicitement sur la ligne de log 
concernant la négociation de phase 2. 

Dans le cadre d’un diagnostic, en particulier en cas de message d’erreur ou 
d’avertissement, il est essentiel de relever la phase de négociation pour laquelle les 
messages sont rapportés. 

Les colonnes affichées ci-dessus ont volontairement été limitées au minimum 
nécessaire à l’exemple. Apparaissent notamment les colonnes SPI in et SPI out. Les 
SPI (Security Parameter Index) sont des valeurs sur 32 bits en forme hexadécimale 
permettant d’identifier les SA IPsec entrantes (in) et sortantes (out). Sur le 
correspondant, ces valeurs sont donc les mêmes mais sont inversées (la valeur de 
SPI in correspond à celle de SPI out et inversement). 

Davantage d’informations, plus techniques, peuvent être affichées en cliquant sur la 
flèche qui se trouve dans l’en-tête de colonnes, puis sélectionnant les colonnes 
supplémentaires souhaitées. 


437 


Virtual Private Network 

23 
•La politique VPN IPSEC 
VPN IPSEC -CONFIGURATION D’UN TUNNEL SITE-À-SITE 
Le menu Supervision ⇒ 
Tunnels VPN IPsec permet de visualiser la politique VPN 
IPsec active sur le firewall. 


438 


Virtual Private Network 

24 
•Superviser les tunnels VPN IPsec ouverts depuis GUI 
VPN IPSEC -CONFIGURATIOND’UNTUNNELSITE-À-SITE 
La section Tunnels permet, de superviser les tunnels disponibles. L’âge 
actuel des SA 
et les algorithmes retenus lors des négociations apparaissent. 


439 


Virtual Private Network 

• 
VPN IPsec – 
Configuration de tunnels site-àsite 
multiples 
➔
• 
Les différents réseaux privés virtuels 
• 
VPN IPsec – 
Concepts et généralités 
• 
VPN IPsec – 
Configuration de tunnel site-à-site 
• 
VPN IPsec – 
Virtual Tunneling Interface 
• 
Lab -VPN IPsec (site à site) 
Virtual Private Network 


440 


DMZ1_A 
IN_A 
DMZ1_B 
IN_B 
OUT_A OUT_B 
DMZ1_A 
IN_A 
DMZ1_B 
IN_B 
OUT_A OUT_B 
NET_IN_A 

NET_IN_B 


Virtual Private Network 


VPN IPSEC -CONFIGURATION DE TUNNELS SITE-À-SITE MULTIPLES 

NET_DMZ1_A 
NET_DMZ1_B 
26 

L’objectif 
est de configurer une politique VPN IPsec pour autoriser la communication 
entre les réseaux locaux IN et DMZ1 des deux sites. Cette configuration peut se faire 
suivant deux méthodes : 

1. Une règle par paire de réseaux à relier. 
2. Une seule règle pour tous les réseaux en utilisant les groupes. 
441 


Virtual Private Network 

27 
VPN IPSEC -CONFIGURATION DE TUNNELS SITE-À-SITE MULTIPLES 
Selon la méthode choisie, le nombre de tunnels pourra être différent en IKEv1 et 
IKEv2. 

Pour mettre ce point en évidence, il faut faire apparaître les colonnes SPI in et out 
dans les logs VPN. 


442 


Virtual Private Network 

28 
1. Une règle par paire de réseaux à relier 
VPN IPSEC -CONFIGURATION DE TUNNELS SITE-À-SITE MULTIPLES 
La première méthode consiste à éditer une règle par paire de réseaux à relier. 


443 


Virtual Private Network 

29 
Nombre de tunnels identique pour IKEv1 : 
et IKEv2 (les SPI sont différents) : 
VPN IPSEC -CONFIGURATION DE TUNNELS SITE-À-SITE MULTIPLES 
Dans ce cas, la politique chargée sera identique quelle que soit la version du 
protocole IKE utilisée, et elle engendrera quatre tunnels distincts, c’est-à-dire quatre 
paires d’IPsec-SA, reconnaissables par les 4 paires de SPI. 


444 


Virtual Private Network 

VPN IPSEC -CONFIGURATION DE TUNNELS SITE-À-SITE MULTIPLES 

2. Une règle pour tous les réseaux en utilisant des 
groupes 
30 

La deuxième méthode consiste à n’éditer qu’une seule règle pour l’ensemble des 
réseaux regroupés dans un groupe. Cette configuration est plus concise et donc plus 
lisible à condition d’adopter, pour le nommage des groupes, une nomenclature 
rigoureuse et suffisamment descriptive afin d’éviter toute ambiguïté et tout risque 
de confusion lors d’une relecture ultérieure. 


445 


Virtual Private Network 

31 
Différents tunnels pour IKEv1 (les SPI sont différents) : 
Même tunnel pour IKEv2 (les SPI sont identiques) : 
VPN IPSEC -CONFIGURATION DE TUNNELS SITE-À-SITE MULTIPLES 
Elle engendre un nombre de tunnels différent selon la version du protocole IKE : 

• 
IKEv1 : Quatre tunnels, ce qui est identique à la première configuration. 
• 
IKEv2 : Un tunnel unique, qui servira à faire transiter l’ense􀅵ble 
des 
communications entre ces différents réseaux. Ce comportement est parfois 
qualifié de « SharedSA ». 
ATTENTION : il sera ainsi impératif d’har􀅵oniser 
la méthode de configuration des 
politiques pour les tunnels négociés en IKEv2 entre firewalls SNS. 


446 


Virtual Private Network 

• 
VPN IPsec – 
Virtual Tunneling Interface 
➔
• 
Les différents réseaux privés virtuels 
• 
VPN IPsec – 
Concepts et généralités 
• 
VPN IPsec – 
Configuration de tunnel site-à-site 
• 
VPN IPsec – 
Configuration de tunnels site-à-site 
multiples 
• 
Lab -VPN IPsec (site à site) 
Virtual Private Network 


447 


Virtual Private Network 

33 
VPN IPSEC-VIRTUAL TUNNELING INTERFACE 
Routes sur A 
NET_IN_B ⇨IP_VTI_B 
NET_DMZ1_B ⇨IP_VTI_B 
NET_DMZ2_B ⇨IP_VTI_B 
VPN IPSEC 
DMZ1_A 
DMZ2_A 
IN_A 
VTI_A VTI-BOUT_A OUT_B 
Routes sur B 
NET_IN_A ⇨IP_VTI_A 
NET_DMZ1_A ⇨IP_VTI_A 
NET_DMZ2_A ⇨IP_VTI_A 
IP_VTI_A : x.y.z.1/30 IP_VTI_B : x.y.z.2/30 
NET_IN_A NET_DMZ1_A 
NET_DMZ2_A 
DMZ1_B 
DMZ2_B 
IN_B 
NET_IN_B NET_DMZ1_B 
NET_DMZ2_B 
Une autre approche est rendue possible par l’utilisation 
d’interfaces 
VTI dédiées à 
un tunnel IPsec. 

Ces interfaces IPsec particulières constitueront les points de passage des flux en 
entrée et en sortie de tunnel IPsec. Elles agiront comme une passerelle l’une 
envers 
l’autre 
pour acheminer les flux entre les réseaux au travers du tunnel IPsec. 

Les avantages de cette approche résident dans : 

• 
L’indépendance 
de la politique IPsec vis-à-vis des adresses IP des usagers du 
tunnel et des flux à prendre en charge. 
• 
La souplesse et la précision dans la sélection des flux à envoyer dans le tunnel. 
• 
La limitation à un seul tunnel (et donc à une seule négociation de phase 2) quel 
que soit le nombre de réseaux IP à relier entre eux. 
Les diapositives suivantes détaillent les étapes qui permettent de configurer un 
tunnel VPN IPsec site-à-site en utilisant les interfaces VTI. 

Priorité entre correspondance de politique et routage sur VTI : 

Le routage sur VTI est prioritaire sur la correspondance de politique. C’est-à-dire, si 
une politique VPN IPsec contient deux tunnels servant à relier les mêmes réseaux, 
un défini par la correspondance de politique et un deuxième utilisant le routage sur 
VTI, les paquets seront transmis via le deuxième tunnel. 


448 


Virtual Private Network 

VPN IPSEC-VIRTUAL TUNNELING INTERFACE 
• 
Comparatif 
Paramètre VPN par politique VPN par route (VTI) 
Maintient de la SA Tant que du trafic correspond 
à la politique 
Tant que les vti sont actives 
Compatibilité avec le routage 
dynamique 
Non Oui 
Compatibilité multi-éditeur Oui Non 
Cas d’usage•Répartition de charge avec 
objet routeur 
•Tolérance aux pannes par 
l’usage deroutage 
dynamique 
•Multiples extrémités de 
trafic 
34 


449 


Virtual Private Network 

VPN IPSEC-VIRTUAL TUNNELING INTERFACE 
• 
Création des interfaces VTI sur chacun des 
correspondants 
Création la VTI 
sur le 
correspondant A 


Création de la 

VTI sur le 

correspondant B 

35 


Les interfaces VTI créées sur les deux correspondants portent chacune un nom 
commun et une adresse IP du même plan d’adressage 
: 

• 
Sur le correspondant A : la VTI est nommée « VTI_A » et son IP est 
172.25.255.1/30. 
• 
Sur le correspondant B : la VTI est nommée « VTI_B » et son IP est 
172.25.255.2/30. 
Pour éviter toute ambiguïté avec l’architecture 
existante et ses futures évolutions, il 
convient de choisir un plan d’adressage 
dédié à l’usage 
des VTI, dans une plage 
officiellement privée et suffisamment originale pour ne pas entrer en collision avec 
un réseau déjà existant ou le réseau distant d’une 
interconnexion future. 

NOTE : Depuis la V3.3.0, il est possible d’utiliser 
un réseau en /31 qui convient mieux 
aux interfaces point-à-point car elles n’utilisent 
pas les adresses réseau et broadcast. 

Les noms communs de ces interfaces seront automatiquement associés à un objet 
machine implicite, sur chacun des correspondants : 

• 
Sur le correspondant A : Firewall_VTI_A. 
• 
Sur le correspondant B : Firewall_VTI_B. 
450 


Virtual Private Network 

VPN IPSEC-VIRTUAL TUNNELING INTERFACE 
• 
Création 
de l’objet machine 
qui porte 
l’adresse 
IP 
de 
l’interface 
VTI du correspondant distant 
Sur A, création de 
l’objet 
machine qui porte 
l’adresse IP 
de 
l’interface VTI_B 


Sur B, création de 
l’objet 
machine qui porte 
l’adresse IP 
de 
l’interface VTI_A 



36 

Sur chacun des firewalls, il faut également créer l’objet 
portant l’adresse 
IP de la VTI 
du correspondant distant. 

Comme pour tous les objets, il est judicieux de définir une nomenclature rigoureuse 
en utilisant des noms évocateurs. Cette bonne pratique facilite l’utilisation 
des VTI 
sur des architectures VPN IPsec aux correspondants multiples. 


451 


Virtual Private Network 

37 
•Définition de la politique VPN IPsec basée sur les VTI 
•Sur le correspondant A 
•Sur le correspondant B 
VPN IPSEC-VIRTUAL TUNNELING INTERFACE 
Les objets correspondants aux adresses IP des VTI sont définies comme extrémités 
de trafic du tunnel. Au contraire des configurations IPsec basées sur la 
correspondance de politique, ce ne sont pas exclusivement les flux de 
communication entre les deux adresses IP des interfaces VTI qui sont pris en charge 
par IPsec, mais tout flux qui passe par ces interfaces grâce aux directives de routage. 


452 


Virtual Private Network 

38 
•Définition des routes pour les flux usagers du tunnel 
routes statiques 
•Sur le correspondant A 
•Sur le correspondant B 
VPN IPSEC-VIRTUAL TUNNELING INTERFACE 
Dans ce mode de fonctionnement, il est essentiel de veiller à ce que le routage des 
paquets retour coïncide avec le tunnel emprunté par les paquets aller. 
Ci-dessous, les routes statiques indiquent globalement sur chaque correspondant 
que les réseaux distants sont joignables par le même tunnel. 


453 


Virtual Private Network 

39 
•Définition des routes pour les flux usagers du tunnel 
Routage par politique 
•Une règle de filtrage avec PBR désigne comme passerelle la 
VTI du correspondant distant : 
•La définition de la route de retour est impérative 
VPN IPSEC-VIRTUAL TUNNELING INTERFACE 
L’usage 
de directives de routage par politique (PBR), impose également de gérer le 
routage des paquets retour par le même tunnel. 
C’est 
pourquoi, il est nécessaire de définir la route retour par la VTI correspondant 
au tunnel par lequel les paquets aller sont arrivés. 

Ces directives doivent être appliquées sur les deux correspondants si les 
communications dans le tunnel peuvent être initiées indifféremment par des 
réseaux côté A vers des réseaux côté B et inversement. 


454 


Virtual Private Network 

40 
•Autorisation du trafic entre les deux réseaux distants 
VPN IPSEC-VIRTUAL TUNNELING INTERFACE 
Avec les interfaces VTI, la directive via Tunnel VPN IPsec ne doit pas être utilisée. À 
sa place, il faut utiliser l’interface 
VTI comme interface d’entrée 
dans la règle 
autorisant le trafic entrant depuis le tunnel. 


455 


Virtual Private Network 

RECOMMANDATIONS 
• 
Utiliser des algorithmes robustes pour IKE et IPsec 
• 
Utiliser IKEv2 

↓ 
A défaut utiliser le mode MAIN de IKEv1 
• 
Utiliser des authentifications par certificat 
↓ 
A défaut utiliser des PSK robustes 
• 
Configurer KeepAlive 
• 
Désactiver PPTP 
41 

Il est fortement déconseillé d’e􀅵ployer 
la fonction de hachage MD5, le chiffrement 
DES, des clés RSA de taille inférieure à 2048 bits ou des clés ECDSA de taille 
inférieure à 200bits. 
Il est déconseillé d’utiliser 
3DES, SHA-1 ou ECDSA avec des clés de moins de 256 bits 
si des alternatives plus sécurisées telles 􀆋u’AES, 
SHA-2 ou ECDSA avec des clés d’au 
moins 256 bits sont disponibles. 
Attention au groupe de Diffie-Hellman employé. On privilégiera les groupes de 
modules de taille importante (comme 14 et 15) voire les groupes construits sur des 
courbes elliptiques d’au 
moins 256bits. 

Pour éviter de perdre des paquets parce 􀆋u’un 
tunnel n’est 
pas encore établi, il est 
recommandé d’activer 
Keepalive qui maintiendra le tunnel monté. 

PPTP est un protocole largement obsolète et ne doit plus être utilisé. 


456 


Virtual Private Network 

42 
Pour aller plus loin, consultez les ressources du site documentation.stormshield.eu : 

• 
Interfaces virtuelles IPsec 
• 
Intégration du NAT dans IPsec 
• 
VPN IPsec Mobile IKEv1 -Authentification par clé pré-partagée 
• 
VPN IPsec Mobile IKEv2 -Authentification par clé pré-partagée 
• 
VPN IPsec -Authentification par clé pré-partagée 
• 
VPN IPsec : Authentification par certificats 
• 
VPN IPsec : Configuration Hub and Spoke 
• 
VPN IPsec -Mode Diffusion Restreinte 
• 
Guide d'utilisation SN VPN Client Standard 
• 
Guide de l'administrateur SN VPN Client Exclusive 
Et pour les situations/questions très spécifiques, consultez la base de connaissance 
du TAC kb.stormshield.eu. 


VPN SSL 

3 
•Les firewalls Stormshield intègrent deux types 
de VPN SSL 
•VPN SSL portail : 
–Accès aux serveurs Web HTTP et serveurs applicatifs via le 
portail captif après authentification 
•VPN SSL (complet) : 
–Utilise un client VPN SSL (gratuit) 
–Accès au réseau interne d’une manière transparente 
CONCEPTS ET GÉNÉRALITÉS 
Note : 

• 
Les deux modes VPN SSL (portail et complet) peuvent fonctionner simultanément. 
• 
Le VPN SSL portail n’est 
pas abordé dans le cadre de cette formation. Toutes les 
références à « VPN SSL » dans le reste de ce document se rapportent 
exclusivement au VPN SSL en mode complet. 
480 


VPN SSL 

4 
CONCEPTS ET GÉNÉRALITÉS 
TCP/UDP 
IP 
TCP/UDP 
TCP/UDP 
IP 
TCP/UDP 
IP 
Serveur OPENVPN 
TCP/UDP 
Ressources 
accessibles 
Utilisateurs 
nomades 
Session TLS 
à l’exception de quelques-uns 
N’importe quel portTCP/UDPIP 
TLS 
IP 
TLS 
Le VPN SSL permet à des utilisateurs distants d’accéder 
de manière sécurisée aux 
ressources internes d’une 
entreprise. Les communications entre l’utilisateur 
distant 
et le firewall sont encapsulées et protégées via un tunnel TLS chiffré. 

Au niveau du firewall, les tunnels VPN SSL sont gérés par le serveur OpenVPN 
(logiciel libre) qui est intégré dans le firmware en tant que nouveau service. 
OpenVPN peut fonctionner sur n’i􀅵porte 
quel port TCP et/ou UDP, à l’exception 
de 
quelques-uns, qui sont utilisés pour les processus internes du firewall : 

• 
smux_tcp : TCP/199 
• 
ldap : TCP/389, ldaps TCP/636 
• 
firewall_srv : 1300/TCP 
• 
pptp : TCP/1723 
• 
sld (démon d’authentification) 
: TCP/4444 
• 
http_proxy : 8080/TCP 
• 
smtp_proxy : 8081/TCP 
• 
pop3_proxy:8082/TCP 
• 
ftp_proxy : 8083/TCP 
• 
ssl_proxy : 8084/TCP 
• 
loopback_proxyssl : 8085/TCP 
En ce qui concerne les utilisateurs nomades, le tunnel est géré par le client VPN SSL 
(Stormshield ou OpenVPN standard), qui doit être installé sur les machines. Une fois 
le tunnel mis en oeuvre, 
l'hôte distant récupère une adresse IP fournie par le serveur 
VPN SSL. Elle sera considérée comme faisant partie des réseaux internes (protégés) 
du firewall et l’utilisateur 
sera vu comme authentifié. 

481 



VPN SSL 

NOMBRE DE TUNNELS VPN SSL 
• 
Le nombre de tunnels VPN maximum dépend du modèle 
d’UTM: 
UTM SN160(W) 
SN160W 
SN210(W) 
SN310 
SN510 SN710 
SN910 
SN2100 SN3100 
SN6100 
SNi20 
SNi40 
Nombre 

d’utilisate 


5 

20 

100 

150 

400 

500 

100 
urs 

• 
Limites des appliances virtuelles: 
V UTM EVA1 EVA2 EVA3 EVA4 EVAU 
Nombre 

100 

150 

200 

250 

500

d’utilisateurs 



5 


482 


VPN SSL 

CLIENTS VPN SSL 
• 
Pour monter le tunnel, le client peut utiliser : 
• 
L’application standard OpenVPN 
• 
PC : Windows, macOS ou GNU/Linux 
• 
Mobile : Android, iOS 
• 
Le client SSL VPN Stormshield 
• 
PC : Windows 
6 

Clients VPN SSL compatibles : 

• 
Le client VPN SSL Stormshield Network (basé sur le client OpenVPN) peut être 
lancé en toute transparence depuis un poste utilisateur Windows avec les droits 
d’utilisateur 
(toutefois, son utilisation nécessite des droits administrateur). Ce 
client est disponible en téléchargement libre depuis votre espace privé 
mystormshield.eu et depuis le portail captif du firewall après authentification. 
• 
Un client OpenVPN standard doit être lancé avec les droits d’ad􀅵inistration 
du 
poste client. 
• 
Les terminaux de type smartphones et tablettes (Android ou iOS) peuvent 
également se connecter via un VPN SSL avec un client OpenVPN Connect 
(disponible dans le Google Play Store et l'Apple Store). 
483 


VPN SSL 

CLIENTS VPN SSL 
• 
Le réseau VPN SSL (TCP ou UDP) défini sur le serveur est 
considéré comme un réseau interne ⇒Il ne doit pas 
chevaucher un réseau interne existant 
• 
Le réseau VPN SSL est découpé en sous-réseaux de /30 : 
• 
Le premier et le dernier sont utilisés par le serveur 
• 
Un sous-réseau est utilisé pour chaque client 
• 
Exemple : 192.168.100.0/24 ⇒62 clients maximum 
• 
Serveur [192.168.100.0| .1 | .2 | .3] /30 
• 
Client 1 [192.168.100.4| .5 | .6 | .7] /30 
• 
Client 2 [192.168.100.8| .9| .10| .11] /30 
•… 
•… 
• 
Serveur [192.168.100.252| .253| .254| .255] /30 
7 

Les clients VPN SSL font partie d’un 
même réseau UDP, ou TCP, défini au niveau du 
firewall. Ce réseau est considéré comme un réseau interne (protégé): il ne doit donc 
pas recouvrir un réseau interne existant. 

Pour son fonctionnement interne, le serveur se réserve le premier sous-réseau de 
/30 issu du réseau VPN SSL (une interface « tun0 » est créée et porte la première 
adresse IP du réseau TCP, l’interface 
est tun1 pour le réseau UDP, ces interfaces ne 
sont visibles 􀆋u’en 
ligne de commande), ainsi que le dernier réseau de la plage. Les 
autres sous-réseaux de /30 sont utilisés par les clients. 

Par exemple, si le service SSL/ VPN utilise le réseau 192.168.100.0/24 pour les clients 
UDP, le premier client VPN SSL UDP utilise le deuxième sous-réseau /30 : 

• 
Adresse réseau : 192.168.100.4 
• 
Adresse de l’interface 
du tunnel côté serveur : 192.168.100.5 
• 
Adresse de l’interface 
du tunnel côté client : 192.168.100.6 
• 
Adresse de diffusion : 192.168.100.7 
Ainsi, le nombre maximum de clients VPN SSL UDP sur ce réseau est de 62 (64 sous-
réseaux de /30, dont deux utilisés par le serveur). 

Le calcul reste le même pour le réseau VPN SSL TCP. 
Ce comportement est défini explicitement dans OpenVPN. 


484 


VPN SSL 

ÉTABLISSEMENTD’UNTUNNELVPN SSL
La mise en oeuvre 
du tunnel VPN SSL s’effectue 
en trois étapes principales : 

1. Le client VPN SSL STORMSHIELD authentifie l’utilisateur 
par une connexion 
préalable et transparente au portail captif. Durant cette étape, le firewall vérifie 
si l’utilisateur 
authentifié possède les droits lui permettant d’ouvrir 
un tunnel 
VPN SSL. 
2. Si l’authentification 
réussit, le client envoie une requête pour récupérer les 
fichiers de configuration renvoyés par le firewall dans un dossier compressé 
« openvpn_client.zip ». Le dossier contient les fichiers suivants : 
• 
Le certificat de l’autorité 
de certification (CA.cert.pem), 
• 
Le certificat du client et sa clé privée (openvpnclient.cert.pem et 
openvpnclient.pkey.pem), 
• 
La configuration du client OpenVPN. 
3. Le client lance le processus de mise en oeuvre 
du tunnel TLS avec authentification 
par certificat à l'aide des certificats récupérés lors de l’étape 
précédente. Avant la 
mise en oeuvre 
du tunnel, le firewall vérifie que le nombre maximal d’utilisateurs 
n’est 
pas encore atteint et 􀆋u’un 
sous réseau peut être réservé pour ce nouveau 
client. Si toutes les conditions sont vérifiées, le tunnel est mis en oeuvre 
et 
l’utilisateur 
est considéré comme authentifié. 
NOTE : Si le serveur VPN SSL est accessible via un port UDP ou TCP, le client VPN SSL 
tente d'abord de mettre en oeuvre 
le tunnel avec le protocole UDP et en cas d'échec, 
il effectue automatiquement une nouvelle tentative avec le protocole TCP. 

485 

Authentification de 
l’utilisateur 

sur le portail captif 
Demande des fichiers de configuration 

1 
2 
Openvpn_client.zip 
Openvpn_client.zip 


• 
CA.cert.pem 
• 
Openvpnclient.cert.pem 
• 
Openvpnclient.pkey.pem 
• 
Openvpnclient.ovpn 
Authentification et 

établissement du tunnel TLS 

3 
• 
Contrôle des droits VPN de 
l’utilisateur 
• 
Contrôle du nombre max 
d’utilisateurs 
possible 


• 
Contrôle 
du pool 
d’adresses 
IP 
• 
Création du tunnel 
• 
L’utilisateur est authentifié 
au 
niveau du firewall 

8 


VPN SSL 

•Concepts et généralités 
•Configurationd’un tunnel•Lab –VPN SSL 
VPN SSL 
➔
486 


VPN SSL 

EXIGENCES : ANNUAIRE, PORTAIL CAPTIF ET AUTHENTIFICATION 
• 
Un annuaire interne ou externe doit être configuré 
• 
Un profil du portail captif doit être rattaché à l’interface depuis 
laquelle les utilisateurs se connectent 
• 
Une méthode 
d’authentification 
doit être configurée 


10 

La première étape de mise en oeuvre 
d’un 
tunnel VPN SSL est l’authentification 
de 
l’utilisateur 
via le portail captif, ce qui signifie que : 

• 
Un annuaire externe ou interne doit être configuré au niveau du firewall, 
• 
Un profil du portail captif doit être rattaché à l’interface 
depuis laquelle les 
utilisateurs se connectent, 
• 
Une méthode d’authentification 
doit être configurée. 
Les méthodes d’authentification 
possibles pour le service VPN SSL sont les méthodes 
explicites qui nécessitent un couple identifiant/mot de passe, en l’occurrence 
LDAP 
(interne, externe ou Microsoft Active Directory), Kerberos et Radius. 


487 


VPN SSL 

11 
•PKI fournissant les certificats pour le serveur OpenVPN 
et les clients OpenVPN (le même certificat sera affecté à 
tous les clients OpenVPN) : 
EXIGENCES : L’AUTORITÉ DE CERTIFICATIONVPN SSL
Des certificats seront utilisés pour l’authentification 
entre le client et le serveur VPN 
SSL. Pour cela, une autorité de certification racine (CA) existe dans la configuration 
usine de tous les firewalls Stormshield Network. Cette CA est nommée sslvpn-fulldefault-
authority, et elle contient un certificat serveur (qui identifie le serveur VPN 
SSL), et un certificat client (qui identifie tous les clients; chacun d’entre 
eux sera 
ensuite différencié par un couple login/mot de passe). 

NOTE : Il est naturellement possible de créer une CA dédiée au VPN SSL sans recourir 
à la CA par défaut. La création des CA est présentée dans le niveau expert. 


488 


VPN SSL 

12 
DROITS D’ACCÈS VPN SSLParamétrage par défaut 
Paramètres 
personnalisés 
Pour autoriser un utilisateur à mettre en oeuvre 
un tunnel VPN SSL, vos devez lui 
attribuer les droits correspondants dans le menu Configuration ⇒ 
Utilisateurs ⇒ 
Droits d’accès. 

Il est possible de choisir un accès par défaut indépendamment de l’utilisateur 
connecté dans l’onglet 
Accès détaillé ⇒ 
encadré SSL VPN . Sélectionnez Autoriser 
dans le champ Politique VPN SSL par défaut 

Cependant, une gestion plus fine des droits d’accès 
est préconisée en laissant la 
politique VPN SSL par défaut à Bloquer et en ajoutant les utilisateurs ou les groupes 
d’utilisateurs 
dans l’onglet 
ACCÈS DÉTAILLÉ ⇒ 
AJOUTER avec les droits VPN SSL à 
Autoriser. 


489 


VPN SSL 

13 
RÈGLES DE FILTRAGE IMPLICITES POUR LE VPN SSL 
Pour permettre aux clients VPN SSL d’accéder 
au portail d’authentification 
sur les 
interfaces associées aux profils d’authentification 
du firewall, la règle de filtrage 
implicite nommée Autoriser l’accès 
au portail d’authentification 
et au VPN SSL pour 
les interfaces associées aux profils d’authentification 
(Authd)doit être activée. 

Si tel n’est 
pas le cas, il est impératif d’ajouter 
des règles de filtrage explicites dans la 
politique active autorisant les flux à destination de l’interface 
publique sur le port 
d’écoute 
du service, par défaut : 

• 
Port 443 en VPN SSL TCP, 
• 
Port 1194 en VPN SSL UDP. 
490 


VPN SSL 

14 
CONFIGURATION DU SERVICE VPN SSL 
Le service VPN SSL peut être configuré dans Configuration ⇒VPN ⇒SSL VPN. 

• 
Encadré Paramètres réseaux : 
• 
Adresse IP (ou FQDN) de l’UTM 
utilisée : Il s’agit 
de l’adresse 
sur laquelle 
vont se connecter les clients VPN SSL (adresse publique la plupart du 
temps). Attention, la saisie d’un 
FQDN induit une résolution de noms via 
un service DNS, 
• 
Réseaux ou hôtes disponibles : Machines ou réseaux auxquels les 
utilisateurs peuvent avoir accès une fois le tunnel mis en oeuvre 
(l’accès 
dépend néanmoins de la politique de filtrage active). Il est possible de 
choisir l’objet 
Any. Dans ce cas, tous les flux du client VPN passent par le 
tunnel et sont soumis aux opérations de filtrage et de NAT du firewall. 
• 
Réseau assigné aux clients (UDP) : Réseau attribué aux clients nomades 
une fois le tunnel mis en oeuvre 
via le protocole UDP. La valeur minimale 
pouvant être choisie ici est un réseau de /28. 
• 
Réseau assigné aux clients (TCP) : Réseau attribué aux clients nomades 
une fois le tunnel mis en oeuvre 
via le protocole TCP. La valeur minimale 
pouvant être choisie ici est un réseau de /28. 
• 
Maximum de tunnels simultanés autorisés : Paramètre non configurable 
dans l’IHM. Il indique le nombre maximal de tunnels (clients) autorisés, 
c'est-à-dire le minimum entre le nombre de tunnels autorisés pour le 
modèle du firewall et le nombre de tunnels possibles calculé à partir du 
réseau assigné aux clients. 
NOTE : les réseaux assignés aux client UDP et TCP doivent être différents. 

491 


VPN SSL 

15 
CONFIGURATION DU SERVICE VPN SSL 
Comme vu précédemment, ce réseau est découpé en sous-réseaux de 
masque /30, dont 2 sont utilisés par le serveur pour son fonctionnement 
interne, les autres étant utilisés par les clients. Ainsi, un réseau /24 permet 
un maximum de 62 tunnels. 

• 
Encadré Paramètres DNS envoyés au client : 
• 
Nom de domaine : Il s’agit 
en général du domaine dont dépendent les 
réseaux accessibles par le client (Windows uniquement). 
• 
Serveur DNS primaire (et secondaire) : Interne à l’entreprise 
si le client 
doit pouvoir accéder à des ressources locales. Sinon, le choix d’un 
serveur 
public est autorisé. 
• 
Encadré Configuration avancée : 
• 
Adresse IP de l’UTM 
pour le VPN SSL (UDP ) : Il s’agit 
de l’adresse 
à 
laquelle vont se connecter les clients du VPN SSL s'ils sont configurés pour 
utiliser l’UDP 
(adresse publique la plupart du temps). 
• 
Port (UDP) : Port d’écoute 
UDP du service VPN SSL (1194 par défaut). 
• 
Port (TCP) : Port d’écoute 
TCP du service VPN SSL (443 par défaut). 
NOTE : Attention : certains ports sont réservés à un usage interne et ne 
peuvent être sélectionnés. Ces ports sont smtp_proxy : 8081/TCP, 
ftp_proxy : 8083/TCP, pop3_proxy : 8082/TCP, ssl_proxy : 8084/TCP, 
http_proxy : 8080/TCP, loopback_proxyssl : 8085/TCP, firewall_srv : 
1300/TCP, ldap : TCP/389, ldaps TCP/636, pptp : TCP/1723, TCP/4444, 
TCP/8087, smux_tcp : TCP/199, isakmp : UDP/500, isakmp_nat : 
UDP/4500, bootps : UDP/67, bootpc : UDP/68. 

492 



VPN SSL 

• 
Intervalle avant renégociation clé (en secondes) : Période avant 􀆋u’une 
nouvelle session TLS ne soit renégociée. 
• 
Utiliser les serveurs DNS fournis par le firewall : Lorsque cette option est 
choisie, le client VPN SSL ajoutera les serveurs DNS qui ont été récupérés 
via le tunnel VPN SSL à la configuration réseau du poste de travail du 
client. 
• 
Interdire l’utilisation 
des serveurs DNS tiers : Lorsque cette option est 
choisie, le poste de travail du client utilisera uniquement les serveurs DNS 
qui ont été récupérés via le tunnel VPN SSL. 
• 
Encadré Script à exécuter sur le client : Permet de définir les scripts à exécuter 
lorsque le client se connecte et se déconnecte. Des exemples de scripts sont 
fournis de façon détaillée dans le document snentno_SSL_VPN_Tunnel.pdf 
accessible via https://mystormshield.eu. 
• 
Encadré Certificats utilisés : Personnalise les certificats utilisés. Rappel : le 
certificat serveur permet d’identifier 
le serveur VPN SSL alors que le certificat 
utilisateur permet d’identifier 
les clients VPN SSL (chaque client sera ensuite 
identifié par son login). Si ces certificats sont modifiés, s’assurer 
􀆋u’ils 
ont bien été 
émis par la même autorité de certification. Sinon, la configuration ne sera pas 
appliquée. 
• 
Encadré Configuration : Le fichier de configuration peut être téléchargé au format 
OpenVPN. 
493 


VPN SSL 

FILTRAGE ET NAT 
• 
Il est nécessaire de définir des règles de filtrage explicites pour la 
gestion du trafic provenant des tunnels : 
• 
Une translation d’adresses peut être mise en oeuvre si des clients 
doivent utiliser le VPN SSL pour accéder à Internet : 

17 
La règle de filtrage n°1 permet l’initiation de connexions à partir des clients VPN SSL 
et à destination des serveurs Web internes, 
La règle de filtrage n°2 permet l’initiation de connexions à partir des clients VPN SSL 
et à destination d’Internet 
; dans ce cas, une règle de NAT doit également être 
ajoutée. 


494 


VPN SSL 

18 
PARAMÉTRAGE DU CLIENT VPN SSL STORMSHIELD 
L’application 
VPN SSL Stormshield Network peut être téléchargée sur votre espace 
privé https://mystormshield.eu et sur le portail captif du firewall après 
authentification. 

NOTE : différents packages sont disponibles pour les versions Microsoft Windows 7 
et 10 et le client VPN SSL v3.0.1 ou au-delà doit être utilisé avec les firewalls SNS 
dans la version 4.3. 

Une fois démarré, le client VPN SSL nécessite trois paramètres : 

• 
L’adresse 
IP ou le FQDN du firewall à contacter, 
• 
L’identifiant 
de l’utilisateur 
disposant des droits pour le VPN SSL, 
• 
Le mot de passe de l’utilisateur. 
Une fenêtre indique que la connexion à ce site n’est 
pas sécurisée car le client ne fait 
pas confiance à la CA signataire du certificat serveur présenté par le portail captif du 
firewall. Il est donc possible : 

• 
D’afficher 
le certificat pour savoir quelle CA l’a 
signé, 
• 
De faire confiance à ce certificat, ce qui signifie que la CA est ajoutée aux 
autorités de confiance et 􀆋u’il 
est possible de continuer avec la configuration 
du tunnel, 
• 
D’annuler 
la connexion, ce qui arrêtera la configuration du tunnel. 
En cas d’échec 
de la configuration du tunnel, faire un clic droit sur l’icône 
VPN SSL 
Stormshield Network pour afficher les traces. 

Lorsque le tunnel est monté, le poste client disposera d’une 
interface spécifique au 
tunnel VPN SSL dont l’adresse 
IP fait partie de l’objet 
Réseau assigné au client de la 
configuration serveur. 

495 


VPN SSL 

19 
CARNETD’ADRESSES DUCLIENTVPN SSLSTORMSHIELD
Le client VPN SSL Stormshield possède une fonction de carnet d’adresses, 
qui peut 
aider à sauvegarder différents profils VPN dans un seul fichier chiffré. Le mot de 
passe utilisé pour protéger le fichier est spécifique. 

Pour ajouter une entrée au carnet d’adresses, 
il suffit de cliquer sur le bouton 
« Ajouter » et de renseigner les détails, puis de cliquer sur « OK » pour la 
sauvegarder. 
Il est également possible d’i􀅵porter/exporter 
des entrées. 
Le carnet 
d’adresses se trouve à l’e􀅵place􀅵ent 
suivant 
: 
%USERPROFILE%\AppData\Local\Stormshield\Stormshield SSL VPN Client\AddrBook.gap 


496 


VPN SSL 

PARAMÉTRAGE DU CLIENT VPN SSL STORMSHIELD 
Déconnecté 
En cours de connexion 
Connecté 


20 
L’icône 
du client VPN SSL Stormshield qui apparaît dans la zone de notification de la 
barre de tâches de Windows possède un code couleur qui correspond à son état : 

• 
Rouge : Le client est déconnecté, 
• 
Jaune : Le client essaye de mettre en oeuvre 
le tunnel, 
• 
Bleu : Le client est connecté, 
Lorsque le client est connecté, des informations sur la connexion apparaissent 
lorsque le curseur de la souris est positionné sur l’icône. 


497 


VPN SSL 

21 
TUNNELS VPN SSL DANS LA GUI 
La page de supervision du firewall permet de visualiser les tunnels VPN SSL ouverts 
dans l’onglet 
Supervision => tunnels VPN SSL . Il est également possible de 
supprimer un tunnel en effectuant un clic droit sur Déconnecter cet utilisateur. 

Les utilisateurs connectés via un tunnel VPN SSL sont considérés comme authentifiés 
et peuvent être visualisés depuis le menu Utilisateurs. La colonne Méthode d’auth. 
indique que le client VPN est authentifié via un tunnel VPN SSL. 
